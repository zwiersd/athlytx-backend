<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TL5XD333');</script>
    <!-- End Google Tag Manager -->

    <!-- Essential Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

    <!-- Primary Meta Tags -->
    <title>Track Athletic Performance & Power Zones | Athlytx</title>
    <meta name="title" content="Track Athletic Performance & Power Zones | Athlytx">
    <meta name="description" content="Track your athletic performance with real-time power zones, heart rate monitoring, and personalized training insights. Connect Strava, Garmin, Oura, and Whoop for data-driven results.">
    <meta name="author" content="Athlytx Team">
    <meta name="language" content="en">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://athlytx.com/">

    <!-- Robots -->
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://athlytx.com/">
    <meta property="og:title" content="Track Athletic Performance & Power Zones | Athlytx">
    <meta property="og:description" content="Real-time power zones, heart rate monitoring, and personalized training insights. Connect your fitness devices for data-driven athletic performance.">
    <meta property="og:image" content="https://athlytx.com/src/images/og-athlytx-dashboard.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Athlytx Dashboard showing power zones, heart rate data, and performance metrics">
    <meta property="og:site_name" content="Athlytx">
    <meta property="og:locale" content="en_US">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@athlytx">
    <meta name="twitter:creator" content="@athlytx">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Athlytx">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon-180x180.png">

    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="/manifest.json">

    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-TileImage" content="/icons/mstile-144x144.png">

    <!-- Structured Data (JSON-LD) - SoftwareApplication Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Athlytx",
      "applicationCategory": "HealthApplication",
      "operatingSystem": "Web",
      "description": "Athletic performance tracking platform connecting Strava, Garmin, Oura, and Whoop for comprehensive fitness analytics",
      "url": "https://athlytx.com",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.9",
        "ratingCount": "187"
      },
      "featureList": [
        "Real-time power zone tracking",
        "Heart rate monitoring",
        "Multi-device integration (Strava, Garmin, Oura, Whoop)",
        "AI-powered training insights",
        "Performance analytics",
        "Training readiness scoring"
      ]
    }
    </script>

    <!-- Organization Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Athlytx",
      "description": "Advanced fitness analytics platform for data-driven athletic performance",
      "url": "https://athlytx.com",
      "logo": "https://athlytx.com/src/images/AthlytxLogo.png",
      "sameAs": [
        "https://twitter.com/athlytx",
        "https://facebook.com/athlytx"
      ]
    }
    </script>

    <!-- FAQ Schema for AI Overview Optimization -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is Athlytx?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Athlytx is an advanced fitness analytics platform that integrates data from Strava, Garmin, Oura, and Whoop to provide real-time power zones, heart rate monitoring, and personalized training insights for athletes and coaches."
          }
        },
        {
          "@type": "Question",
          "name": "Which fitness devices does Athlytx support?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Athlytx integrates with Strava for activity tracking, Garmin Connect for comprehensive training metrics, Oura Ring for sleep and recovery data, and Whoop for strain and recovery insights. All device data syncs automatically to your unified dashboard."
          }
        },
        {
          "@type": "Question",
          "name": "What are power zones in athletic training?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Power zones are training intensity ranges based on your functional threshold power (FTP). They help athletes train at specific intensities for optimal performance gains. Athlytx tracks your power zones in real-time across all your cycling and running activities."
          }
        },
        {
          "@type": "Question",
          "name": "How does Athlytx help coaches manage athletes?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Athlytx Elite provides coaches with a professional dashboard to manage multiple athletes, track performance metrics, monitor training load, analyze power zones, and share insights. Coaches can invite athletes and view their real-time training data in one unified platform."
          }
        },
        {
          "@type": "Question",
          "name": "Is Athlytx free to use?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes, Athlytx offers a free plan for athletes to connect their fitness devices and track basic performance metrics. Premium features for advanced analytics and coach functionality are available with paid plans."
          }
        },
        {
          "@type": "Question",
          "name": "How does Athlytx calculate training readiness?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Athlytx calculates training readiness by analyzing multiple data points including heart rate variability (HRV) from Oura or Whoop, recovery metrics, sleep quality, training load, and recent activity strain. This creates a comprehensive readiness score to optimize your training."
          }
        }
      ]
    }
    </script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="/styles/design-tokens.css">
    <link rel="stylesheet" href="/styles/layout.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Connection badges - compact row inside header */
        .connection-badges {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(10,14,39,0.85);
            backdrop-filter: blur(12px);
            font-size: 9px;
            font-weight: 600;
            color: #e5e7eb;
            white-space: nowrap;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .connection-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .connection-badge img {
            height: 12px;
            width: auto;
            opacity: 0.9;
        }

        .connection-badge.badge-connected {
            background: rgba(34,197,94,0.12);
            border-color: rgba(34,197,94,0.35);
        }

        .connection-badge.badge-disconnected {
            background: rgba(148,163,184,0.06);
            border-color: rgba(148,163,184,0.2);
            opacity: 0.6;
        }

        .connection-badge-status {
            font-size: 8px;
            font-weight: 700;
            color: #10b981;
        }

        .connection-badge.badge-disconnected .connection-badge-status {
            color: rgba(255,255,255,0.4);
        }

        .header-container .connection-badges {
            justify-self: center;
        }

        @media (max-width: 1023px) {
            .connection-badge {
                padding: 3px 6px;
                font-size: 8px;
            }

            .connection-badge img {
                height: 10px;
            }

            .connection-badge-status {
                font-size: 7px;
            }
        }

        @media (max-width: 640px) {
            .connection-badges {
                display: none;
            }
        }

        /* Unified mobile drawer */
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; }
        .drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 80vw; max-width: 320px; background: rgba(10,14,39,0.96); border-left: 1px solid rgba(255,255,255,0.12); z-index: 1001; transform: translateX(100%); transition: transform 0.25s ease; padding: 16px; }
        .drawer.open { transform: translateX(0); }
        .drawer h3 { color: #fff; margin: 0 0 12px 0; font-size: 16px; }
        .drawer .item { display: flex; align-items: center; justify-content: space-between; padding: 10px 8px; border-radius: 8px; color: #e5e7eb; border: 1px solid rgba(255,255,255,0.12); margin-bottom: 8px; }
        .drawer .item button, .drawer .item a { font-size: 12px; padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); color: #e5e7eb; text-decoration: none; }

        /* Mobile tweaks: smaller, single row, hide descriptions */
        @media (max-width: 768px) {
            .header-container { display: grid; grid-template-columns: auto 1fr auto; align-items: center; padding: 8px 12px; }
            .header-logo { height: 28px; width: auto; }
            #headerMenu .nav-link, #headerMenu .elite-btn, #headerMenu .sync-btn, #headerMenu .refresh-btn, #headerMenu .refresh-btn + .refresh-btn { display: none !important; }
            #readinessPill { display: none; }
            .hamburger-btn { display: inline-flex; justify-self: end; background: transparent; border: none; padding: 6px; }
            .hamburger-line { display: block; width: 18px; height: 2px; background: #e5e7eb; margin: 3px 0; border-radius: 2px; }
            .header-center { display: flex; justify-content: center; }
            .mobile-refresh-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.24); color: #e5e7eb; padding: 6px 8px; border-radius: 999px; font-size: 12px; }
            .mobile-refresh-btn i { font-size: 14px; }
            .header-right { justify-self: end; }
            .footer-badges { left: 0; right: 0; bottom: 0; border-radius: 8px 8px 0 0; padding: 2px 3px; gap: 3px; justify-content: center; }
            .footer-badge { font-size: 8.5px; padding: 2px 4px; border-radius: 6px; gap: 2px; flex-direction: row; align-items: center; min-width: auto; }
            .footer-badge img { height: 9px; }
            .footer-badge .subtitle { display: none; }
            .footer-badge .status { display: none; }
            .footer-badge .actions { display: none; }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TL5XD333"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Fixed Header -->
    <!-- App Layout Container -->
    <div class="app-layout">

        <!-- Vertical Sidebar Navigation -->
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-content">
                <!-- Logo -->
                <div class="sidebar-logo">
                    <img src="https://www.athlytx.com/src/images/AthlytxLogo.png" alt="Athlytx Logo" class="sidebar-logo-img" crossorigin="anonymous">
                </div>

                <!-- Main Navigation -->
                <nav class="sidebar-nav" role="tablist" aria-label="Dashboard sections">
                    <button class="sidebar-link account-tab" role="tab" aria-selected="false" aria-controls="account" data-tab="account" id="accountTabButton" onclick="switchTab('account', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-user"></i></span>
                        <span class="sidebar-link-text" id="accountTabText">Account</span>
                    </button>
                    <button class="sidebar-link active" role="tab" aria-selected="true" aria-controls="connections" data-tab="connections" onclick="switchTab('connections', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-plug"></i></span>
                        <span class="sidebar-link-text">Connections</span>
                    </button>
                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="overview" data-tab="overview" onclick="switchTab('overview', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-chart-line"></i></span>
                        <span class="sidebar-link-text">Overview</span>
                    </button>

                    <!-- Provider Data Section -->
                    <div class="sidebar-section-title">Data Sources</div>

                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="garmin" data-tab="garmin" onclick="switchTab('garmin', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-running"></i></span>
                        <span class="sidebar-link-text">Garmin</span>
                    </button>
                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="strava" data-tab="strava" onclick="switchTab('strava', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-bicycle"></i></span>
                        <span class="sidebar-link-text">Strava</span>
                    </button>
                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="oura" data-tab="oura" onclick="switchTab('oura', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-ring"></i></span>
                        <span class="sidebar-link-text">Oura</span>
                    </button>
                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="whoop" data-tab="whoop" onclick="switchTab('whoop', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-heartbeat"></i></span>
                        <span class="sidebar-link-text">Whoop</span>
                    </button>

                    <!-- Analytics Section -->
                    <div class="sidebar-section-title">Analytics</div>

                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="running" data-tab="running" onclick="switchTab('running', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-shoe-prints"></i></span>
                        <span class="sidebar-link-text">Running</span>
                    </button>
                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="insights" data-tab="insights" onclick="switchTab('insights', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-brain"></i></span>
                        <span class="sidebar-link-text">AI Insights</span>
                    </button>

                    <!-- Support Section -->
                    <div class="sidebar-section-title">Support</div>

                    <button class="sidebar-link" role="tab" aria-selected="false" aria-controls="contact" data-tab="contact" onclick="switchTab('contact', this)">
                        <span class="sidebar-link-icon"><i class="fas fa-envelope"></i></span>
                        <span class="sidebar-link-text">Contact</span>
                    </button>
                </nav>

                <!-- Sidebar Footer Links -->
                <div class="sidebar-footer">
                    <a href="/about.html" class="sidebar-link sidebar-link-small">
                        <span class="sidebar-link-icon"><i class="fas fa-book"></i></span>
                        <span class="sidebar-link-text">About</span>
                    </a>
                    <a href="/privacy.html" class="sidebar-link sidebar-link-small">
                        <span class="sidebar-link-icon"><i class="fas fa-lock"></i></span>
                        <span class="sidebar-link-text">Privacy</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Main Content Area -->
        <div class="main-content">

            <!-- Top Header -->
            <header class="main-header">
                <div class="header-container">
                    <!-- Hamburger Menu (Mobile) -->
                    <button class="hamburger-btn" id="hamburgerBtn" aria-label="Toggle menu" aria-expanded="false" onclick="toggleSidebar()">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>

                    <!-- Header Actions -->
                    <div class="header-actions">
                        <span id="readinessPill" class="readiness-pill"><i class="fas fa-flag-checkered"></i> Readiness: --</span>
                        <button id="syncBtn" onclick="syncAllProviders()" class="header-btn" title="Sync data from all connected providers">
                            <i class="fas fa-cloud-download-alt"></i>
                            <span class="hide-mobile">Sync</span>
                        </button>
                        <button onclick="refreshAllData()" class="header-btn">
                            <i class="fas fa-sync-alt"></i>
                            <span class="hide-mobile">Refresh</span>
                        </button>
                    </div>

                    <div class="connection-badges" id="connectionBadges" style="justify-self: center; gap: 8px;">
                        <div id="badge-strava" class="connection-badge badge-disconnected" title="Strava - Activities and performance data">
                            <img src="/src/images/strava.svg" alt="Strava">
                            <span class="connection-badge-status" id="badge-strava-status">—</span>
                        </div>
                        <div id="badge-oura" class="connection-badge badge-disconnected" title="Oura Ring - Readiness, activity, and sleep insights">
                            <img src="/src/images/oura.png" alt="Oura">
                            <span class="connection-badge-status" id="badge-oura-status">—</span>
                        </div>
                        <div id="badge-garmin" class="connection-badge badge-disconnected" title="Garmin Connect - Activities, body battery, and wellness">
                            <img src="/src/images/Garmin.svg" alt="Garmin">
                            <span class="connection-badge-status" id="badge-garmin-status">—</span>
                        </div>
                        <div id="badge-whoop" class="connection-badge badge-disconnected" title="Whoop - Recovery, strain, and sleep data">
                            <img src="/src/images/WHOOP.svg" alt="Whoop">
                            <span class="connection-badge-status" id="badge-whoop-status">—</span>
                        </div>
                    </div>

                    <!-- User Account Menu -->
                    <div class="header-user">
                        <a href="/access" class="elite-btn">Elite Dashboard →</a>
                    </div>
                </div>
            </header>

    <div id="dashboard" class="dashboard">
        <div class="container">

            <!-- SCORE HERO WITH FLANKING METRICS -->
            <div class="score-hero-section">
                <div class="score-hero-container">

                    <!-- LEFT METRICS: Recovery & Strain stacked -->
                    <div class="metrics-side-card">
                        <div class="metric-item">
                            <div class="metric-value" id="scoreRecovery">--</div>
                            <div class="metric-label">Recovery</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-item">
                            <div class="metric-value" id="scoreLoad">--</div>
                            <div class="metric-label">Strain</div>
                        </div>
                    </div>

                    <!-- CENTER: Athlytx Score -->
                    <div class="score-center">
                        <div class="score-circle-wrapper">
                            <svg class="score-svg" viewBox="0 0 200 200">
                                <circle cx="100" cy="100" r="90" class="score-ring-bg"/>
                                <circle id="scoreProgressCircle" cx="100" cy="100" r="90" class="score-ring-progress"/>
                                <defs>
                                    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                        <stop offset="50%" style="stop-color:#764ba2;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f093fb;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="score-content">
                                <div class="score-number" id="athlytxScore">--</div>
                                <div class="score-max">out of 100</div>
                            </div>
                        </div>
                        <div id="scoreStatusContainer" class="score-status-container">
                            <div class="score-status-title" id="scoreStatus">Connect devices</div>
                            <div class="score-insight" id="scoreInsight">Connect your devices to see your score</div>
                        </div>
                    </div>

                    <!-- Readiness Status -->
                    <div class="readiness-status-hero" id="readinessHero">
                        <div class="readiness-icon" id="readinessIcon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                                      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                <path d="M3.22 12h7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M13.5 8.5l2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <path d="M13.5 15.5l2-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="readiness-text">
                            <div class="readiness-label">Today's Readiness</div>
                            <div class="readiness-message" id="readinessMessage">Connect your devices to see your status</div>
                        </div>
                    </div>

                    <!-- RIGHT METRICS: Sleep & HRV stacked -->
                    <div class="metrics-side-card">
                        <div class="metric-item">
                            <div class="metric-value" id="scoreSleep">--</div>
                            <div class="metric-label">Sleep</div>
                        </div>
                        <div class="metric-divider"></div>
                        <div class="metric-item">
                            <div class="metric-value" id="scoreHRV">--</div>
                            <div class="metric-label">HRV</div>
                        </div>
                    </div>
                </div>

                <!-- Data Sources Badge -->
                <div class="score-badge-container">
                    <div id="dataSourcesBadge" class="data-sources-badge">
                        <span id="deviceGuidance">Connect devices</span>
                    </div>
                    <div id="scoreConfidenceBadge" class="data-sources-badge" data-tooltip="Confidence reflects how much quality data we had (sleep, recovery, strain, HRV) over the last 7-30 days." style="margin-left: 10px; display: inline-flex; align-items: center; gap: 6px; cursor: help; position: relative;">
                        <span style="font-weight: 600;">Confidence:</span>
                        <span id="confidenceText">No data</span>
                        <span style="background: rgba(255,255,255,0.12); border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; cursor: help;" data-tooltip="We combine recovery (HRV/resting HR + device readiness), sleep quality, strain/load balance, and HRV trends. Confidence goes up when more of these signals are present and recent.">i</span>
                    </div>
                    <div id="confidenceTip" class="confidence-tip"></div>
                </div>
            </div>

            <!-- Hidden elements -->
            <div style="display: none;">
                <div id="scoreSources"></div>
                <div id="readinessBanner"></div>
                <div id="athlytxDebug" style="padding: 12px; margin-top: 10px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 8px; color: #e5e7eb; background: rgba(0,0,0,0.35);"></div>
            </div>

            <!-- Login/Signup Modal Overlay -->
            <div id="authModal" class="auth-modal-overlay" style="display: none;">
                <div class="auth-modal-container">
                    <button class="auth-modal-close" onclick="closeAuthModal()">&times;</button>

                    <div class="auth-modal-content">
                        <h2>Welcome to Athlytx</h2>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px;">
                            Create an account to sync your data across devices and unlock additional features.
                        </p>

                        <div class="auth-tabs">
                            <button class="auth-tab active" data-no-ripple onclick="showAuthForm('signup')">Sign Up</button>
                            <button class="auth-tab" data-no-ripple onclick="showAuthForm('login')">Login</button>
                        </div>

                        <!-- Sign Up Form -->
                        <form id="signupFormModal" class="auth-form" onsubmit="handleSignup(event)">
                            <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label for="signup-first-name">First Name</label>
                                    <input type="text" id="signup-first-name" required placeholder="First name">
                                </div>
                                <div>
                                    <label for="signup-last-name">Last Name</label>
                                    <input type="text" id="signup-last-name" required placeholder="Last name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="signup-sport">Primary Sport</label>
                                <select id="signup-sport" class="form-input">
                                    <option value="">Select your sport</option>
                                    <option value="Running">Running</option>
                                    <option value="Cycling">Cycling</option>
                                    <option value="Triathlon">Triathlon</option>
                                    <option value="Swimming">Swimming</option>
                                    <option value="Functional Fitness">Functional Fitness</option>
                                    <option value="Recreational">Recreational</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="signup-email-modal">Email</label>
                                <input type="email" id="signup-email-modal" required placeholder="you@example.com">
                                <small id="signup-email-helper" class="form-helper" style="display: none;"></small>
                            </div>
                            <div class="form-group">
                                <label for="signup-password-modal">Password</label>
                                <input type="password" id="signup-password-modal" required minlength="8" placeholder="Min 8 characters">
                                <small id="signup-password-helper" class="form-helper">Must be at least 8 characters</small>
                            </div>
                            <button type="submit" class="auth-submit-btn">Create Account</button>
                            <div id="signup-error-modal" class="auth-error" style="display: none;"></div>
                        </form>

                        <!-- Login Form -->
                        <form id="loginFormModal" class="auth-form" style="display: none;" onsubmit="handleLogin(event)">
                            <div class="form-group">
                                <label for="login-email-modal">Email</label>
                                <input type="email" id="login-email-modal" required placeholder="you@example.com">
                                <small id="login-email-helper" class="form-helper" style="display: none;"></small>
                            </div>
                            <div class="form-group">
                                <label for="login-password-modal">Password</label>
                                <input type="password" id="login-password-modal" required placeholder="Your password">
                                <small id="login-password-helper" class="form-helper" style="display: none;"></small>
                            </div>
                            <div style="text-align: right; margin-bottom: 16px;">
                                <a href="#" onclick="showForgotPasswordForm(); return false;" style="color: #667eea; font-size: 14px; text-decoration: none;">Forgot Password?</a>
                            </div>
                            <button type="submit" class="auth-submit-btn">Login</button>
                            <div id="login-error-modal" class="auth-error" style="display: none;"></div>
                        </form>

                        <!-- Forgot Password Form -->
                        <form id="forgotPasswordForm" class="auth-form" style="display: none;" onsubmit="handleForgotPassword(event)">
                            <button type="button" onclick="showAuthForm('login')" style="background: none; border: none; color: #667eea; cursor: pointer; margin-bottom: 16px; font-size: 14px;">← Back to Login</button>
                            <h3 style="margin-bottom: 16px;">Reset Password</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px; font-size: 14px;">Enter your email and we'll send you a link to reset your password.</p>
                            <div class="form-group">
                                <label for="forgot-email">Email</label>
                                <input type="email" id="forgot-email" required placeholder="you@example.com">
                            </div>
                            <button type="submit" class="auth-submit-btn">Send Reset Link</button>
                            <div id="forgot-success" class="auth-success" style="display: none; padding: 12px; background: rgba(16,185,129,0.2); border-radius: 8px; color: #10b981; margin-top: 16px;"></div>
                            <div id="forgot-error" class="auth-error" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Reconnect Devices Modal (post-signup) -->
            <div id="reconnectModal" class="auth-modal-overlay" style="display: none;">
                <div class="auth-modal-container" style="max-width: 520px;">
                    <button class="auth-modal-close" onclick="closeReconnectModal()">&times;</button>
                    <div class="auth-modal-content">
                        <h2>Reconnect your devices</h2>
                        <p style="color: rgba(255,255,255,0.75); margin-bottom: 16px;">
                            Guest connections stay in a temporary profile. Please reconnect so your devices sync to your new account.
                        </p>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                            <button class="btn" onclick="connectDevice('garmin'); closeReconnectModal();" style="justify-content:center;">
                                <img src="src/images/Garmin.svg" alt="Garmin" style="height:14px; margin-right:6px;"> Garmin
                            </button>
                            <button class="btn" onclick="connectDevice('whoop'); closeReconnectModal();" style="justify-content:center;">
                                <img src="src/images/WHOOP.svg" alt="Whoop" style="height:14px; margin-right:6px;"> Whoop
                            </button>
                            <button class="btn" onclick="connectDevice('oura'); closeReconnectModal();" style="justify-content:center;">
                                <img src="src/images/oura.png" alt="Oura" style="height:14px; margin-right:6px;"> Oura
                            </button>
                            <button class="btn" onclick="connectDevice('strava'); closeReconnectModal();" style="justify-content:center;">
                                <img src="src/images/strava.svg" alt="Strava" style="height:14px; margin-right:6px;"> Strava
                            </button>
                        </div>
                        <div style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1); border-radius:10px; padding:12px; font-size:0.9rem; color: rgba(229,231,235,0.85);">
                            <strong>Heads up:</strong> Garmin and some devices push data to us. After reconnecting, new data will flow in as the provider sends it forward. Historical data may require a manual sync/backfill.
                        </div>
                        <div style="margin-top:16px; display:flex; justify-content:flex-end; gap:8px;">
                            <button class="btn btn-ghost" onclick="closeReconnectModal()">Later</button>
                            <button class="btn btn-primary" onclick="switchTab('overview'); closeReconnectModal();">Continue</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Password Modal (shown when user clicks email link) -->
            <div id="resetPasswordModal" class="auth-modal-overlay" style="display: none;">
                <div class="auth-modal-container">
                    <button class="auth-modal-close" onclick="closeResetPasswordModal()">&times;</button>
                    <div class="auth-modal-content">
                        <h2>Reset Your Password</h2>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px;">Enter your new password below.</p>
                        <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" required minlength="8" placeholder="Min 8 characters">
                                <small class="form-helper">Must be at least 8 characters</small>
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Confirm Password</label>
                                <input type="password" id="confirm-password" required minlength="8" placeholder="Confirm password">
                            </div>
                            <button type="submit" class="auth-submit-btn">Reset Password</button>
                            <div id="reset-success" class="auth-success" style="display: none; padding: 12px; background: rgba(16,185,129,0.2); border-radius: 8px; color: #10b981; margin-top: 16px;"></div>
                            <div id="reset-error" class="auth-error" style="display: none;"></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Tab Content Wrapper -->
            <div class="tab-content-wrapper">
                <!-- Account Tab -->
                <div id="account" class="tab-panel" role="tabpanel" aria-labelledby="account-tab" style="margin-top: -20px;">
                    <!-- Guest Mode View -->
                    <div id="guestView" class="account-view" style="margin-top: 0; padding-top: 0;">
                        <div class="account-card glass-card" style="text-align: center; padding: 40px; margin-top: 0;">
                            <h2 style="margin-bottom: 16px;">Welcome to Athlytx</h2>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 32px; font-size: 16px;">
                                You're currently using Athlytx as a guest. Create an account to sync your data across devices and unlock additional features.
                            </p>
                            <button onclick="openAuthModal()" class="auth-submit-btn" style="padding: 16px 48px; font-size: 16px; min-width: 200px;">
                                Sign Up / Login
                            </button>
                        </div>
                    </div>

                    <!-- Authenticated View -->
                    <div id="authenticatedView" class="account-view" style="display: none; margin-top: 0; padding-top: 0;">

                        <!-- Profile Header Card -->
                        <div class="account-profile-card glass-card" style="margin-bottom: 24px; padding: 32px;">
                            <div class="profile-header" style="display: flex; align-items: center; gap: 24px; flex-wrap: wrap;">
                                <div class="profile-avatar" id="user-avatar-container" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700; color: white; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); flex-shrink: 0;">
                                    DZ
                                </div>
                                <div class="profile-details" style="flex: 1; min-width: 200px;">
                                    <h1 class="profile-name" id="user-name-display" style="font-size: 28px; font-weight: 700; margin: 0 0 8px 0; color: white;">-</h1>
                                    <p class="profile-email" id="user-email-display" style="font-size: 14px; color: rgba(255,255,255,0.7); margin: 0 0 12px 0;">-</p>
                                    <div class="profile-badges" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <span class="profile-badge" style="padding: 4px 12px; background: rgba(102, 126, 234, 0.2); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px; font-size: 12px; font-weight: 600; color: #667eea;">
                                            <i class="fas fa-check-circle"></i> Verified
                                        </span>
                                        <span class="profile-badge" id="member-since-badge" style="padding: 4px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.7);">
                                            <i class="fas fa-calendar"></i> Member since 2024
                                        </span>
                                    </div>
                                </div>
                                <button onclick="handleLogout()" class="logout-btn-new" style="padding: 12px 24px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: #ef4444; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; font-size: 14px;">
                                    <i class="fas fa-sign-out-alt"></i> <span class="hide-mobile">Logout</span>
                                </button>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="account-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card glass-card" style="padding: 20px; text-align: center;">
                                <div class="stat-icon" style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                    <i class="fas fa-plug"></i>
                                </div>
                                <div class="stat-value" id="connected-count" style="font-size: 28px; font-weight: 700; color: white; margin-bottom: 4px;">0</div>
                                <div class="stat-label" style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Connected</div>
                            </div>
                            <div class="stat-card glass-card" style="padding: 20px; text-align: center;">
                                <div class="stat-icon" style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                    <i class="fas fa-sync-alt"></i>
                                </div>
                                <div class="stat-value" id="last-sync-display" style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px;">Never</div>
                                <div class="stat-label" style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Last Sync</div>
                            </div>
                            <div class="stat-card glass-card" style="padding: 20px; text-align: center;">
                                <div class="stat-icon" style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, #fa709a, #fee140); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                                <div class="stat-value" id="account-readiness" style="font-size: 28px; font-weight: 700; color: white; margin-bottom: 4px;">--</div>
                                <div class="stat-label" style="font-size: 12px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Readiness</div>
                            </div>
                        </div>

                        <!-- Connected Services -->
                        <div class="account-section" style="margin-bottom: 24px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 16px 0; color: white; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-link"></i> Connected Services
                            </h3>
                            <div class="services-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
                                <div id="service-strava" class="service-card glass-card service-disconnected" style="padding: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;">
                                    <div class="service-icon" style="width: 40px; height: 40px; border-radius: 10px; background: rgba(252, 76, 2, 0.15); display: flex; align-items: center; justify-content: center;">
                                        <img src="/src/images/strava.svg" alt="Strava" style="width: 24px; height: 24px;">
                                    </div>
                                    <div class="service-info" style="flex: 1;">
                                        <div class="service-name" style="font-weight: 600; color: white; margin-bottom: 2px; font-size: 14px;">Strava</div>
                                        <div class="service-status" style="font-size: 11px; color: rgba(255,255,255,0.5);">Not connected</div>
                                    </div>
                                    <div class="service-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(148,163,184,0.5);"></div>
                                </div>
                                <div id="service-oura" class="service-card glass-card service-disconnected" style="padding: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;">
                                    <div class="service-icon" style="width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center;">
                                        <img src="/src/images/oura.png" alt="Oura" style="width: 24px; height: 24px;">
                                    </div>
                                    <div class="service-info" style="flex: 1;">
                                        <div class="service-name" style="font-weight: 600; color: white; margin-bottom: 2px; font-size: 14px;">Oura</div>
                                        <div class="service-status" style="font-size: 11px; color: rgba(255,255,255,0.5);">Not connected</div>
                                    </div>
                                    <div class="service-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(148,163,184,0.5);"></div>
                                </div>
                                <div id="service-garmin" class="service-card glass-card service-disconnected" style="padding: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;">
                                    <div class="service-icon" style="width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 114, 206, 0.15); display: flex; align-items: center; justify-content: center;">
                                        <img src="/src/images/Garmin.svg" alt="Garmin" style="width: 24px; height: 24px;">
                                    </div>
                                    <div class="service-info" style="flex: 1;">
                                        <div class="service-name" style="font-weight: 600; color: white; margin-bottom: 2px; font-size: 14px;">Garmin</div>
                                        <div class="service-status" style="font-size: 11px; color: rgba(255,255,255,0.5);">Not connected</div>
                                    </div>
                                    <div class="service-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(148,163,184,0.5);"></div>
                                </div>
                                <div id="service-whoop" class="service-card glass-card service-disconnected" style="padding: 16px; display: flex; align-items: center; gap: 12px; transition: all 0.2s ease;">
                                    <div class="service-icon" style="width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 0, 0, 0.2); display: flex; align-items: center; justify-content: center;">
                                        <img src="/src/images/WHOOP.svg" alt="Whoop" style="width: 24px; height: 24px;">
                                    </div>
                                    <div class="service-info" style="flex: 1;">
                                        <div class="service-name" style="font-weight: 600; color: white; margin-bottom: 2px; font-size: 14px;">Whoop</div>
                                        <div class="service-status" style="font-size: 11px; color: rgba(255,255,255,0.5);">Not connected</div>
                                    </div>
                                    <div class="service-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(148,163,184,0.5);"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Details -->
                        <div class="account-section">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0 0 16px 0; color: white; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-info-circle"></i> Account Details
                            </h3>
                            <div class="account-details-card glass-card" style="padding: 24px;">
                                <div class="detail-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 14px;">User ID</span>
                                    <span id="user-id-display" style="color: white; font-size: 13px; font-family: monospace; font-weight: 500;">-</span>
                                </div>
                                <div class="detail-row" style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 14px;">Account Type</span>
                                    <span style="color: white; font-size: 14px; font-weight: 600;">
                                        <span style="padding: 4px 12px; background: rgba(102, 126, 234, 0.2); border-radius: 12px; color: #667eea;">Athlete</span>
                                    </span>
                                </div>
                                <div class="detail-row" style="display: flex; justify-content: space-between; padding: 12px 0;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 14px;">Data Storage</span>
                                    <span style="color: white; font-size: 14px; font-weight: 500;"><i class="fas fa-lock"></i> Encrypted & Secure</span>
                                </div>
                            </div>
                        </div>

                        <!-- Legacy fields for JS compatibility -->
                        <input type="hidden" id="user-email" />
                        <input type="hidden" id="user-name" />
                        <input type="hidden" id="user-id" />
                        <input type="hidden" id="connected-services" />

                    </div>
                </div>

                <!-- Connections Tab -->
                <div id="connections" class="tab-panel active" role="tabpanel" aria-labelledby="connections-tab">
                <div class="devices-grid stagger-children">
                    <div class="device-card glass-card stagger-item">
                        <div class="device-header">
                            <div class="device-icon strava">
                                <img src="/src/images/strava.svg" alt="Strava" onerror="this.style.display='none'; this.parentNode.innerHTML='S';">
                            </div>
                            <div class="device-info">
                                <h3>Strava</h3>
                                <p>Activities and performance data</p>
                            </div>
                        </div>
                        <button class="connect-btn btn-strava" onclick="connectDevice('strava')">
                            Connect with Strava
                        </button>
                        <button class="disconnect-btn btn-strava-disconnect" onclick="disconnectDevice('strava')" style="display: none; margin-top: 8px;">
                            Disconnect
                        </button>
                    </div>

                    <div class="device-card glass-card">
                        <div class="device-header">
                            <div class="device-icon oura">
                                <img src="/src/images/oura-logo.jpeg" alt="Oura" onerror="this.style.display='none'; this.parentNode.innerHTML='O';">
                            </div>
                            <div class="device-info">
                                <h3>Oura Ring</h3>
                                <p>Readiness, activity, and sleep insights</p>
                            </div>
                        </div>
                        <button class="connect-btn btn-oura" onclick="connectDevice('oura')">
                            Connect with Oura
                        </button>
                        <button class="disconnect-btn btn-oura-disconnect" onclick="disconnectDevice('oura')" style="display: none; margin-top: 8px;">
                            Disconnect
                        </button>
                    </div>

                    <div class="device-card glass-card">
                        <div class="device-header">
                            <div class="device-icon garmin">
                                <img src="/src/images/GarminConnect.png" alt="Garmin Connect" onerror="this.style.display='none'; this.parentNode.innerHTML='G';">
                            </div>
                            <div class="device-info">
                                <h3>Garmin Connect™</h3>
                                <p>Activities, body battery, and wellness</p>
                            </div>
                        </div>
                        <button class="connect-btn btn-garmin" onclick="connectDevice('garmin')">
                            Connect with Garmin
                        </button>
                        <button class="disconnect-btn btn-garmin-disconnect" onclick="disconnectDevice('garmin')" style="display: none; margin-top: 8px;">
                            Disconnect
                        </button>
                    </div>

                    <div class="device-card glass-card">
                        <div class="device-header">
                            <div class="device-icon whoop">
                                <img src="/src/images/whoop-logo.jpeg" alt="Whoop" onerror="this.style.display='none'; this.parentNode.innerHTML='W';">
                            </div>
                            <div class="device-info">
                                <h3>Whoop</h3>
                                <p>Recovery, strain, and sleep data</p>
                            </div>
                        </div>
                        <button class="connect-btn btn-whoop" onclick="connectDevice('whoop')">
                            Connect with Whoop
                        </button>
                        <button class="disconnect-btn btn-whoop-disconnect" onclick="disconnectDevice('whoop')" style="display: none; margin-top: 8px;">
                            Disconnect
                        </button>
                    </div>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-panel" role="tabpanel" aria-labelledby="overview-tab">
                <div class="data-connections" id="overviewConnections"></div>

                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>Athlytx Score Trend</h3>
                        <div class="chart-container">
                            <canvas id="scoreTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-card glass-card">
                        <h3>Score Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="scoreBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strava Data Tab -->
            <div id="strava" class="tab-panel" role="tabpanel" aria-labelledby="strava-tab">
                <!-- Strava Attribution Header -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Powered by</div>
                    <img src="/src/images/strava.svg" alt="Strava" style="height: 45px; object-fit: contain;">
                </div>

                <!-- Athlete Info Card (populated dynamically) -->
                <div id="stravaAthleteInfo" style="display: none; background: rgba(102,126,234,0.1); border: 1px solid rgba(102,126,234,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <img id="stravaAthleteAvatar" src="" alt="Athlete" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(102,126,234,0.5);">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px 0; font-size: 1.2rem;" id="stravaAthleteName">--</h3>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);" id="stravaAthleteLocation">--</div>
                        </div>
                        <div style="display: flex; gap: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: #FC4C02;" id="stravaFollowerCount">--</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Followers</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: #FC4C02;" id="stravaFriendCount">--</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Following</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analytics-card glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">🏃 Strava Training Data Summary</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <label for="stravaPeriodSelector" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Period:</label>
                            <select id="stravaPeriodSelector" onchange="updateStravaPeriod()" style="padding: 6px 12px; border-radius: 8px; background: rgba(102,126,234,0.15); border: 1px solid rgba(102,126,234,0.35); color: #e5e7eb; font-size: 0.9rem; cursor: pointer;">
                                <option value="1">Today</option>
                                <option value="7" selected>Last 7 Days</option>
                                <option value="14">Last 14 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="60">Last 60 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="data-summary">
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaActivities">--</span>
                            <div class="summary-label">Activities</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaDistance">--</span>
                            <div class="summary-label">Total Distance</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaLoad">--</span>
                            <div class="summary-label">Training Load</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaAvgPower">--</span>
                            <div class="summary-label">Avg Power</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaElevation">--</span>
                            <div class="summary-label">Total Elevation</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaMovingTime">--</span>
                            <div class="summary-label">Moving Time</div>
                        </div>
                    </div>
                </div>

                <!-- Fitness & Form Metrics -->
                <div class="analytics-card glass-card">
                    <h3>📈 Fitness & Form (Last 42 Days)</h3>
                    <div class="data-summary">
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaFitness" style="color: #10b981;">--</span>
                            <div class="summary-label">Fitness (CTL)</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px;">Chronic Training Load</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaFatigue" style="color: #f59e0b;">--</span>
                            <div class="summary-label">Fatigue (ATL)</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px;">Acute Training Load</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaForm" style="color: #3b82f6;">--</span>
                            <div class="summary-label">Form (TSB)</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px;">Training Stress Balance</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="stravaFormStatus">--</span>
                            <div class="summary-label">Status</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 4px;" id="stravaFormAdvice">--</div>
                        </div>
                    </div>
                </div>

                <!-- HR Zones & Relative Effort Grid -->
                <div class="analytics-grid">
                    <!-- Time in HR Zones Card -->
                    <div class="analytics-card glass-card">
                        <h3>⏱️ Time in Heart Rate Zones</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(16,185,129,0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Zone 1 - Easy</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">&lt;60% Max HR</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #10b981;" id="hrZone1Time">--</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);" id="hrZone1Minutes">-- min</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Zone 2 - Moderate</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">60-70% Max HR</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #3b82f6;" id="hrZone2Time">--</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);" id="hrZone2Minutes">-- min</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Zone 3 - Tempo</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">70-80% Max HR</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #f59e0b;" id="hrZone3Time">--</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);" id="hrZone3Minutes">-- min</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(249,115,22,0.1); border-radius: 8px; border-left: 4px solid #f97316;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Zone 4 - Threshold</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">80-90% Max HR</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #f97316;" id="hrZone4Time">--</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);" id="hrZone4Minutes">-- min</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">Zone 5 - VO2 Max</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">&gt;90% Max HR</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #ef4444;" id="hrZone5Time">--</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);" id="hrZone5Minutes">-- min</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Relative Effort Card -->
                    <div class="analytics-card glass-card">
                        <h3>💪 Relative Effort</h3>
                        <div style="text-align: center; padding: 20px 0;">
                            <div id="stravaRelativeEffort" style="font-size: 3.5rem; font-weight: 800; color: #f59e0b; margin-bottom: 8px;">--</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 20px;">Total effort in selected period</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Average per Activity</span>
                                <span id="stravaAvgEffort" style="font-weight: 600; color: #3b82f6;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Highest Activity</span>
                                <span id="stravaMaxEffort" style="font-weight: 600; color: #ef4444;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Activities Logged</span>
                                <span id="stravaEffortCount" style="font-weight: 600; color: #10b981;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                                <span style="color: rgba(255,255,255,0.7);">Weekly Average</span>
                                <span id="stravaWeeklyEffort" style="font-weight: 600; color: #8b5cf6;">--</span>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; font-size: 0.8rem; color: rgba(255,255,255,0.6); text-align: center;">
                            Based on Suffer Score from Strava activities
                        </div>
                    </div>
                </div>

                <!-- Full-width Activities Table -->
                <div class="analytics-card glass-card" style="grid-column: 1 / -1;">
                    <h3>📋 All Strava Activities (Detailed View)</h3>
                    <div id="stravaActivitiesList">
                        <div style="text-align: center; padding: 20px; color: #6b7280;">Connect Strava to see your activities</div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>Weekly Training Load</h3>
                        <div class="chart-container">
                            <canvas id="stravaLoadChart"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Fitness & Form Trend</h3>
                        <div class="chart-container">
                            <canvas id="stravaFitnessChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color:rgba(255,255,255,0.7); margin-top:6px;">42-day rolling averages (CTL/ATL) and Form (TSB)</div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Time in Heart Rate Zones</h3>
                        <div class="chart-container">
                            <canvas id="stravaHRZonesChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color:rgba(255,255,255,0.7); margin-top:6px;">Based on activities with HR data in selected period</div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Intensity Distribution (approx.)</h3>
                        <div class="chart-container">
                            <canvas id="stravaIntensityDistChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color:rgba(255,255,255,0.7); margin-top:6px;">Buckets estimated using activity Suffer Score and duration.</div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Training Monotony</h3>
                        <div class="insight-card" id="stravaMonotonyCard">
                            <p id="stravaMonotonyText">—</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Oura Data Tab -->
            <div id="oura" class="tab-panel" role="tabpanel" aria-labelledby="oura-tab">
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                    <label for="ouraPeriodSelector" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Period:</label>
                    <select id="ouraPeriodSelector" onchange="updateOuraPeriod()" style="padding: 6px 12px; border-radius: 8px; background: rgba(180,92,243,0.15); border: 1px solid rgba(180,92,243,0.35); color: #e5e7eb; font-size: 0.9rem; cursor: pointer;">
                        <option value="1" selected>Today</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>

                <!-- Oura Attribution Header -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Powered by</div>
                    <img src="src/images/ourawhite.png" alt="Oura" style="height: 45px; object-fit: contain;">
                </div>

                <!-- User Info Card (populated dynamically) -->
                <div id="ouraPersonalInfo" style="display: none; background: rgba(180,92,243,0.1); border: 1px solid rgba(180,92,243,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(180,92,243,0.5); background: rgba(180,92,243,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem;">💍</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 4px 0; font-size: 1.2rem;">Oura Member</h3>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7);" id="ouraUserEmail">--</div>
                        </div>
                        <div style="display: flex; gap: 20px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: #B45CF3;" id="ouraAge">--</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Age</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.4rem; font-weight: 700; color: #B45CF3;" id="ouraWeight">--</div>
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Weight (kg)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Oura Actions -->
                <div style="display:flex; gap:10px; align-items:center; margin: 12px 0 20px 0;">
                    <button class="btn" onclick="refreshOuraNow()" style="padding:8px 12px; border-radius:8px; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.35); color:#e5e7eb;">
                        Refresh Oura Data
                    </button>
                    <button class="btn btn-oura-reconnect" onclick="connectDevice('oura')" style="display:none; padding:8px 12px; border-radius:8px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.35); color:#e5e7eb;">
                        Reconnect Oura
                    </button>
                    <div id="ouraActionStatus" style="font-size:0.9rem; color: rgba(229,231,235,0.8);"></div>
                </div>

                <div class="analytics-card glass-card">
                    <h3>💍 Oura Recovery & Sleep Summary (Last 7 Days)</h3>
                    <div class="data-summary">
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="ouraReadiness">--</span>
                            <div class="summary-label">Readiness Score</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="ouraSleep">--</span>
                            <div class="summary-label">Sleep Score</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="ouraHRV">--</span>
                            <div class="summary-label">Avg HRV</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="ouraRHR">--</span>
                            <div class="summary-label">Resting HR</div>
                        </div>
                    </div>
                </div>

                <!-- Data Tables Grid (3 columns) -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>😴 Sleep Data (Detailed View)</h3>
                        <div id="ouraSleepDataList">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">Connect Oura to see your sleep data</div>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>🎯 Readiness Data (Detailed View)</h3>
                        <div id="ouraReadinessDataList">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">Connect Oura to see your readiness data</div>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>🏃 Activity Data (Detailed View)</h3>
                        <div id="ouraActivityDataList">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">Connect Oura to see your activity data</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>Sleep Stages (Last 7 Days)</h3>
                        <div class="chart-container">
                            <canvas id="ouraSleepStagesChart"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Readiness vs HRV</h3>
                        <div class="chart-container">
                            <canvas id="ouraCorrelationChart"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Readiness & Sleep Score</h3>
                        <div class="chart-container">
                            <canvas id="ouraTrendRS"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>HRV & Resting HR</h3>
                        <div class="chart-container">
                            <canvas id="ouraTrendHRVHR"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Sleep Consistency</h3>
                        <div class="insight-card" id="ouraConsistencyCard">
                            <p id="ouraConsistencyText">—</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Garmin Data Tab -->
            <div id="garmin" class="tab-panel" role="tabpanel" aria-labelledby="garmin-tab">
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                    <label for="garminPeriodSelector" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Period:</label>
                    <select id="garminPeriodSelector" onchange="updateGarminPeriod()" style="padding: 6px 12px; border-radius: 8px; background: rgba(0,172,228,0.15); border: 1px solid rgba(0,172,228,0.35); color: #e5e7eb; font-size: 0.9rem; cursor: pointer;">
                        <option value="1">Today</option>
                        <option value="7" selected>Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>

                <!-- Garmin Attribution Header -->
                <div style="background: linear-gradient(135deg, rgba(0,112,192,0.15), rgba(0,172,228,0.15)); border-radius: 16px; padding: 28px; margin-bottom: 24px; text-align: center; border: 1px solid rgba(0,172,228,0.3); box-shadow: 0 8px 32px rgba(0,172,228,0.2);">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 2px; font-weight: 600;">Powered by</div>
                    <img src="src/images/Garmin.svg" alt="Garmin Connect" style="height: 60px; object-fit: contain; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));">
                </div>

                <!-- Data availability note -->
                <div style="background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 12px 14px; color: rgba(229,231,235,0.9); margin-bottom: 12px; font-size: 0.95rem;">
                    Garmin pushes new wellness data forward when your device syncs. Historical Body Battery/HRV backfill is limited—keep your watch syncing to see fresh Body Battery, stress, and HRV here.
                </div>

                <!-- Hero Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 8px;">
                    <!-- Activities -->
                    <div style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(139,92,246,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-running" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Activities</div>
                        <div id="garminActivities" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Total Workouts</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Distance -->
                    <div style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(16,185,129,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-route" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Distance</div>
                        <div id="garminDistance" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Total Traveled</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Heart Rate -->
                    <div style="background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(239,68,68,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-heartbeat" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Heart Rate</div>
                        <div id="garminAvgHR" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Average BPM</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Training Time -->
                    <div style="background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(245,158,11,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-clock" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Training Time</div>
                        <div id="garminTrainingTime" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Total Duration</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Steps -->
                    <div style="background: linear-gradient(135deg, rgba(14,165,233,0.15), rgba(56,189,248,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(56,189,248,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-shoe-prints" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Steps</div>
                        <div id="garminSteps" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Latest daily total</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Resting HR -->
                    <div style="background: linear-gradient(135deg, rgba(248,113,113,0.15), rgba(239,68,68,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(248,113,113,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-heart" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Resting HR</div>
                        <div id="garminRestingHR" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Beats per minute</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Sleep Duration -->
                    <div style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(59,130,246,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(99,102,241,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-moon" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Sleep</div>
                        <div id="garminSleep" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Hours (last night)</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Body Battery -->
                    <div id="garminBodyBatteryCard" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(22,163,74,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(34,197,94,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-battery-three-quarters" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Body Battery</div>
                        <div id="garminBodyBattery" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Energy Level</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Stress Level -->
                    <div id="garminStressCard" style="background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(147,51,234,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(168,85,247,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-brain" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Stress Level</div>
                        <div id="garminStressLevel" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Average</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- HRV -->
                    <div id="garminHRVCard" style="background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(59,130,246,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-heart" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">HRV</div>
                        <div id="garminHRV" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Variability (ms)</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Respiration -->
                    <div id="garminRespirationCard" style="background: linear-gradient(135deg, rgba(20,184,166,0.15), rgba(13,148,136,0.15)); padding: 20px; border-radius: 16px; border: 1px solid rgba(20,184,166,0.3); position: relative; overflow: hidden;">
                        <i class="fas fa-lungs" style="font-size: 48px; position: absolute; top: 10px; right: 10px; opacity: 0.1;"></i>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Respiration</div>
                        <div id="garminRespiration" style="font-size: 2.5rem; font-weight: 800; color: #fff; margin-bottom: 4px;">--</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Breaths/Min</div>
                        <div style="position: absolute; bottom: 10px; right: 10px; display: flex; align-items: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500; letter-spacing: 0.3px;">Powered by Garmin</span>
                        </div>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-bottom: 16px;">
                    <div id="garminLastUpdated" style="font-size: 11px; color: rgba(255,255,255,0.6);">Last updated: —</div>
                </div>

                <!-- Garmin Actions (none for OAuth2 push) -->
                <div style="margin: 12px 0 20px 0;"></div>

                <div class="analytics-grid">
                    <!-- Activities List -->
                    <div class="analytics-card glass-card" style="grid-column: span 2;">
                        <h3 style="display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-running"></i>
                                Recent Activities
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                                <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500;">Powered by Garmin</span>
                            </div>
                        </h3>
                        <div id="garminActivitiesList" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fas fa-watch" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                                <div style="font-size: 1.1rem; margin-bottom: 8px;">Connect Garmin to see your activities</div>
                                <div style="font-size: 0.9rem; opacity: 0.7;">Sync your workouts, health metrics, and more</div>
                            </div>
                        </div>
                    </div>

                    <!-- Heart Rate Zones -->
                    <div class="analytics-card glass-card">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-heartbeat"></i>
                            Time in Heart Rate Zones
                        </h3>
                        <div class="chart-container">
                            <canvas id="garminZonesChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 12px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Body Battery Trend -->
                    <div class="analytics-card glass-card">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-battery-three-quarters"></i>
                            Body Battery Trend
                        </h3>
                        <div class="chart-container">
                            <canvas id="garminBodyBatteryChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 12px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Stress Analysis -->
                    <div class="analytics-card glass-card">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-brain"></i>
                            Stress Distribution
                        </h3>
                        <div class="chart-container">
                            <canvas id="garminStressChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 12px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500;">Powered by Garmin</span>
                        </div>
                    </div>

                    <!-- Respiration & HRV -->
                    <div class="analytics-card glass-card">
                        <h3 style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-heart"></i>
                            HRV & Respiration
                        </h3>
                        <div class="chart-container">
                            <canvas id="garminHRVRespirationChart"></canvas>
                        </div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 12px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <img src="src/images/Garmin.svg" alt="Garmin" style="height: 12px; opacity: 0.85;">
                            <span style="font-size: 10px; color: rgba(255,255,255,0.85); font-weight: 500;">Powered by Garmin</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Whoop Data Tab -->
            <div id="whoop" class="tab-panel" role="tabpanel" aria-labelledby="whoop-tab">
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                    <label for="whoopPeriodSelector" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Period:</label>
                    <select id="whoopPeriodSelector" onchange="updateWhoopPeriod()" style="padding: 6px 12px; border-radius: 8px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.35); color: #e5e7eb; font-size: 0.9rem; cursor: pointer;">
                        <option value="1" selected>Today</option>
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>

                <!-- Whoop Attribution Header -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Powered by</div>
                    <img src="src/images/WHOOP.svg" alt="Whoop" style="height: 45px; object-fit: contain; filter: invert(1) brightness(2);">
                </div>

                <!-- Whoop Actions -->
                <div style="display:flex; gap:10px; align-items:center; margin: 12px 0 20px 0;">
                    <button class="btn" onclick="refreshWhoopNow()" style="padding:8px 12px; border-radius:8px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.35); color:#e5e7eb;">
                        Refresh Whoop Data
                    </button>
                    <button class="btn" onclick="exportTabToPDF('whoop','Whoop')" style="padding:8px 12px; border-radius:8px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.35); color:#e5e7eb;">
                        Export Whoop PDF
                    </button>
                    <div id="whoopActionStatus" style="font-size:0.9rem; color: rgba(229,231,235,0.8);"></div>
                </div>

                <div class="analytics-card glass-card">
                    <h3><i class="fas fa-dumbbell"></i> Whoop Strain & Recovery</h3>
                    <div class="data-summary">
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="whoopRecovery">--</span>
                            <div class="summary-label">Recovery %</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="whoopStrain">--</span>
                            <div class="summary-label">Strain Score</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="whoopSleep">--</span>
                            <div class="summary-label">Sleep Performance %</div>
                        </div>
                        <div class="summary-card glass-card">
                            <span class="summary-value" id="whoopHRV">--</span>
                            <div class="summary-label">HRV (ms)</div>
                        </div>
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>Recent Activities</h3>
                        <div id="whoopActivitiesList" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px; color: #6b7280;">Connect Whoop to see your activities</div>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Sleep & Recovery Trend</h3>
                        <div class="chart-container">
                            <canvas id="whoopTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Recovery Trend</h3>
                        <div class="chart-container">
                            <canvas id="whoopRecoveryTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>Today's Strain Target</h3>
                        <div class="insight-card" id="whoopStrainTargetCard">
                            <p id="whoopStrainTargetText">—</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Running Tab -->
            <div id="running" class="tab-panel" role="tabpanel" aria-labelledby="running-tab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap;">
                    <h3 style="margin: 0; font-size: 1.2rem;">🏃 Running Analytics</h3>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label for="runningPeriodSelector" style="font-size: 0.85rem; color: rgba(255,255,255,0.7);">Period:</label>
                        <select id="runningPeriodSelector" onchange="updateRunningPeriod()" style="padding: 6px 12px; border-radius: 8px; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.35); color: #e5e7eb; font-size: 0.9rem; cursor: pointer;">
                            <option value="1">Today</option>
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="28" selected>Last 28 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                </div>

                <!-- Hero Stats - Key Running Metrics -->
                <div class="data-summary" style="margin-bottom: 30px;">
                    <div class="summary-card glass-card">
                        <span class="summary-value" id="runningDistance">--</span>
                        <div class="summary-label">Total Distance</div>
                        <span class="trend-arrow" id="runningDistanceTrend"></span>
                    </div>
                    <div class="summary-card glass-card">
                        <span class="summary-value" id="runningFrequency">--</span>
                        <div class="summary-label">Runs per Week</div>
                        <span class="trend-arrow" id="runningFrequencyTrend"></span>
                    </div>
                    <div class="summary-card glass-card">
                        <span class="summary-value" id="runningDuration">--</span>
                        <div class="summary-label">Total Time</div>
                        <span class="trend-arrow" id="runningDurationTrend"></span>
                    </div>
                    <div class="summary-card glass-card">
                        <span class="summary-value" id="runningElevation">--</span>
                        <div class="summary-label">Elevation Gain</div>
                        <span class="trend-arrow" id="runningElevationTrend"></span>
                    </div>
                </div>

                <div class="analytics-card glass-card" style="margin-bottom: 24px;">
                    <h3>📈 Training Load Insight</h3>
                    <div id="runningLoadInsight" style="margin-top: 8px; padding: 12px; background: rgba(59,130,246,0.08); border-radius: 8px; font-size: 0.95rem; color: rgba(255,255,255,0.8);">
                        Connect Strava or Garmin to see load trends
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>🧱 Training Load (Suffer Score)</h3>
                        <div class="chart-container">
                            <canvas id="runningLoadChart"></canvas>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">Daily load with heart rate overlay</div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>⚡ Weekly Pace Trend</h3>
                        <div class="chart-container">
                            <canvas id="runningPaceChart"></canvas>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">Average pace and HR by week</div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>🎯 Intensity Distribution</h3>
                        <div class="chart-container">
                            <canvas id="runningIntensityChart"></canvas>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">Easy / moderate / hard split (last 4 weeks)</div>
                    </div>
                </div>

                <!-- Fitness & Form (CTL, ATL, TSB) -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>💪 Fitness (CTL)</h3>
                        <div style="text-align: center; padding: 20px 0;">
                            <div id="runningCTL" style="font-size: 3rem; font-weight: 800; color: #10b981; margin-bottom: 8px;">--</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">42-day training load average</div>
                        </div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.65); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            Higher CTL = bigger endurance “engine” built from consistent training load.
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>😓 Fatigue (ATL)</h3>
                        <div style="text-align: center; padding: 20px 0;">
                            <div id="runningATL" style="font-size: 3rem; font-weight: 800; color: #f59e0b; margin-bottom: 8px;">--</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">7-day training load average</div>
                        </div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.65); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            ATL shows how much hard work you did this week—higher means more fatigue.
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>⚖️ Form (TSB)</h3>
                        <div style="text-align: center; padding: 20px 0;">
                            <div id="runningTSB" style="font-size: 3rem; font-weight: 800; color: #3b82f6; margin-bottom: 8px;">--</div>
                            <div id="runningFormStatus" style="font-size: 1rem; color: rgba(255,255,255,0.8); margin-bottom: 4px;">--</div>
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">Fitness - Fatigue</div>
                        </div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.65); margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                            TSB = CTL − ATL. Around 0 to +25 feels fresh (race-ready); -10 to -30 is productive training stress.
                        </div>
                    </div>
                </div>

                <!-- Recovery Dashboard -->
                <div class="analytics-card glass-card">
                    <h3>🔋 Recovery & Readiness</h3>
                    <div class="data-summary" style="margin: 0;">
                        <div class="summary-card glass-card" style="background: rgba(16,185,129,0.1);">
                            <span class="summary-value" id="runningHRV" style="color: #10b981;">--</span>
                            <div class="summary-label">HRV (RMSSD)</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;" id="runningHRVStatus">7-day avg</div>
                        </div>
                        <div class="summary-card glass-card" style="background: rgba(239,68,68,0.1);">
                            <span class="summary-value" id="runningRHR" style="color: #ef4444;">--</span>
                            <div class="summary-label">Resting HR</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;" id="runningRHRStatus">7-day avg</div>
                        </div>
                        <div class="summary-card glass-card" style="background: rgba(139,92,246,0.1);">
                            <span class="summary-value" id="runningSleep" style="color: #8b5cf6;">--</span>
                            <div class="summary-label">Sleep Score</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">7-day avg</div>
                        </div>
                        <div class="summary-card glass-card" style="background: rgba(59,130,246,0.1);">
                            <span class="summary-value" id="runningReadiness" style="color: #3b82f6;">--</span>
                            <div class="summary-label">Readiness</div>
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 4px;">Overall status</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                        <strong>Recovery Guidance:</strong> <span id="runningRecoveryGuidance">Connect Oura or Whoop to see personalized recovery guidance</span>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>⚡ Pace Performance</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Avg Pace</div>
                                <div id="runningAvgPace" style="font-size: 1.4rem; font-weight: 700; color: #3b82f6;">--</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Best Pace</div>
                                <div id="runningBestPace" style="font-size: 1.4rem; font-weight: 700; color: #10b981;">--</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Avg HR</div>
                                <div id="runningAvgHR" style="font-size: 1.4rem; font-weight: 700; color: #ef4444;">--</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">VO2max Est.</div>
                                <div id="runningVO2max" style="font-size: 1.4rem; font-weight: 700; color: #f59e0b;">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>👟 Running Form</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Cadence</div>
                                <div id="runningCadence" style="font-size: 1.4rem; font-weight: 700; color: #8b5cf6;">--</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">spm</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Stride Length</div>
                                <div id="runningStrideLength" style="font-size: 1.4rem; font-weight: 700; color: #06b6d4;">--</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">m</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Ground Contact</div>
                                <div id="runningGCT" style="font-size: 1.4rem; font-weight: 700; color: #f59e0b;">--</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">ms</div>
                            </div>
                            <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Vert. Oscillation</div>
                                <div id="runningVertOsc" style="font-size: 1.4rem; font-weight: 700; color: #ec4899;">--</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">cm</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding: 8px; background: rgba(139,92,246,0.1); border-radius: 6px; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-align: center;">
                            Optimal: Cadence 170-180 | GCT <200ms | VO <10cm
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>📊 Weekly Progress</h3>
                        <div style="margin-top: 12px;">
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Distance</span>
                                <span id="runningWeeklyDistChange" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Runs</span>
                                <span id="runningWeeklyRunsChange" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Avg Pace</span>
                                <span id="runningWeeklyPaceChange" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.7);">Training Load</span>
                                <span id="runningWeeklyLoadChange" style="font-weight: 600;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                                <span style="color: rgba(255,255,255,0.7);">Longest Run</span>
                                <span id="runningWeeklyLongestChange" style="font-weight: 600;">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Distribution -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>🎯 Heart Rate Zone Distribution</h3>
                        <div class="chart-container">
                            <canvas id="runningHRZonesChart"></canvas>
                        </div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 12px; text-align: center;">
                            Time spent in each HR zone (last 4 weeks)
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>📈 Training Intensity Pyramid</h3>
                        <div class="chart-container">
                            <canvas id="runningIntensityPyramid"></canvas>
                        </div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 12px; text-align: center;">
                            Optimal: 80% easy, 10% moderate, 10% hard
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>💪 Fitness & Form Trend</h3>
                        <div class="chart-container">
                            <canvas id="runningFitnessTrend"></canvas>
                        </div>
                        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 12px; text-align: center;">
                            CTL (Fitness), ATL (Fatigue), TSB (Form) - last 42 days
                        </div>
                    </div>
                </div>

                <!-- Volume & Pace Charts -->
                <div class="analytics-grid">
                    <div class="analytics-card glass-card">
                        <h3>📏 Weekly Distance Trend</h3>
                        <div class="chart-container">
                            <canvas id="runningVolumeChart"></canvas>
                        </div>
                        <div id="runningVolumeInsight" style="margin-top: 12px; padding: 10px; background: rgba(59,130,246,0.1); border-radius: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            Connect Strava or Garmin to see volume trends
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>⚡ Pace Progression</h3>
                        <div class="chart-container">
                            <canvas id="runningPaceProgression"></canvas>
                        </div>
                        <div id="runningPaceInsight" style="margin-top: 12px; padding: 10px; background: rgba(16,185,129,0.1); border-radius: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            Track pace improvements across different distances
                        </div>
                    </div>

                    <div class="analytics-card glass-card">
                        <h3>🏃 Endurance Development</h3>
                        <div class="chart-container">
                            <canvas id="runningEnduranceChart"></canvas>
                        </div>
                        <div id="runningEnduranceInsight" style="margin-top: 12px; padding: 10px; background: rgba(245,158,11,0.1); border-radius: 6px; font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            Longest runs and long run percentage of weekly volume
                        </div>
                    </div>
                </div>

                <!-- Personal Records -->
                <div class="analytics-card glass-card">
                    <h3>🏆 Personal Records & Achievements</h3>
                    <div id="runningRecords" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Fastest 5K</div>
                            <div id="runningPR5k" style="font-size: 1.6rem; font-weight: 700; color: #10b981;">--</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Fastest 10K</div>
                            <div id="runningPR10k" style="font-size: 1.6rem; font-weight: 700; color: #3b82f6;">--</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Fastest Half</div>
                            <div id="runningPRHalf" style="font-size: 1.6rem; font-weight: 700; color: #8b5cf6;">--</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Fastest Marathon</div>
                            <div id="runningPRMarathon" style="font-size: 1.6rem; font-weight: 700; color: #f59e0b;">--</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Longest Run</div>
                            <div id="runningPRLongest" style="font-size: 1.6rem; font-weight: 700; color: #ec4899;">--</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px;">Most Elevation</div>
                            <div id="runningPRElevation" style="font-size: 1.6rem; font-weight: 700; color: #06b6d4;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="insights" class="tab-panel" role="tabpanel" aria-labelledby="insights-tab">
                <div class="analytics-grid">
                    <div class="analytics-card glass-card ai-insights-hero">
                        <div class="ai-insights-header">
                            <svg class="ai-icon-large" width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="url(#gradient1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 17L12 22L22 17" stroke="url(#gradient1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 12L12 17L22 12" stroke="url(#gradient1)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <defs>
                                    <linearGradient id="gradient1" x1="2" y1="2" x2="22" y2="22" gradientUnits="userSpaceOnUse">
                                        <stop offset="0%" stop-color="#667eea"/>
                                        <stop offset="100%" stop-color="#10b981"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <h3><i class="fas fa-robot"></i> AI-Powered Insights</h3>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <label for="insightCategoryFilter" style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">Category:</label>
                            <select id="insightCategoryFilter" style="flex: 1; padding: 6px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 0.9rem; cursor: pointer;">
                                <option value="all">All Insights</option>
                                <option value="recovery">Recovery</option>
                                <option value="progress">Progress</option>
                                <option value="running-advice">Running Advice</option>
                                <option value="coaching-tip">Coaching Tip</option>
                            </select>
                        </div>
                        <div id="aiInsights">
                            <div class="ai-insight-item">
                                <div class="ai-insight-icon">📊</div>
                                <div class="ai-insight-content">
                                    <strong>Data Analysis</strong>
                                    <p>Connect your devices to get personalized insights based on your multi-stream data.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-card glass-card">
                        <h3>Cross-Device Correlations</h3>
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <label for="correlationWindow" style="font-size:0.9rem; color:rgba(255,255,255,0.7);">Window:</label>
                            <select id="correlationWindow" style="font-size:0.9rem; padding:4px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.1); color:white;">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="28">28 days</option>
                            </select>
                            <span style="font-size:0.85rem; color:rgba(255,255,255,0.7);">Adjust to explore relationships over time</span>
                        </div>
                        <div class="chart-container" style="height: 240px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                <div style="font-weight:600; color:rgba(255,255,255,0.95);">Load vs Recovery</div>
                                <div id="loadRecoveryR" style="font-size:0.85rem; color:rgba(255,255,255,0.7);">r: --</div>
                            </div>
                            <canvas id="loadRecoveryChart"></canvas>
                        </div>
                        <div class="chart-container" style="height: 240px; margin-top: 16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                <div style="font-weight:600; color:rgba(255,255,255,0.95);">Sleep vs Next‑day Load</div>
                                <div id="sleepLoadR" style="font-size:0.85rem; color:rgba(255,255,255,0.7);">r: --</div>
                            </div>
                            <canvas id="sleepLoadChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Tab -->
            <div id="contact" class="tab-panel" role="tabpanel" aria-labelledby="contact-tab">
                <div class="analytics-card glass-card" style="max-width: 600px; margin: 0 auto;">
                    <h3>📧 Get in Touch</h3>
                    <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 30px;">
                        Have questions or feedback? We'd love to hear from you!
                    </p>

                    <form id="contactForm" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label for="contactName" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">Name</label>
                            <input
                                type="text"
                                id="contactName"
                                required
                                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 14px;"
                                placeholder="Your name"
                            />
                        </div>

                        <div>
                            <label for="contactEmail" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">Email</label>
                            <input
                                type="email"
                                id="contactEmail"
                                required
                                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 14px;"
                                placeholder="your.email@example.com"
                            />
                        </div>

                        <div>
                            <label for="contactSubject" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">Subject</label>
                            <input
                                type="text"
                                id="contactSubject"
                                required
                                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 14px;"
                                placeholder="What's this about?"
                            />
                        </div>

                        <div>
                            <label for="contactMessage" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-weight: 600;">Message</label>
                            <textarea
                                id="contactMessage"
                                required
                                rows="6"
                                style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 14px; resize: vertical; font-family: inherit;"
                                placeholder="Tell us what's on your mind..."
                            ></textarea>
                        </div>

                        <button
                            type="submit"
                            class="refresh-btn"
                            style="background: linear-gradient(135deg, #667eea, #764ba2); border: none; padding: 14px 28px; font-size: 16px; font-weight: 600; cursor: pointer; align-self: flex-start;"
                        >
                            Send Message
                        </button>

                        <div id="contactFormStatus" style="display: none; padding: 12px; border-radius: 8px; margin-top: 10px;"></div>
                    </form>
                </div>
            </div>
            </div> <!-- End tab-content-wrapper -->
        </div>
    </div>

    <!-- Fixed Footer -->
    <footer class="main-footer">
        <div class="footer-brands">
            <div class="footer-brands-label">Powered by Garmin, Strava, Whoop, and Oura</div>
            <div class="footer-brands-logos">
                <img src="src/images/Garmin.svg" alt="Garmin" class="brand-logo brand-logo-garmin">
                <span class="brand-separator">|</span>
                <img src="src/images/strava.svg" alt="Strava" class="brand-logo brand-logo-strava">
                <span class="brand-separator">|</span>
                <img src="src/images/WHOOP.svg" alt="Whoop" class="brand-logo brand-logo-whoop">
                <span class="brand-separator">|</span>
                <img src="src/images/ourawhite.png" alt="Oura" class="brand-logo brand-logo-oura">
            </div>
        </div>
        <div class="footer-links">
            <a href="/about.html">About</a>
            <a href="/privacy.html">Privacy Policy</a>
            <a href="mailto:privacy@athlytx.com">Contact</a>
            <a href="/terms.html">Terms of Service</a>
        </div>
        <div class="footer-text">
            © 2025 Athlytx. Advanced fitness analytics platform.
        </div>
    </footer>

    <script>
        // ===== HAMBURGER MENU TOGGLE =====
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const headerMenu = document.getElementById('headerMenu');

            if (hamburgerBtn && headerMenu) {
                hamburgerBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const isOpen = headerMenu.classList.toggle('mobile-menu-open');
                    hamburgerBtn.classList.toggle('active');
                    hamburgerBtn.setAttribute('aria-expanded', isOpen);
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (headerMenu.classList.contains('mobile-menu-open') &&
                        !headerMenu.contains(e.target) &&
                        !hamburgerBtn.contains(e.target)) {
                        headerMenu.classList.remove('mobile-menu-open');
                        hamburgerBtn.classList.remove('active');
                        hamburgerBtn.setAttribute('aria-expanded', 'false');
                    }
                });

                // Close menu when clicking a menu item
                const menuItems = headerMenu.querySelectorAll('a, button');
                menuItems.forEach(item => {
                    item.addEventListener('click', function() {
                        headerMenu.classList.remove('mobile-menu-open');
                        hamburgerBtn.classList.remove('active');
                        hamburgerBtn.setAttribute('aria-expanded', 'false');
                    });
                });

                // Close menu on window resize to desktop size
                window.addEventListener('resize', function() {
                    if (window.innerWidth > 768) {
                        headerMenu.classList.remove('mobile-menu-open');
                        hamburgerBtn.classList.remove('active');
                        hamburgerBtn.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });

        // ===== API CONFIGURATION =====
        const API_CONFIG = {
            // Use current origin by default so local/staging environments fetch from the correct backend
            backend: window.location.origin,
            strava: {
                clientId: '167615',
                redirectUri: window.location.origin,
                scope: 'read,activity:read_all,profile:read_all'
            },
            oura: {
                clientId: 'RVT72X5LNV2K6GGK',
                redirectUri: window.location.origin,
                scope: 'daily'
            },
            garmin: {
                // PRODUCTION Garmin app (correct ID)
                clientId: '4af31e5c-d758-442d-a007-809ea45f444a',
                clientSecret: 'GGDcZxqPhpn4UlVihFY62rHWhY+ZNkHbLE0auOYOkrU',
                redirectUri: `${window.location.origin}/auth/garmin/callback`,
                scope: 'WELLNESS_READ'
            },
            whoop: {
                clientId: '31c6c2ac-890c-46ef-81da-b961c1cb1ca7',
                redirectUri: 'https://www.athlytx.com',
                scope: 'read:recovery read:cycles read:workout read:sleep read:profile'
            }
        };

        // ===== INSIGHT SETTINGS =====
        const INSIGHT_THRESHOLDS = {
            overreachingAvgStrain: 16,
            overreachingAvgWithDecline: 15,
            sleepAgreementLow: 60,            // % agreement cutoff
            sleepAgreementGood: 70,           // % considered good agreement
            loadUpPct: 0.30,                  // +30%
            recDownPct: -0.15,                // -15%
            workloadRatioHigh: 1.5,           // acute:chronic high
            workloadRatioLow: 0.5,            // significant reduction if prev load > 100
            sleepDebtPerfLow: 85              // Whoop sleep performance %
        };

        function getInsightWindowDays() {
            const d = parseInt(localStorage.getItem('insight_window_days') || '7', 10);
            return [7,14,28].includes(d) ? d : 7;
        }

        // ===== AUTH MODAL FUNCTIONS =====
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.body.style.overflow = ''; // Restore scrolling
        }

        function showReconnectModal() {
            const modal = document.getElementById('reconnectModal');
            if (modal) modal.style.display = 'flex';
        }

        function closeReconnectModal() {
            const modal = document.getElementById('reconnectModal');
            if (modal) modal.style.display = 'none';
        }

        function showAuthForm(formType) {
            console.log('🔄 showAuthForm called with:', formType);
            const signupForm = document.getElementById('signupFormModal');
            const loginForm = document.getElementById('loginFormModal');
            const signupTab = document.querySelector('.auth-modal-content .auth-tab:first-child');
            const loginTab = document.querySelector('.auth-modal-content .auth-tab:last-child');

            console.log('Forms found:', { signupForm: !!signupForm, loginForm: !!loginForm });

            if (!signupForm || !loginForm) {
                console.error('❌ Auth forms not found');
                return;
            }

            if (formType === 'signup') {
                signupForm.style.display = 'block';
                loginForm.style.display = 'none';
                if (signupTab) signupTab.classList.add('active');
                if (loginTab) loginTab.classList.remove('active');
            } else {
                signupForm.style.display = 'none';
                loginForm.style.display = 'block';
                if (signupTab) signupTab.classList.remove('active');
                if (loginTab) loginTab.classList.add('active');
            }

            // Hide any error messages when switching tabs
            const signupError = document.getElementById('signup-error-modal');
            const loginError = document.getElementById('login-error-modal');
            if (signupError) signupError.style.display = 'none';
            if (loginError) loginError.style.display = 'none';
        }

        // Form validation helpers
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function getPasswordStrength(password) {
            if (password.length < 8) return { strength: 'weak', message: 'Too short - minimum 8 characters required' };
            if (password.length < 10) return { strength: 'fair', message: 'Fair password - consider making it longer' };

            let strength = 0;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            if (strength >= 3 && password.length >= 12) return { strength: 'strong', message: 'Strong password!' };
            if (strength >= 2 && password.length >= 10) return { strength: 'good', message: 'Good password' };
            return { strength: 'fair', message: 'Fair password - add numbers or symbols for better security' };
        }

        function showHelper(helperId, message, type) {
            const helper = document.getElementById(helperId);
            helper.textContent = message;
            helper.style.display = 'block';
            helper.style.color = type === 'error' ? '#ef4444' :
                                 type === 'success' ? '#10b981' :
                                 type === 'warning' ? '#f59e0b' :
                                 'rgba(255,255,255,0.6)';
        }

        function hideHelper(helperId) {
            document.getElementById(helperId).style.display = 'none';
        }

        // Real-time validation for signup form
        const signupEmailInput = document.getElementById('signup-email-modal');
        const signupPasswordInput = document.getElementById('signup-password-modal');

        if (signupEmailInput) {
            signupEmailInput.addEventListener('blur', function() {
                if (this.value && !validateEmail(this.value)) {
                    showHelper('signup-email-helper', 'Please enter a valid email address', 'error');
                } else if (this.value) {
                    hideHelper('signup-email-helper');
                }
            });
        }

        if (signupPasswordInput) {
            signupPasswordInput.addEventListener('input', function() {
                if (this.value) {
                    const result = getPasswordStrength(this.value);
                    const type = result.strength === 'strong' ? 'success' :
                                 result.strength === 'good' ? 'success' :
                                 result.strength === 'fair' ? 'warning' : 'error';
                    showHelper('signup-password-helper', result.message, type);
                } else {
                    showHelper('signup-password-helper', 'Must be at least 8 characters', 'info');
                }
            });
        }

        // Handle signup form submission
        async function handleSignup(event) {
            event.preventDefault();

            const email = document.getElementById('signup-email-modal').value;
            const password = document.getElementById('signup-password-modal').value;
            const firstName = document.getElementById('signup-first-name').value.trim();
            const lastName = document.getElementById('signup-last-name').value.trim();
            const sport = document.getElementById('signup-sport').value;
            const errorDiv = document.getElementById('signup-error-modal');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            if (!firstName || !lastName) {
                errorDiv.textContent = 'First and last name are required';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate email
            if (!validateEmail(email)) {
                showHelper('signup-email-helper', 'Please enter a valid email address', 'error');
                return;
            }

            // Validate password
            if (password.length < 8) {
                showHelper('signup-password-helper', 'Password must be at least 8 characters', 'error');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Account...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        role: 'athlete',
                        firstName,
                        lastName,
                        sport,
                        name: `${firstName} ${lastName}`
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save user data
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('sessionToken', data.sessionToken);
                    localStorage.setItem('userEmail', data.user.email);
                    if (data.user.name) localStorage.setItem('userName', data.user.name);
                    // Prompt device reconnect after signup so tokens bind to this account
                    localStorage.setItem('reconnectPromptPending', '1');

                    // Close modal
                    closeAuthModal();

                    // Redirect to homepage
                    showMessage('Account created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 500);
                } else {
                    errorDiv.textContent = data.error || 'Signup failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Signup error:', error);
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('login-email-modal').value;
            const password = document.getElementById('login-password-modal').value;
            const errorDiv = document.getElementById('login-error-modal');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            // Validate email
            if (!validateEmail(email)) {
                showHelper('login-email-helper', 'Please enter a valid email address', 'error');
                return;
            }

            if (!password) {
                showHelper('login-password-helper', 'Password is required', 'error');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';
            errorDiv.style.display = 'none';
            hideHelper('login-email-helper');
            hideHelper('login-password-helper');

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save user data
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('sessionToken', data.sessionToken);
                    localStorage.setItem('userEmail', data.user.email);
                    if (data.user.name) localStorage.setItem('userName', data.user.name);

                    // Close modal
                    closeAuthModal();

                    // Redirect to homepage
                    showMessage('Logged in successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 500);
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.style.display = 'block';
                    if (data.error && data.error.includes('Invalid')) {
                        showHelper('login-password-helper', 'Invalid email or password', 'error');
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        }

        // ===== FORGOT PASSWORD FUNCTIONS =====
        function showForgotPasswordForm() {
            document.getElementById('signupFormModal').style.display = 'none';
            document.getElementById('loginFormModal').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        async function handleForgotPassword(event) {
            event.preventDefault();

            const email = document.getElementById('forgot-email').value.trim();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const successDiv = document.getElementById('forgot-success');
            const errorDiv = document.getElementById('forgot-error');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.textContent = 'Password reset link sent! Check your email.';
                    successDiv.style.display = 'block';
                    document.getElementById('forgot-email').value = '';
                } else {
                    errorDiv.textContent = data.error || 'Failed to send reset link';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Reset Link';
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const successDiv = document.getElementById('reset-success');
            const errorDiv = document.getElementById('reset-error');

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('resetToken') || urlParams.get('token');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.textContent = 'Password reset successful! Redirecting to homepage...';
                    successDiv.style.display = 'block';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    // Close modal and redirect to homepage after 2 seconds
                    setTimeout(() => {
                        closeResetPasswordModal();
                        window.location.href = '/';
                    }, 2000);
                } else {
                    errorDiv.textContent = data.error || 'Failed to reset password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Reset password error:', error);
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        }

        // Check for reset token in URL on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const resetToken = urlParams.get('resetToken') || urlParams.get('token');

            if (resetToken) {
                // Show reset password modal
                document.getElementById('resetPasswordModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('authModal');
            if (e.target === modal) {
                closeAuthModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAuthModal();
            }
        });

        // ===== UTILITY FUNCTIONS =====
        // Helper function to convert minutes to hours:minutes format
        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${Math.round(minutes)} min`;
            }
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = Math.round(minutes % 60);
            if (remainingMinutes === 0) {
                return `${hours}h`;
            }
            return `${hours}h ${remainingMinutes}min`;
        }

        // ===== GLOBAL DATA STORAGE =====
        let fitnessData = {
            strava: null,
            oura: null,
            whoop: null,
            garmin: null,
            lastUpdated: null
        };

        let charts = {};

        // ===== PKCE HELPER FUNCTIONS FOR GARMIN =====
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }
        
        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }
        
        function base64URLEncode(buffer) {
            const base64 = btoa(String.fromCharCode.apply(null, buffer));
            return base64
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // ===== DATA LOADING FUNCTIONS =====
        async function loadDashboardData() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                console.log('No userId found, skipping data load');
                return;
            }

            try {
                console.log('Loading dashboard data for userId:', userId);

                // Fetch sync status (activity counts, last sync)
                const statusResponse = await fetch(`${API_CONFIG.backend}/api/sync/status/${userId}`);
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    console.log('Sync status:', statusData);
                    displaySyncStatus(statusData);
                }

                // Fetch heart rate zone data (last 28 days)
                const zonesResponse = await fetch(`${API_CONFIG.backend}/api/sync/zones/${userId}?days=28`);
                if (zonesResponse.ok) {
                    const zonesData = await zonesResponse.json();
                    console.log('Heart rate zones:', zonesData);
                    displayZoneData(zonesData);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function displaySyncStatus(data) {
            console.log(`Found ${data.totalActivities} activities, ${data.totalZoneRecords} zone records`);

            // Update a status indicator if it exists
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = `${data.totalActivities} activities synced`;
            }
        }

        function displayZoneData(data) {
            if (!data.data || data.data.length === 0) {
                console.log('No zone data to display');
                return;
            }

            console.log(`Displaying ${data.data.length} zone records`);

            // TODO: Update charts and UI with zone data
            // For now, just log the data so user can see it's being fetched
            data.data.forEach((zone, index) => {
                if (index < 5) { // Log first 5 records
                    console.log(`Activity ${index + 1}:`, zone.activityType, zone.durationMinutes, 'mins', zone.provider);
                }
            });
        }

        // ===== DEVICE CONNECTION FUNCTIONS =====
        async function connectDevice(device) {
            const button = event.target;
            const userId = localStorage.getItem('userId');

            if (!userId) {
                showMessage('Please log in first before connecting devices', 'error');
                return;
            }

            // CRITICAL: Ensure user exists in database before OAuth
            try {
                const ensureResponse = await fetch(`${API_CONFIG.backend}/api/sync/ensure-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId
                        // email and name will be auto-generated with unique values
                    })
                });

                if (!ensureResponse.ok) {
                    const errorData = await ensureResponse.json();
                    showMessage(`Failed to initialize user: ${errorData.message || 'Unknown error'}`, 'error');
                    return;
                }

                const userData = await ensureResponse.json();
                console.log('✅ User ensured in database:', userData.userId);
            } catch (error) {
                console.error('Error ensuring user exists:', error);
                showMessage('Failed to initialize user. Please try again.', 'error');
                return;
            }

            if (device === 'strava') {
                // Encode userId in state parameter so it survives OAuth redirect
                const state = JSON.stringify({ provider: 'strava', userId: userId });
                const authUrl = `https://www.strava.com/oauth/authorize?client_id=${API_CONFIG.strava.clientId}&response_type=code&redirect_uri=${encodeURIComponent(API_CONFIG.strava.redirectUri)}&scope=${API_CONFIG.strava.scope}&state=${encodeURIComponent(state)}&approval_prompt=force`;
                window.location.href = authUrl;

            } else if (device === 'oura') {
                // Encode userId in state parameter so it survives OAuth redirect
                const state = JSON.stringify({ provider: 'oura', userId: userId });
                const authUrl = `https://cloud.ouraring.com/oauth/authorize?response_type=code&client_id=${API_CONFIG.oura.clientId}&redirect_uri=${encodeURIComponent(API_CONFIG.oura.redirectUri)}&scope=daily+workout+heartrate&state=${encodeURIComponent(state)}`;
                window.location.href = authUrl;
                
            } else if (device === 'garmin') {
                showMessage('Redirecting to Garmin for authorization...', 'info');

                // Use the GarminOAuth2 class from garmin-oauth2.js
                if (typeof GarminOAuth2 !== 'undefined') {
                    const garminOAuth = new GarminOAuth2({
                        clientId: API_CONFIG.garmin.clientId,
                        redirectUri: API_CONFIG.garmin.redirectUri,
                        scope: 'ACTIVITY_EXPORT HEALTH_EXPORT'
                    });

                    const authUrl = await garminOAuth.buildAuthorizationUrl();
                    window.location.href = authUrl;
                } else {
                    // Fallback: manual OAuth flow with proper state storage
                    const codeVerifier = generateCodeVerifier();
                    const codeChallenge = await generateCodeChallenge(codeVerifier);
                    const state = 'garmin_auth';

                    // Store both verifier AND state for token exchange
                    localStorage.setItem('garmin_code_verifier', codeVerifier);
                    sessionStorage.setItem('garmin_code_verifier', codeVerifier);
                    sessionStorage.setItem('garmin_oauth_state', state);

                    const params = new URLSearchParams({
                        client_id: API_CONFIG.garmin.clientId,
                        response_type: 'code',
                        redirect_uri: API_CONFIG.garmin.redirectUri,
                        scope: 'ACTIVITY_EXPORT HEALTH_EXPORT',
                        state: state,
                        code_challenge: codeChallenge,
                        code_challenge_method: 'S256'
                    });

                    const authUrl = `https://connect.garmin.com/oauth2Confirm?${params.toString()}`;
                    console.log('Attempting Garmin OAuth via correct endpoint:', authUrl);
                    window.location.href = authUrl;
                }
            } else if (device === 'whoop') {
                // This will be handled by the oauth-handler.js
                showMessage('Redirecting to Whoop for authorization...', 'info');
            }
        }

        async function disconnectDevice(device) {
            if (!confirm(`Are you sure you want to disconnect ${device.charAt(0).toUpperCase() + device.slice(1)}?`)) {
                return;
            }

            // Attempt server-side disconnect/deregistration first
            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const userId = localStorage.getItem('userId');

                if (device === 'garmin') {
                    if (sessionToken) {
                        // Authenticated user: remove DB token via devices API
                        await fetch(`${API_CONFIG.backend}/api/devices/disconnect/garmin`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${sessionToken}` }
                        });
                    } else if (userId) {
                        // Guest mode: call Garmin deregister to remove DB token
                        await fetch(`${API_CONFIG.backend}/api/garmin/deregister`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId })
                        });
                    }
                } else if (sessionToken) {
                    // Other providers (when logged in)
                    await fetch(`${API_CONFIG.backend}/api/devices/disconnect/${device}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${sessionToken}` }
                    });
                }
            } catch (e) {
                console.warn('Server-side disconnect failed or not required:', e.message);
            }

            // Clear localStorage tokens
            if (device === 'strava') {
                localStorage.removeItem('strava_token');
                localStorage.removeItem('strava_expiry');
                localStorage.removeItem('strava_refresh_token');
            } else if (device === 'oura') {
                localStorage.removeItem('oura_token');
                localStorage.removeItem('oura_expiry');
            } else if (device === 'garmin') {
                localStorage.removeItem('garmin_token');
                localStorage.removeItem('garmin_expiry');
                localStorage.removeItem('garmin_refresh_token');
                localStorage.removeItem('garmin_access_token');
                localStorage.removeItem('garmin_token_expires_at');
            } else if (device === 'whoop') {
                localStorage.removeItem('whoop_token');
                localStorage.removeItem('whoop_access_token');
                localStorage.removeItem('whoop_expiry');
                localStorage.removeItem('whoop_token_expires_at');
                localStorage.removeItem('whoop_access_token_expires_at');
                localStorage.removeItem('whoop_refresh_token');
            }

            // Update button visibility
            const connectBtn = document.querySelector(`.btn-${device}`);
            const disconnectBtn = document.querySelector(`.btn-${device}-disconnect`);

            if (connectBtn) {
                connectBtn.innerHTML = `Connect ${device.charAt(0).toUpperCase() + device.slice(1)}`;
                connectBtn.disabled = false;
                connectBtn.style.display = 'flex';
            }

            if (disconnectBtn) {
                disconnectBtn.style.display = 'none';
            }

            showMessage(`${device.charAt(0).toUpperCase() + device.slice(1)} disconnected`, 'info');

            // Reload page to clear data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }

        // ===== LOGOUT FUNCTION =====
        async function handleLogout() {
            const sessionToken = localStorage.getItem('sessionToken');

            // Call logout API
            if (sessionToken) {
                try {
                    await fetch(`${API_CONFIG.backend}/api/auth/logout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionToken })
                    });
                } catch (error) {
                    console.error('Logout API error:', error);
                }
            }

            // Clear all user data from localStorage
            localStorage.removeItem('sessionToken');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            localStorage.removeItem('userId');

            // Update UI to show guest view
            document.getElementById('guestView').style.display = 'block';
            document.getElementById('authenticatedView').style.display = 'none';

            // Reset Account tab text
            const accountTabText = document.getElementById('accountTabText');
            if (accountTabText) {
                accountTabText.textContent = 'Account';
            }

            showMessage('Logged out successfully', 'success');
        }

        // ===== AUTHENTICATION STATUS CHECK =====
        // Load and display connected services
        async function loadConnectedServices(sessionToken) {
            const servicesSpan = document.getElementById('connected-services');
            try {
                const response = await fetch(`${API_CONFIG.backend}/api/devices/connected`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.connected && data.connected.length > 0) {
                        const services = data.connected.map(s => {
                            const emoji = s.provider === 'strava' ? '🚴' :
                                         s.provider === 'garmin' ? '⌚' :
                                         s.provider === 'oura' ? '💍' :
                                         s.provider === 'whoop' ? '💪' : '🔗';
                            const status = s.status === 'expired' ? ' (expired)' : '';
                            return `${emoji} ${s.provider.charAt(0).toUpperCase() + s.provider.slice(1)}${status}`;
                        }).join(', ');
                        servicesSpan.textContent = services;

                        // Update Account page UI elements
                        const connectedCount = document.getElementById('connected-count');
                        if (connectedCount) {
                            connectedCount.textContent = data.connected.length;
                        }

                        // Update service cards with connection status
                        const connectedProviders = new Set(data.connected.map(s => s.provider.toLowerCase()));

                        const serviceCards = {
                            'strava': document.getElementById('service-strava'),
                            'oura': document.getElementById('service-oura'),
                            'garmin': document.getElementById('service-garmin'),
                            'whoop': document.getElementById('service-whoop')
                        };

                        Object.keys(serviceCards).forEach(provider => {
                            const card = serviceCards[provider];
                            if (card) {
                                const isConnected = connectedProviders.has(provider);
                                const statusText = card.querySelector('.service-status');
                                const indicator = card.querySelector('.service-indicator');

                                if (isConnected) {
                                    card.classList.remove('service-disconnected');
                                    card.classList.add('service-connected');
                                    if (statusText) statusText.textContent = 'Connected';
                                    if (indicator) indicator.style.background = '#10b981';
                                } else {
                                    card.classList.add('service-disconnected');
                                    card.classList.remove('service-connected');
                                    if (statusText) statusText.textContent = 'Not connected';
                                    if (indicator) indicator.style.background = 'rgba(148,163,184,0.5)';
                                }
                            }
                        });

                        // Update last sync time (use most recent connection)
                        const lastSyncDisplay = document.getElementById('last-sync-display');
                        if (lastSyncDisplay && data.connected.length > 0) {
                            const mostRecent = data.connected.reduce((latest, current) => {
                                const currentDate = current.lastSync ? new Date(current.lastSync) : new Date(0);
                                const latestDate = latest.lastSync ? new Date(latest.lastSync) : new Date(0);
                                return currentDate > latestDate ? current : latest;
                            });

                            if (mostRecent.lastSync) {
                                const syncDate = new Date(mostRecent.lastSync);
                                const now = new Date();
                                const diffMinutes = Math.floor((now - syncDate) / 60000);

                                if (diffMinutes < 1) {
                                    lastSyncDisplay.textContent = 'Just now';
                                } else if (diffMinutes < 60) {
                                    lastSyncDisplay.textContent = `${diffMinutes}m ago`;
                                } else if (diffMinutes < 1440) {
                                    lastSyncDisplay.textContent = `${Math.floor(diffMinutes / 60)}h ago`;
                                } else {
                                    lastSyncDisplay.textContent = `${Math.floor(diffMinutes / 1440)}d ago`;
                                }
                            }
                        }
                    } else {
                        servicesSpan.textContent = 'None';
                        const connectedCount = document.getElementById('connected-count');
                        if (connectedCount) connectedCount.textContent = '0';
                    }
                } else {
                    servicesSpan.textContent = 'Unable to load';
                }
            } catch (error) {
                console.error('Failed to load connected services:', error);
                servicesSpan.textContent = 'Error loading';
            }
        }

        function checkAuthenticationStatus() {
            const sessionToken = localStorage.getItem('sessionToken');
            const userEmail = localStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName');
            const userId = localStorage.getItem('userId');

            if (sessionToken && userEmail) {
                // User is logged in - show authenticated view
                document.getElementById('guestView').style.display = 'none';
                document.getElementById('authenticatedView').style.display = 'block';
                document.getElementById('user-email').textContent = userEmail;
                document.getElementById('user-name').textContent = userName || 'Not set';
                document.getElementById('user-id').textContent = userId || 'N/A';

                // Update Account tab text to show user's name or email
                const accountTabText = document.getElementById('accountTabText');
                if (accountTabText) {
                    accountTabText.textContent = userName || userEmail.split('@')[0];
                }

                // Populate new Account page UI elements
                const userNameDisplay = document.getElementById('user-name-display');
                const userEmailDisplay = document.getElementById('user-email-display');
                const userIdDisplay = document.getElementById('user-id-display');
                const userAvatarContainer = document.getElementById('user-avatar-container');

                if (userNameDisplay) userNameDisplay.textContent = userName || userEmail.split('@')[0];
                if (userEmailDisplay) userEmailDisplay.textContent = userEmail;
                if (userIdDisplay) userIdDisplay.textContent = userId || 'N/A';

                // Generate user initials for avatar
                if (userAvatarContainer) {
                    let initials = '';
                    if (userName && userName !== 'Not set') {
                        const nameParts = userName.trim().split(' ');
                        if (nameParts.length >= 2) {
                            initials = nameParts[0][0] + nameParts[nameParts.length - 1][0];
                        } else {
                            initials = nameParts[0].substring(0, 2);
                        }
                    } else {
                        initials = userEmail.substring(0, 2);
                    }
                    userAvatarContainer.textContent = initials.toUpperCase();
                }

                // Load connected services
                loadConnectedServices(sessionToken);

                // If user just signed up, prompt reconnect of devices
                if (localStorage.getItem('reconnectPromptPending') === '1') {
                    localStorage.removeItem('reconnectPromptPending');
                    showReconnectModal();
                }
            } else {
                // User is not logged in - show guest view
                document.getElementById('guestView').style.display = 'block';
                document.getElementById('authenticatedView').style.display = 'none';
            }
        }

        // ===== OAUTH CALLBACK HANDLING =====
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            
            // Check for OAuth errors
            if (error) {
                console.error('OAuth error:', error, urlParams.get('error_description'));
                showMessage(`Authentication failed: ${error}`, 'error');
                sessionStorage.removeItem('processed_oauth_code');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Check for Garmin ticket accumulation (sign of redirect loop)
            const tickets = urlParams.toString().match(/ticket=/g);
            if (tickets && tickets.length > 1) {
                console.error('Garmin redirect loop detected - multiple tickets found');
                showMessage('Garmin Connect authorization failed - please try again', 'error');
                sessionStorage.removeItem('processed_oauth_code');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Prevent processing the same code twice
            const processedCode = sessionStorage.getItem('processed_oauth_code');
            if (code && code === processedCode) {
                console.log('OAuth code already processed, skipping');
                return;
            }

            // Parse state parameter (could be JSON or legacy string)
            let stateData = null;
            let oauthProvider = null;
            let userIdFromState = null;

            if (state) {
                try {
                    // Try parsing as JSON first (new format)
                    stateData = JSON.parse(decodeURIComponent(state));
                    oauthProvider = stateData.provider;
                    userIdFromState = stateData.userId;
                } catch (e) {
                    // Legacy format: "strava_auth", "oura_auth", etc.
                    if (state === 'strava_auth') oauthProvider = 'strava';
                    else if (state === 'oura_auth') oauthProvider = 'oura';
                    else if (state === 'garmin_auth') oauthProvider = 'garmin';
                }
            }

            if (code && oauthProvider === 'strava') {
                sessionStorage.setItem('processed_oauth_code', code);
                handleStravaCallback(code, userIdFromState);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (code && oauthProvider === 'oura') {
                sessionStorage.setItem('processed_oauth_code', code);
                handleOuraCallback(code, userIdFromState);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (code && oauthProvider === 'garmin') {
                // Handle Garmin OAuth 2.0 callback (legacy direct callback)
                console.log('Processing Garmin callback with code:', code);
                sessionStorage.setItem('processed_oauth_code', code);
                handleGarminCallback(code);
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Handle clean URL Garmin callback (from server-side redirect)
            const garminCode = urlParams.get('garmin_code');
            const garminState = urlParams.get('garmin_state');
            const provider = urlParams.get('provider');

            if (provider === 'garmin' && garminCode && garminState) {
                console.log('Processing Garmin callback (clean URL) with code:', garminCode);
                sessionStorage.setItem('processed_oauth_code', garminCode);

                // Call handleGarminCallback with the code
                // We need to temporarily set the state for validation
                const originalState = sessionStorage.getItem('garmin_oauth_state') || garminState;
                sessionStorage.setItem('garmin_oauth_state', originalState);

                handleGarminCallback(garminCode);

                // Clean up URL completely
                window.history.replaceState({}, document.title, '/');
            }

            // Check if user is logged in and update Account tab
            checkAuthenticationStatus();

            // MOBILE: Move tabs below Connections on mobile devices
            function handleTabPositionForMobile() {
                const tabNav = document.querySelector('.tab-nav-wrapper');
                const connectionsTab = document.getElementById('connections');
                const isMobile = window.innerWidth < 768;

                if (isMobile && tabNav && connectionsTab) {
                    // Insert tabs as first child of connections tab content
                    connectionsTab.insertBefore(tabNav, connectionsTab.firstChild);
                    tabNav.style.marginBottom = '24px';
                } else if (!isMobile && tabNav) {
                    // On desktop, move tabs back to top (before #dashboard)
                    const dashboard = document.getElementById('dashboard');
                    if (dashboard && dashboard.previousElementSibling !== tabNav) {
                        dashboard.parentNode.insertBefore(tabNav, dashboard);
                    }
                    tabNav.style.marginBottom = '';
                }
            }

            // Run on load and resize
            handleTabPositionForMobile();
            window.addEventListener('resize', handleTabPositionForMobile);

            // Add small delay to ensure Chart.js is loaded
            setTimeout(() => {
                console.log('🚀 Page initialization started');
                initializeCharts();
                loadExistingConnections();
                updateConnectionStatus();
                // Also update analytics/displays after a brief delay to ensure data is loaded
                setTimeout(() => {
                    console.log('🚀 Delayed updateAnalytics() being called from page load...');
                    updateAnalytics();
                    console.log('🚀 Delayed updateAnalytics() completed');
                }, 500);
            }, 100);
        });

        // ===== TOKEN MANAGEMENT =====
        async function saveTokenToDatabase(provider, accessToken, refreshToken = null, expiresAt = null, providerUserId = null) {
            try {
                // Get userId from localStorage - this ensures we always use the same user
                const userId = localStorage.getItem('userId');

                const response = await fetch(`${API_CONFIG.backend}/api/sync/save-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId, // Pass userId to ensure tokens are saved to correct user
                        provider,
                        accessToken,
                        refreshToken,
                        expiresAt,
                        providerUserId // Garmin GUID for mapping Health API push data
                    })
                });

                if (!response.ok) {
                    console.error('Failed to save token to database:', await response.text());
                    return false;
                }

                const result = await response.json();
                console.log(`✅ Token saved to database for ${provider}:`, result);

                // Store the userId returned from backend (in case it was created)
                if (result.userId) {
                    localStorage.setItem('userId', result.userId);
                }

                return true;
            } catch (error) {
                console.error('Error saving token to database:', error);
                return false;
            }
        }

        // ===== CONNECTION MANAGEMENT =====
        async function loadExistingConnections() {
            console.log('🔍 Loading existing connections...');

            // FIRST: Try to load tokens from database (persistent across sessions)
            const userId = localStorage.getItem('userId');
            if (userId) {
                try {
                    console.log('📦 Loading tokens from database for user:', userId);
                    const response = await fetch(`${API_CONFIG.backend}/api/user/tokens?userId=${userId}`);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ Loaded tokens from database:', Object.keys(data.tokens));

                        // Store database tokens in localStorage for quick access
                        for (const [provider, tokenData] of Object.entries(data.tokens)) {
                            localStorage.setItem(`${provider}_token`, tokenData.access_token);
                            if (tokenData.refresh_token) {
                                localStorage.setItem(`${provider}_refresh_token`, tokenData.refresh_token);
                            }
                            if (tokenData.expiry) {
                                localStorage.setItem(`${provider}_expiry`, tokenData.expiry);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load tokens from database:', error.message);
                    console.log('   Falling back to localStorage tokens');
                }
            }

            // Now check localStorage for tokens (either from DB or previously stored)
            const stravaToken = localStorage.getItem('strava_token');
            const ouraToken = localStorage.getItem('oura_token');
            const garminToken = localStorage.getItem('garmin_token');
            const whoopToken = localStorage.getItem('whoop_token');
            const garminTokenSecret = localStorage.getItem('garmin_token_secret');
            const stravaExpiry = localStorage.getItem('strava_expiry');
            const ouraExpiry = localStorage.getItem('oura_expiry');
            const garminExpiry = localStorage.getItem('garmin_expiry');
            const whoopExpiry = localStorage.getItem('whoop_expiry');

            const now = Date.now();

            console.log('🔑 Found tokens:', {
                strava: !!stravaToken,
                oura: !!ouraToken,
                garmin: !!garminToken,
                whoop: !!whoopToken
            });
            
            // Check Strava token - load from database instead of API
            if (stravaToken && (!stravaExpiry || now < parseInt(stravaExpiry))) {
                fetchStravaDataFromDB();
            } else if (stravaToken && stravaExpiry && now >= parseInt(stravaExpiry)) {
                console.log(' Strava token expired, attempting to refresh...');
                const refreshToken = localStorage.getItem('strava_refresh_token');
                if (refreshToken) {
                    refreshStravaToken(refreshToken);
                } else {
                    console.log(' No Strava refresh token available, clearing...');
                    localStorage.removeItem('strava_token');
                    localStorage.removeItem('strava_expiry');
                }
            }

            // Check Oura token
            if (ouraToken && (!ouraExpiry || now < parseInt(ouraExpiry))) {
                fetchOuraData(ouraToken);
            } else if (ouraToken && ouraExpiry && now >= parseInt(ouraExpiry)) {
                console.log(' Oura token expired, attempting to refresh...');
                const refreshToken = localStorage.getItem('oura_refresh_token');
                if (refreshToken) {
                    refreshOuraToken(refreshToken);
                } else {
                    console.log(' No Oura refresh token available, clearing...');
                    localStorage.removeItem('oura_token');
                    localStorage.removeItem('oura_expiry');
                }
            }

            // Check Garmin OAuth 2.0 token
            if (garminToken && (!garminExpiry || now < parseInt(garminExpiry))) {
                fetchGarminData();
            } else if (garminToken && garminExpiry && now >= parseInt(garminExpiry)) {
                console.log(' Garmin token expired, attempting to refresh...');
                const refreshToken = localStorage.getItem('garmin_refresh_token');
                if (refreshToken) {
                    refreshGarminToken(refreshToken);
                } else {
                    console.log(' No Garmin refresh token available, clearing...');
                    localStorage.removeItem('garmin_token');
                    localStorage.removeItem('garmin_expiry');
                }
            }

            // Check Whoop OAuth 2.0 token
            if (whoopToken && (!whoopExpiry || now < parseInt(whoopExpiry))) {
                console.log(' Found valid Whoop token, fetching data...');
                fetchWhoopData(whoopToken);
            } else if (whoopToken && whoopExpiry && now >= parseInt(whoopExpiry)) {
                console.log(' Whoop token expired, attempting to refresh...');
                const refreshToken = localStorage.getItem('whoop_refresh_token');
                if (refreshToken) {
                    refreshWhoopToken(refreshToken);
                } else {
                    console.log(' No refresh token available, clearing...');
                    localStorage.removeItem('whoop_token');
                    localStorage.removeItem('whoop_expiry');
                }
            }
        }

        async function handleStravaCallback(code, userIdFromState) {
            try {
                showMessage('Processing Strava authorization...', 'info');

                // Use userId from state parameter (passed during OAuth), fallback to localStorage
                const userId = userIdFromState || localStorage.getItem('userId');

                if (!userId) {
                    throw new Error('User ID not available. Please log in again.');
                }

                const response = await fetch(`${API_CONFIG.backend}/api/strava/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        userId: userId  // CRITICAL: Required for database persistence
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.access_token) {
                    localStorage.setItem('strava_token', data.access_token);
                    if (data.expires_at) {
                        localStorage.setItem('strava_expiry', data.expires_at * 1000);
                    }

                    // Save to database
                    await saveTokenToDatabase(
                        'strava',
                        data.access_token,
                        data.refresh_token,
                        data.expires_at ? new Date(data.expires_at * 1000).toISOString() : null
                    );

                    await fetchStravaData(data.access_token);
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (error) {
                console.error('Strava callback error:', error);
                showMessage(`Strava connection failed: ${error.message}`, 'error');
                
                const button = document.querySelector('.btn-strava');
                button.innerHTML = 'Connect Strava';
                button.disabled = false;
            }
        }

        async function handleOuraCallback(code, userIdFromState) {
            try {
                showMessage('Processing Oura authorization...', 'info');

                // Use userId from state parameter (passed during OAuth), fallback to localStorage
                const userId = userIdFromState || localStorage.getItem('userId');

                if (!userId) {
                    throw new Error('User ID not available. Please log in again.');
                }

                const response = await fetch(`${API_CONFIG.backend}/api/oura/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        userId: userId  // CRITICAL: Required for database persistence
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Backend error: ${response.status} - ${errorData.error || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (data.access_token) {
                    localStorage.setItem('oura_token', data.access_token);
                    let expiryTime = null;
                    if (data.expires_in) {
                        expiryTime = Date.now() + (data.expires_in * 1000);
                        localStorage.setItem('oura_expiry', expiryTime);
                    }

                    // Save to database
                    await saveTokenToDatabase(
                        'oura',
                        data.access_token,
                        data.refresh_token,
                        expiryTime ? new Date(expiryTime).toISOString() : null
                    );

                    await fetchOuraData(data.access_token);
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (error) {
                console.error('Oura callback error:', error);
                showMessage(`Oura connection failed: ${error.message}`, 'error');
                
                const button = document.querySelector('.btn-oura');
                button.innerHTML = 'Connect Oura';
                button.disabled = false;
            }
        }

        // Garmin OAuth 2.0 callback handler with PKCE
        async function handleGarminCallback(code) {
            try {
                showMessage('Processing Garmin Connect authorization...', 'info');
                console.log('Garmin auth code received:', code);
                
                // Get the PKCE verifier (try localStorage first for mobile compatibility)
                const codeVerifier = localStorage.getItem('garmin_code_verifier') || sessionStorage.getItem('garmin_code_verifier');
                
                // Your backend should exchange the code with Garmin's token endpoint
                const userId = localStorage.getItem('userId');
                const response = await fetch(`${API_CONFIG.backend}/api/garmin/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code,
                        client_id: API_CONFIG.garmin.clientId,
                        redirect_uri: API_CONFIG.garmin.redirectUri,
                        code_verifier: codeVerifier,  // PKCE verifier for OAuth 2.0
                        userId: userId  // CRITICAL: Required for database persistence
                    })
                });

                console.log('Token exchange response:', response.status);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Backend error response:', errorText);
                    throw new Error(`Backend error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.access_token) {
                    // Store Garmin OAuth 2.0 token
                    localStorage.setItem('garmin_token', data.access_token);
                    let expiryTime = null;
                    if (data.refresh_token) {
                        localStorage.setItem('garmin_refresh_token', data.refresh_token);
                    }
                    if (data.expires_in) {
                        expiryTime = Date.now() + (data.expires_in * 1000);
                        localStorage.setItem('garmin_expiry', expiryTime);
                    }

                    // Extract Garmin User ID
                    let garminUserId = null;

                    // First, try to get it from the backend response (from User ID endpoint)
                    if (data.garminUserId) {
                        garminUserId = data.garminUserId;
                        console.log(' Got Garmin User ID from backend:', garminUserId);
                    } else {
                        // Fallback: Try to extract from JWT token
                        try {
                            const payload = JSON.parse(atob(data.access_token.split('.')[1]));
                            console.log(' Full JWT payload:', JSON.stringify(payload, null, 2));

                            // Try multiple possible field names for Garmin user ID
                            garminUserId = payload.garmin_guid || payload.user_id || payload.sub || payload.userId;

                            console.log(' Extracted Garmin User ID from JWT:', garminUserId);
                            console.log('Available fields in token:', Object.keys(payload));
                        } catch (e) {
                            console.warn('  Could not extract Garmin User ID from token:', e);
                        }
                    }

                    // Save to database with Garmin User ID
                    await saveTokenToDatabase(
                        'garmin',
                        data.access_token,
                        data.refresh_token,
                        expiryTime ? new Date(expiryTime).toISOString() : null,
                        garminUserId
                    );

                    // Clean up PKCE verifier from both storages
                    localStorage.removeItem('garmin_code_verifier');
                    sessionStorage.removeItem('garmin_code_verifier');
                    
                    showMessage('Garmin connected successfully!', 'success');
                    await fetchGarminData(data.access_token);
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (error) {
                console.error('Garmin callback error:', error);
                showMessage(`Failed to connect Garmin: ${error.message}`, 'error');
            }
        }

        // Enhanced error handling with retry logic
        async function fetchWithRetry(url, options = {}, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        // Handle specific error codes
                        if (response.status === 401) {
                            throw new Error('Authentication expired. Please reconnect.');
                        } else if (response.status === 429) {
                            // Rate limiting - wait before retry
                            const retryAfter = response.headers.get('Retry-After') || (i + 1) * 5;
                            showMessage(`Rate limited. Retrying in ${retryAfter} seconds...`, 'warning');
                            await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                            continue;
                        } else if (response.status >= 500) {
                            throw new Error(`Server error (${response.status}). Please try again later.`);
                        }
                        throw new Error(`Request failed: ${response.status}`);
                    }
                    
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    
                    // Network errors - exponential backoff
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        const delay = Math.min(1000 * Math.pow(2, i), 10000);
                        showMessage(`Network error. Retrying in ${delay/1000}s...`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        // Enhanced data fetching with better error handling
        async function fetchStravaData(token) {
            const button = document.querySelector('.btn-strava');
            
            try {
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
                button.disabled = true;
                
                const [athleteResponse, activitiesResponse] = await Promise.all([
                    fetchWithRetry(`${API_CONFIG.backend}/api/strava/athlete?token=${token}`),
                    fetchWithRetry(`${API_CONFIG.backend}/api/strava/activities?token=${token}`)
                ]);

                const athlete = await athleteResponse.json();
                const activitiesData = await activitiesResponse.json();

                // Validate response data
                if (!athlete || typeof athlete !== 'object') {
                    throw new Error('Invalid athlete data received');
                }

                fitnessData.strava = {
                    athlete,
                    activities: Array.isArray(activitiesData.activities) ? activitiesData.activities : [],
                    lastUpdated: new Date().toISOString()
                };

                button.innerHTML = `✅ ${athlete.firstname || 'Strava'} - Connected`;
                button.disabled = false;

                // Show disconnect button
                const disconnectBtn = document.querySelector('.btn-strava-disconnect');
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }

                showMessage(`Strava connected! Found ${fitnessData.strava.activities.length} activities`, 'success');
                updateAnalytics();
                updateConnectionStatus();

            } catch (error) {
                console.error('Error fetching Strava data:', error);
                
                // Handle specific errors
                if (error.message.includes('Authentication expired')) {
                    localStorage.removeItem('strava_token');
                    localStorage.removeItem('strava_expiry');
                    button.innerHTML = 'Connect Strava';
                    showMessage('Strava authentication expired. Please reconnect.', 'error');
                } else if (error.message.includes('Network')) {
                    button.innerHTML = '⚠️ Retry Strava';
                    showMessage('Network issue. Check your connection and try again.', 'error');
                } else {
                    button.innerHTML = '❌ Strava Error';
                    showMessage(`Strava error: ${error.message}`, 'error');
                }
                
                button.disabled = false;
                
                // Set partial data to prevent null errors
                if (!fitnessData.strava) {
                    fitnessData.strava = {
                        athlete: null,
                        activities: [],
                        error: error.message,
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
        }

        // Fetch Strava data from database (used when already synced)
        async function fetchStravaDataFromDB() {
            const button = document.querySelector('.btn-strava');

            try {
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
                button.disabled = true;

                const userId = localStorage.getItem('userId');
                console.log('🔍 DEBUG fetchStravaDataFromDB: localStorage userId:', userId);
                console.log('🔍 DEBUG: All localStorage keys:', Object.keys(localStorage));

                if (!userId) {
                    throw new Error('User ID not available');
                }

                console.log('📡 Fetching Strava data from database for user:', userId);

                const [athleteResponse, activitiesResponse] = await Promise.allSettled([
                    fetch(`${API_CONFIG.backend}/api/strava/athlete?token=${localStorage.getItem('strava_token')}`),
                    fetch(`${API_CONFIG.backend}/api/strava/db/activities?userId=${userId}`)
                ]);

                let athlete = null;
                let activities = [];

                // Get athlete info from API (lightweight call)
                if (athleteResponse.status === 'fulfilled' && athleteResponse.value.ok) {
                    athlete = await athleteResponse.value.json();
                }

                // Get activities from database
                if (activitiesResponse.status === 'fulfilled' && activitiesResponse.value.ok) {
                    const data = await activitiesResponse.value.json();
                    activities = data.activities || [];
                    console.log('✅ Loaded', activities.length, 'Strava activities from database');
                }

                fitnessData.strava = {
                    athlete,
                    activities: activities,
                    lastUpdated: new Date().toISOString()
                };

                button.innerHTML = `✅ ${athlete?.firstname || 'Strava'} - Connected`;
                button.disabled = false;

                // Show disconnect button
                const disconnectBtn = document.querySelector('.btn-strava-disconnect');
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }

                showMessage(`Strava connected! Found ${activities.length} activities`, 'success');
                updateAnalytics();
                updateConnectionStatus();

            } catch (error) {
                console.error('Error fetching Strava data from database:', error);

                button.innerHTML = '❌ Strava Error';
                button.disabled = false;

                showMessage(`Strava error: ${error.message}`, 'error');

                // Set partial data to prevent null errors
                if (!fitnessData.strava) {
                    fitnessData.strava = {
                        athlete: null,
                        activities: [],
                        error: error.message,
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
        }

        async function fetchOuraData(token) {
            const button = document.querySelector('.btn-oura');
            
            try {
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
                button.disabled = true;
                
                const today = new Date();
                const startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const endDate = today.toISOString().split('T')[0];

                const [personalResponse, sleepResponse, readinessResponse, activityResponse] = await Promise.allSettled([
                    fetchWithRetry(`${API_CONFIG.backend}/api/oura/personal?token=${token}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/oura/sleep?token=${token}&start_date=${startDate}&end_date=${endDate}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/oura/readiness?token=${token}&start_date=${startDate}&end_date=${endDate}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/oura/activity?token=${token}&start_date=${startDate}&end_date=${endDate}`).catch(e => ({ ok: false, error: e }))
                ]);

                let personal = null, sleep = null, readiness = null, activity = null;
                let hasAnyData = false;

                // Process responses with validation
                if (personalResponse.status === 'fulfilled' && personalResponse.value.ok) {
                    const data = await personalResponse.value.json();
                    if (data && typeof data === 'object') {
                        personal = data;
                        hasAnyData = true;
                    }
                }

                if (sleepResponse.status === 'fulfilled' && sleepResponse.value.ok) {
                    const data = await sleepResponse.value.json();
                    if (data && Array.isArray(data.data)) {
                        sleep = data; // accept even if data.data is empty
                        hasAnyData = hasAnyData || data.data.length > 0;
                    }
                }

                if (readinessResponse.status === 'fulfilled' && readinessResponse.value.ok) {
                    const data = await readinessResponse.value.json();
                    if (data && Array.isArray(data.data)) {
                        readiness = data; // accept even if empty
                        hasAnyData = hasAnyData || data.data.length > 0;
                    }
                }

                if (activityResponse.status === 'fulfilled' && activityResponse.value.ok) {
                    const data = await activityResponse.value.json();
                    if (data && Array.isArray(data.data)) {
                        activity = data; // accept even if empty
                        hasAnyData = hasAnyData || data.data.length > 0;
                    }
                }

                // Don't throw if arrays are empty; display the UI with "no data" state

                fitnessData.oura = {
                    personal: personal || { email: 'oura.user@athlytx.com' },
                    sleep: sleep?.data || [],
                    readiness: readiness?.data || [],
                    activity: activity?.data || [],
                    lastUpdated: new Date().toISOString()
                };

                const userEmail = personal?.email || 'Oura User';
                button.innerHTML = `✅ ${userEmail.split('@')[0]} - Connected`;
                button.disabled = false;

                // Show disconnect button
                const disconnectBtn = document.querySelector('.btn-oura-disconnect');
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }

                // Hide reconnect button if present
                const rc = document.querySelector('.btn-oura-reconnect');
                if (rc) rc.style.display = 'none';

                const totalRecords = (sleep?.data?.length || 0) + (readiness?.data?.length || 0) + (activity?.data?.length || 0);
                showMessage(`Oura connected! ${totalRecords} records loaded`, 'success');
                
                updateAnalytics();
                updateConnectionStatus();

            } catch (error) {
                console.error('Error fetching Oura data:', error);
                
                // Handle specific errors
                if (error.message.includes('Authentication expired')) {
                    localStorage.removeItem('oura_token');
                    localStorage.removeItem('oura_expiry');
                    button.innerHTML = 'Connect Oura';
                    showMessage('Oura authentication expired. Please reconnect.', 'error');
                } else if (error.message.includes('No data available')) {
                    button.innerHTML = '⏳ Oura Syncing';
                    showMessage('Oura is syncing. Please try again in a few minutes.', 'warning');
                } else {
                    button.innerHTML = '❌ Oura Error';
                    showMessage(`Oura error: ${error.message}`, 'error');
                }
                
                button.disabled = false;

                // Show reconnect button
                const rc = document.querySelector('.btn-oura-reconnect');
                if (rc) rc.style.display = 'inline-block';
                
                // Set partial data to prevent null errors
                if (!fitnessData.oura) {
                    fitnessData.oura = {
                        personal: { email: 'oura.user@athlytx.com' },
                        sleep: [],
                        readiness: [],
                        activity: [],
                        error: error.message,
                        lastUpdated: new Date().toISOString()
                    };
                }
            }
        }

        // Safe data update functions with null checks
        function updateStravaData() {
            if (!fitnessData.strava || !fitnessData.strava.activities) {
                // Show empty state
                document.getElementById('stravaActivities').textContent = '--';
                document.getElementById('stravaDistance').textContent = '--';
                document.getElementById('stravaLoad').textContent = '--';
                document.getElementById('stravaAvgPower').textContent = '--';

                const activitiesList = document.getElementById('stravaActivitiesList');
                if (activitiesList) {
                    activitiesList.innerHTML = '<div class="error-state">Unable to load Strava data. Please check your connection.</div>';
                }

                // Hide athlete info card
                const athleteInfo = document.getElementById('stravaAthleteInfo');
                if (athleteInfo) athleteInfo.style.display = 'none';

                return;
            }

            // Get selected period from dropdown (default 7 days)
            const periodSelector = document.getElementById('stravaPeriodSelector');
            const selectedDays = periodSelector ? parseInt(periodSelector.value) : 7;

            const periodStart = new Date();
            periodStart.setDate(periodStart.getDate() - selectedDays);

            const recentActivities = fitnessData.strava.activities.filter(a =>
                a && a.start_date && new Date(a.start_date) >= periodStart
            );

            const allActivities = fitnessData.strava.activities;

            // Update athlete info if available
            if (fitnessData.strava.athlete) {
                const athlete = fitnessData.strava.athlete;
                const athleteInfo = document.getElementById('stravaAthleteInfo');

                if (athleteInfo) {
                    athleteInfo.style.display = 'block';

                    const avatar = document.getElementById('stravaAthleteAvatar');
                    if (avatar && athlete.profile) avatar.src = athlete.profile;

                    const name = document.getElementById('stravaAthleteName');
                    if (name) {
                        const fullName = `${athlete.firstname || ''} ${athlete.lastname || ''}`.trim() || 'Strava Athlete';
                        name.textContent = fullName;
                    }

                    const location = document.getElementById('stravaAthleteLocation');
                    if (location) {
                        const loc = [];
                        if (athlete.city) loc.push(athlete.city);
                        if (athlete.state) loc.push(athlete.state);
                        if (athlete.country) loc.push(athlete.country);
                        location.textContent = loc.join(', ') || 'Location not specified';
                    }

                    const followers = document.getElementById('stravaFollowerCount');
                    if (followers) followers.textContent = athlete.follower_count || 0;

                    const friends = document.getElementById('stravaFriendCount');
                    if (friends) friends.textContent = athlete.friend_count || 0;
                }
            }

            // Update summary cards
            document.getElementById('stravaActivities').textContent = recentActivities.length;

            const totalDistance = recentActivities.reduce((sum, a) => sum + (a.distance || 0), 0);
            document.getElementById('stravaDistance').textContent = `${Math.round(totalDistance / 1000)}km`;

            const totalLoad = recentActivities.reduce((sum, a) => sum + (a.suffer_score || 0), 0);
            document.getElementById('stravaLoad').textContent = totalLoad;

            const validPowerActivities = recentActivities.filter(a => a.average_watts > 0);
            const avgPower = validPowerActivities.length > 0 ?
                validPowerActivities.reduce((sum, a) => sum + a.average_watts, 0) / validPowerActivities.length : 0;
            document.getElementById('stravaAvgPower').textContent = avgPower > 0 ? `${Math.round(avgPower)}W` : '--';

            // New metrics
            const totalElevation = recentActivities.reduce((sum, a) => sum + (a.total_elevation_gain || 0), 0);
            document.getElementById('stravaElevation').textContent = `${Math.round(totalElevation)}m`;

            const totalMovingTime = recentActivities.reduce((sum, a) => sum + (a.moving_time || 0), 0);
            const hours = Math.floor(totalMovingTime / 3600);
            const minutes = Math.floor((totalMovingTime % 3600) / 60);
            document.getElementById('stravaMovingTime').textContent = `${hours}h ${minutes}m`;

            // Update comprehensive activities list with ALL available data
            const activitiesList = document.getElementById('stravaActivitiesList');
            if (activitiesList) {
                if (allActivities.length > 0) {
                    // Define a 7-day window for recent highlighting
                    const lastWeek = new Date();
                    lastWeek.setDate(lastWeek.getDate() - 7);
                    // Helper function to format duration
                    const formatDuration = (seconds) => {
                        if (!seconds) return '--';
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
                    };

                    // Helper function to format speed/pace
                    const formatPace = (distanceMeters, seconds) => {
                        if (!distanceMeters || !seconds) return '--';
                        const kmh = (distanceMeters / 1000) / (seconds / 3600);
                        return `${kmh.toFixed(1)} km/h`;
                    };

                    activitiesList.innerHTML = `
                        <div style="margin-bottom: 12px; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                            Showing all ${allActivities.length} activities (most recent first)
                        </div>
                        <div style="max-height: 500px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                            <table style="width: 100%; font-size: 0.85rem; border-collapse: collapse;">
                                <thead style="position: sticky; top: 0; background: rgba(10,14,39,0.95); backdrop-filter: blur(10px); z-index: 10;">
                                    <tr style="border-bottom: 2px solid rgba(102,126,234,0.3);">
                                        <th style="text-align: left; padding: 10px 8px; font-weight: 600;">Date</th>
                                        <th style="text-align: left; padding: 10px 8px; font-weight: 600;">Activity Name</th>
                                        <th style="text-align: center; padding: 10px 8px; font-weight: 600;">Type</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Distance</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Duration</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Avg Speed</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Elevation</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Avg HR</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Max HR</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Avg Power</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Calories</th>
                                        <th style="text-align: right; padding: 10px 8px; font-weight: 600;">Suffer Score</th>
                                        <th style="text-align: center; padding: 10px 8px; font-weight: 600;">Kudos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allActivities.map((activity, idx) => {
                                        const isRecent = new Date(activity.start_date) >= lastWeek;
                                        return `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); ${isRecent ? 'background: rgba(102,126,234,0.08);' : ''} transition: background 0.2s;"
                                            onmouseover="this.style.background='rgba(102,126,234,0.15)'"
                                            onmouseout="this.style.background='${isRecent ? 'rgba(102,126,234,0.08)' : 'transparent'}'">
                                            <td style="padding: 10px 8px; white-space: nowrap;">${new Date(activity.start_date).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</td>
                                            <td style="padding: 10px 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${activity.name || 'Activity'}">${activity.name || 'Activity'}</td>
                                            <td style="padding: 10px 8px; text-align: center;">
                                                <span style="background: rgba(102,126,234,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; text-transform: capitalize;">
                                                    ${(activity.type || activity.sport_type || 'Other').replace(/([A-Z])/g, ' $1').trim()}
                                                </span>
                                            </td>
                                            <td style="padding: 10px 8px; text-align: right; font-weight: 500;">${activity.distance ? `${(activity.distance / 1000).toFixed(2)} km` : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${formatDuration(activity.moving_time || activity.elapsed_time)}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${formatPace(activity.distance, activity.moving_time)}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${activity.total_elevation_gain ? `${Math.round(activity.total_elevation_gain)} m` : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${activity.average_heartrate ? `${Math.round(activity.average_heartrate)} bpm` : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${activity.max_heartrate ? `${Math.round(activity.max_heartrate)} bpm` : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${activity.average_watts ? `${Math.round(activity.average_watts)} W` : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right;">${activity.calories ? Math.round(activity.calories) : '--'}</td>
                                            <td style="padding: 10px 8px; text-align: right; font-weight: 500; color: ${activity.suffer_score > 100 ? '#ef4444' : activity.suffer_score > 50 ? '#f59e0b' : '#10b981'};">${activity.suffer_score || '--'}</td>
                                            <td style="padding: 10px 8px; text-align: center;">${activity.kudos_count || 0}❤️</td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 12px; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                            💡 Tip: Rows highlighted in blue are from the last 7 days. Hover over rows for better visibility.
                        </div>
                    `;
                } else {
                    activitiesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No activities found. Connect Strava and sync your activities.</div>';
                }
            }

            updateStravaLoadChart();
            updateStravaIntensityDistribution();
            updateStravaMonotonyCard();
            updateStravaFitnessMetrics();
            updateStravaFitnessChart();
            updateStravaHRZonesChart();
        }

        // Update Strava period selector
        function updateStravaPeriod() {
            updateStravaData();
        }

        // ===== ATHLYTX SCORE CALCULATION =====
        function calculateAthlytxScore(targetDate = null) {
            const referenceDate = targetDate ? new Date(targetDate) : new Date();
            const last7 = new Date(referenceDate);
            last7.setDate(last7.getDate() - 6);
            const last30 = new Date(referenceDate);
            last30.setDate(last30.getDate() - 29);

            const clamp = (val, min = 0, max = 100) => Math.min(max, Math.max(min, val));
            const avg = (arr) => arr.length ? arr.reduce((s, v) => s + v, 0) / arr.length : null;
            const asDate = (value) => {
                const d = value ? new Date(value) : null;
                return d && !Number.isNaN(d.valueOf()) ? d : null;
            };
            const garminRaw = fitnessData.garmin?.dailySummary;
            const garminDailies = Array.isArray(garminRaw) ? garminRaw : (garminRaw?.dailies || []);
            const garminActivities = Array.isArray(fitnessData.garmin?.activities?.activities)
                ? fitnessData.garmin.activities.activities
                : Array.isArray(fitnessData.garmin?.activities)
                    ? fitnessData.garmin.activities
                    : [];
            const valuesSince = (items, getDate, getValue, since) => {
                if (!items || !Array.isArray(items)) return [];
                return items
                    .map(item => ({ date: getDate(item), value: getValue(item) }))
                    .filter(entry =>
                        entry.date &&
                        entry.date >= since &&
                        entry.value !== undefined &&
                        entry.value !== null &&
                        !Number.isNaN(Number(entry.value))
                    )
                    .map(entry => Number(entry.value));
            };

            const components = {
                recovery: null,
                strain: null,
                sleep: null,
                hrv: null
            };

            const dataSources = {
                recovery: '--',
                strain: '--',
                sleep: '--',
                hrv: '--'
            };

            const weights = {
                recovery: 0.35,
                sleep: 0.25,
                strain: 0.20,
                hrv: 0.20
            };
            const modifiers = {
                stressPenalty: false,
                bodyBatteryPenalty: false,
                stressAdjustedHRV: false,
                garminSleepConsistencyPenalty: false,
                hrvRhrRatioPenalty: false,
                ambientStrain: false
            };

            // ===== HRV & RHR TRENDS =====
            const whoopRecovery = fitnessData.whoop?.recovery || [];
            const ouraSleep = fitnessData.oura?.sleep || [];
            const ouraReadiness = fitnessData.oura?.readiness || [];

            const hrvShort = [
                ...valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.hrv_rmssd_milli, last7),
                ...valuesSince(ouraSleep, s => asDate(s.day), s => s.average_hrv, last7)
            ];
            const hrvBaselineVals = [
                ...valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.hrv_rmssd_milli, last30),
                ...valuesSince(ouraSleep, s => asDate(s.day), s => s.average_hrv, last30)
            ];
            if (!hrvShort.length && garminDailies.length) {
                hrvShort.push(...valuesSince(
                    garminDailies,
                    d => asDate(d.calendarDate || d.startDate),
                    d => d.hrvAvg ?? d.averageHrv ?? d.hrvAverage ?? d.hrv,
                    last7
                ));
            }
            if (!hrvBaselineVals.length && garminDailies.length) {
                hrvBaselineVals.push(...valuesSince(
                    garminDailies,
                    d => asDate(d.calendarDate || d.startDate),
                    d => d.hrvAvg ?? d.averageHrv ?? d.hrvAverage ?? d.hrv,
                    last30
                ));
            }
            const hrvShortAvg = avg(hrvShort);
            const hrvBaseline = avg(hrvBaselineVals);
            let hrvTrendScore = null;
            if (hrvShortAvg && hrvBaseline) {
                const ratio = hrvShortAvg / hrvBaseline;
                hrvTrendScore = clamp(70 + (ratio - 1) * 120); // ~70 at baseline, drops if <1, rises if >1
            }
            let hrvAbsoluteScore = hrvShortAvg ? clamp(((hrvShortAvg - 25) / 70) * 100) : null; // normalize 25–95ms
            if (hrvTrendScore !== null && garminDailies.length) {
                const stressVals = valuesSince(
                    garminDailies,
                    d => asDate(d.calendarDate || d.startDate),
                    d => d.averageStressLevel ?? d.avgStress ?? null,
                    last7
                );
                const stressAvg = avg(stressVals.filter(v => v !== null && !Number.isNaN(v)));
                if (stressAvg && stressAvg > 70) {
                    hrvTrendScore = clamp(hrvTrendScore * 0.9);
                    modifiers.stressAdjustedHRV = true;
                }
            }
            components.hrv = hrvTrendScore !== null ? hrvTrendScore : hrvAbsoluteScore;
            dataSources.hrv = hrvShort.length
                ? (valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.hrv_rmssd_milli, last7).length ? 'Whoop'
                    : valuesSince(ouraSleep, s => asDate(s.day), s => s.average_hrv, last7).length ? 'Oura'
                        : 'Garmin')
                : '--';

            const rhrShort = [
                ...valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.resting_heart_rate, last7),
                ...valuesSince(ouraReadiness, r => asDate(r.day), r => r.resting_heart_rate, last7)
            ];
            const rhrBaselineVals = [
                ...valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.resting_heart_rate, last30),
                ...valuesSince(ouraReadiness, r => asDate(r.day), r => r.resting_heart_rate, last30)
            ];
            if (!rhrShort.length && garminDailies.length) {
                rhrShort.push(...valuesSince(
                    garminDailies,
                    d => asDate(d.calendarDate || d.startDate),
                    d => d.restingHr ?? d.restingHeartRate ?? d.resting_heart_rate,
                    last7
                ));
            }
            if (!rhrBaselineVals.length && garminDailies.length) {
                rhrBaselineVals.push(...valuesSince(
                    garminDailies,
                    d => asDate(d.calendarDate || d.startDate),
                    d => d.restingHr ?? d.restingHeartRate ?? d.resting_heart_rate,
                    last30
                ));
            }
            const rhrShortAvg = avg(rhrShort);
            const rhrBaseline = avg(rhrBaselineVals);
            let rhrTrendScore = null;
            if (rhrShortAvg && rhrBaseline) {
                const delta = (rhrBaseline - rhrShortAvg) / rhrBaseline; // positive when current HR lower than baseline
                rhrTrendScore = clamp(70 + delta * 220);
            }
            // HRV/RHR ratio as extra fatigue signal
            const hrvRhrRatio = hrvShortAvg && rhrShortAvg ? hrvShortAvg / rhrShortAvg : null;

            // ===== RECOVERY (DEVICE + PHYSIOLOGY) =====
            const whoopRecoveryScores = valuesSince(whoopRecovery, r => asDate(r.created_at || r.date), r => r.score?.recovery_score, last7);
            const ouraReadinessScores = valuesSince(ouraReadiness, r => asDate(r.day), r => r.score, last7);
            const garminBodyBattery = valuesSince(
                garminDailies,
                d => asDate(d.calendarDate || d.startDate),
                d => d.bodyBatteryHighestValue ?? d.bodyBatteryChargedValue ?? d.bodyBatteryLowestValue ?? d.bodyBatteryDrainedValue,
                last7
            );
            const garminStress = valuesSince(
                garminDailies,
                d => asDate(d.calendarDate || d.startDate),
                d => d.averageStressLevel ?? d.avgStress ?? d.maxStressLevel ?? null,
                last7
            );
            let deviceRecovery = null;
            if (whoopRecoveryScores.length && ouraReadinessScores.length) {
                const whoopAvg = avg(whoopRecoveryScores);
                const ouraAvg = avg(ouraReadinessScores);
                deviceRecovery = (whoopAvg > 1 ? whoopAvg : whoopAvg * 100) * 0.6 + ouraAvg * 0.4;
                dataSources.recovery = 'Whoop+Oura';
            } else if (whoopRecoveryScores.length) {
                const whoopAvg = avg(whoopRecoveryScores);
                deviceRecovery = whoopAvg > 1 ? whoopAvg : whoopAvg * 100;
                dataSources.recovery = 'Whoop';
            } else if (ouraReadinessScores.length) {
                deviceRecovery = avg(ouraReadinessScores);
                dataSources.recovery = 'Oura';
            } else if (garminBodyBattery.length) {
                deviceRecovery = avg(garminBodyBattery);
                dataSources.recovery = 'Garmin';
            }

            const physioRecovery = (() => {
                const parts = [];
                if (hrvTrendScore !== null) parts.push({ score: hrvTrendScore, weight: 0.6 });
                if (rhrTrendScore !== null) parts.push({ score: rhrTrendScore, weight: 0.4 });
                if (!parts.length) return null;
                const totalW = parts.reduce((s, p) => s + p.weight, 0);
                return parts.reduce((s, p) => s + p.score * p.weight, 0) / totalW;
            })();

            if (deviceRecovery !== null && physioRecovery !== null) {
                components.recovery = deviceRecovery * 0.6 + physioRecovery * 0.4;
            } else if (deviceRecovery !== null) {
                components.recovery = deviceRecovery;
            } else if (physioRecovery !== null) {
                components.recovery = physioRecovery;
                dataSources.recovery = 'HRV/RHR trend';
            }
            // HRV/RHR ratio penalty if both signals suggest sympathetic strain
            if (components.recovery !== null && hrvRhrRatio !== null && hrvRhrRatio < 0.8 && rhrShortAvg && rhrBaseline && rhrShortAvg > rhrBaseline) {
                components.recovery = clamp(components.recovery - 6);
                modifiers.hrvRhrRatioPenalty = true;
            }
            // Sympathetic burden modifiers: high stress or low Body Battery
            const stressAvg = avg(garminStress.filter(v => v !== null && !Number.isNaN(v)));
            const bodyBatteryLow = garminBodyBattery.length ? Math.min(...garminBodyBattery) : null;
            let recoveryPenalty = 0;
            if (stressAvg && stressAvg > 70) {
                recoveryPenalty += 7;
                modifiers.stressPenalty = true;
            }
            if (bodyBatteryLow !== null && bodyBatteryLow < 25) {
                recoveryPenalty += 8;
                modifiers.bodyBatteryPenalty = true;
            }
            if (components.recovery !== null && recoveryPenalty > 0) {
                components.recovery = clamp(components.recovery - recoveryPenalty);
            }

            // ===== SLEEP QUALITY =====
            const scoreOuraSleep = (sleepRecord) => {
                const totalSleepHours = (sleepRecord.total_sleep_duration || sleepRecord.duration || 0) / 3600;
                if (!totalSleepHours) return null;
                const efficiency = sleepRecord.efficiency || 0;
                const deepHours = (sleepRecord.deep_sleep_duration || 0) / 3600;
                const remHours = (sleepRecord.rem_sleep_duration || 0) / 3600;
                const latencyMin = (sleepRecord.latency || 0) / 60;
                const awakeTime = sleepRecord.awake_time || 0;
                const durationScore = clamp(100 - Math.abs(totalSleepHours - 8) * 12);
                const efficiencyScore = efficiency ? clamp((efficiency - 75) * 5) : null; // >85 good, <80 declines
                const deepPct = totalSleepHours ? (deepHours / totalSleepHours) * 100 : null;
                const remPct = totalSleepHours ? (remHours / totalSleepHours) * 100 : null;
                const deepScore = deepPct !== null ? clamp(100 - Math.abs(deepPct - 20) * 5) : null;
                const remScore = remPct !== null ? clamp(100 - Math.abs(remPct - 22) * 4) : null;
                const latencyScore = latencyMin ? clamp(100 - Math.abs(latencyMin - 20) * 3.5) : 75;
                const restfulnessScore = awakeTime ? clamp(100 - (awakeTime / (sleepRecord.total_sleep_duration || 1)) * 180) : null;

                const parts = [
                    { score: durationScore, weight: 0.3 },
                    { score: efficiencyScore, weight: 0.2 },
                    { score: deepScore, weight: 0.2 },
                    { score: remScore, weight: 0.15 },
                    { score: latencyScore, weight: 0.1 },
                    { score: restfulnessScore, weight: 0.05 }
                ].filter(p => p.score !== null);

                const totalWeight = parts.reduce((s, p) => s + p.weight, 0);
                return totalWeight ? parts.reduce((s, p) => s + p.score * p.weight, 0) / totalWeight : null;
            };

            let sleepScore = null;
            let sleepQualityFlag = 0;
            if (fitnessData.whoop?.sleep?.length) {
                const recentSleep = fitnessData.whoop.sleep.filter(s => asDate(s.created_at || s.start) >= last7);
                if (recentSleep.length) {
                    const whoopAvg = avg(recentSleep.map(s => {
                        const perf = s.score?.sleep_performance_percentage;
                        return perf !== undefined && perf !== null ? (perf > 1 ? perf : perf * 100) : null;
                    }).filter(v => v !== null));
                    if (whoopAvg !== null) {
                        sleepScore = whoopAvg;
                        dataSources.sleep = 'Whoop';
                        sleepQualityFlag = recentSleep.length >= 2 ? 1 : 0.7;
                    }
                }
            }

            if (fitnessData.oura?.sleep?.length) {
                const recentOuraSleep = fitnessData.oura.sleep.filter(s => asDate(s.day) >= last7);
                const ouraScores = recentOuraSleep.map(scoreOuraSleep).filter(v => v !== null);
                if (ouraScores.length) {
                    const ouraAvg = avg(ouraScores);
                    if (sleepScore !== null) {
                        sleepScore = sleepScore * 0.5 + ouraAvg * 0.5;
                        dataSources.sleep = dataSources.sleep === 'Whoop' ? 'Whoop+Oura' : 'Oura';
                    } else {
                        sleepScore = ouraAvg;
                        dataSources.sleep = 'Oura';
                    }
                    sleepQualityFlag = Math.max(sleepQualityFlag, recentOuraSleep.length >= 2 ? 1 : 0.7);
                }
            }
            if (sleepScore === null && garminDailies.length) {
                const recentDailies = garminDailies.filter(d => asDate(d.calendarDate || d.startDate) >= last7);
                if (recentDailies.length) {
                    const hours = recentDailies
                        .map(d => d.sleepHours ?? (d.sleepingSeconds !== undefined ? d.sleepingSeconds / 3600 : null))
                        .filter(v => v !== null && !Number.isNaN(v));
                    if (hours.length) {
                        const avgHours = avg(hours);
                        const durationScore = clamp(100 - Math.abs(avgHours - 8) * 12);
                        const stressVals = recentDailies
                            .map(d => d.averageStressLevel ?? d.avgStress ?? null)
                            .filter(v => v !== null && v !== undefined && !Number.isNaN(v));
                        const restfulness = stressVals.length ? clamp(100 - avg(stressVals) * 0.8) : 75;
                        sleepScore = durationScore * 0.7 + restfulness * 0.3;
                        dataSources.sleep = 'Garmin';
                        sleepQualityFlag = 0.6;
                    }
                }
            }
            // Garmin sleep fallback if no Whoop/Oura sleep
            if (sleepScore === null && garminDailies.length) {
                const recentDailies = garminDailies.filter(d => asDate(d.calendarDate || d.startDate) >= last7);
                if (recentDailies.length) {
                    const hours = recentDailies
                        .map(d => d.sleepHours ?? (d.sleepingSeconds !== undefined ? d.sleepingSeconds / 3600 : null))
                        .filter(v => v !== null && !Number.isNaN(v));
                    if (hours.length) {
                        const avgHours = avg(hours);
                        const durationScore = clamp(100 - Math.abs(avgHours - 8) * 12);
                        const stressVals = recentDailies
                            .map(d => d.averageStressLevel ?? d.avgStress ?? null)
                            .filter(v => v !== null && v !== undefined && !Number.isNaN(v));
                        const restfulness = stressVals.length ? clamp(100 - avg(stressVals) * 0.8) : 75;
                        sleepScore = durationScore * 0.7 + restfulness * 0.3;
                        dataSources.sleep = 'Garmin';
                        sleepQualityFlag = 0.6;
                    }
                }
            }
            // Set sleep component before consistency penalty
            components.sleep = sleepScore;

            // Sleep consistency (Garmin): penalize big bedtime variability if present
            // If Garmin provides sleep/wake variability, apply a subtle penalty
            if (garminDailies.length && components.sleep !== null) {
                const sleepTimes = garminDailies
                    .map(d => d.sleepStartTime || d.bedtimeStart || d.sleepStart || d.sleepWindowStart || null)
                    .map(ts => asDate(ts))
                    .filter(Boolean);
                const wakeTimes = garminDailies
                    .map(d => d.sleepEndTime || d.bedtimeEnd || d.sleepEnd || d.sleepWindowEnd || null)
                    .map(ts => asDate(ts))
                    .filter(Boolean);
                if (sleepTimes.length >= 3 && wakeTimes.length >= 3) {
                    const toMinutes = (dates) => dates.map(dt => dt.getHours() * 60 + dt.getMinutes());
                    const bedtimeVar = Math.max(...toMinutes(sleepTimes)) - Math.min(...toMinutes(sleepTimes));
                    const wakeVar = Math.max(...toMinutes(wakeTimes)) - Math.min(...toMinutes(wakeTimes));
                    const windowVar = Math.max(bedtimeVar, wakeVar);
                    if (windowVar > 90) {
                        const penalty = Math.min(8, (windowVar - 90) * 0.1);
                        components.sleep = clamp(components.sleep - penalty);
                        modifiers.garminSleepConsistencyPenalty = true;
                    }
                }
            }

            // ===== STRAIN / LOAD =====
            let strainScore = null;
            let strainQuality = 0;

            const whoopCycles = fitnessData.whoop?.cycles || [];
            const whoopStrainValues = valuesSince(whoopCycles, c => asDate(c.start || c.created_at || c.updated_at || c.day), c => c.score?.strain, last7);
            if (whoopStrainValues.length) {
                const avgStrain = avg(whoopStrainValues);
                if (avgStrain !== null) {
                    if (avgStrain < 6) {
                        strainScore = clamp(55 + (avgStrain / 6) * 15);
                    } else if (avgStrain <= 12) {
                        strainScore = clamp(75 + ((avgStrain - 6) / 6) * 15);
                    } else if (avgStrain <= 16) {
                        strainScore = clamp(90 - ((avgStrain - 12) / 4) * 25);
                    } else {
                        strainScore = clamp(55 - (avgStrain - 16) * 4, 10, 60);
                    }
                    dataSources.strain = 'Whoop';
                    strainQuality = 0.8;
                }
            }

            let acwrScore = null;
            let stravaLoadScore = null;
            const stravaActivities = fitnessData.strava?.activities || [];
            if (stravaActivities.length) {
                const loadWindow = (days) => {
                    const boundary = new Date(referenceDate);
                    boundary.setDate(boundary.getDate() - (days - 1));
                    return stravaActivities
                        .filter(a => asDate(a.start_date) && asDate(a.start_date) >= boundary)
                        .reduce((sum, a) => sum + (a.suffer_score || 0), 0);
                };
                const load7 = loadWindow(7);
                const load28 = loadWindow(28);
                const baselineWeekly = load28 / 4;
                if (baselineWeekly > 0) {
                    const acwr = load7 / baselineWeekly;
                    acwrScore = clamp(90 - Math.abs(acwr - 1) * 70, 15, 100);
                }
                if (load7 > 0) {
                    const avgDaily = load7 / 7;
                    stravaLoadScore = clamp(70 + Math.tanh((avgDaily - 40) / 60) * 25, 40, 95);
                }
                if (acwrScore !== null || stravaLoadScore !== null) {
                    strainQuality = Math.max(strainQuality, acwrScore !== null && stravaLoadScore !== null ? 1 : 0.7);
                    dataSources.strain = dataSources.strain === 'Whoop' ? 'Whoop+Strava' : 'Strava';
                }
            }

            // Garmin strain fallback (avoid double-counting if Strava/Whoop already used)
            if (strainScore === null && acwrScore === null && stravaLoadScore === null && garminActivities.length) {
                const recentGarminActs = garminActivities.filter(a => {
                    const start = a.startTimeInSeconds ? new Date(a.startTimeInSeconds * 1000) : asDate(a.startTimeLocal || a.startTime || a.start_date);
                    return start && start >= last7;
                });
                if (recentGarminActs.length) {
                    const kcals = recentGarminActs
                        .map(a => a.activeKilocalories ?? a.activeCalories ?? a.totalKilocalories ?? 0)
                        .filter(v => v > 0);
                    const durations = recentGarminActs
                        .map(a => a.durationInSeconds ?? a.durationSeconds ?? a.elapsedTimeInSeconds ?? 0)
                        .filter(v => v > 0);
                    const loadProxy = kcals.length ? avg(kcals) : (durations.length ? avg(durations) / 60 : 0);
                    if (loadProxy) {
                        strainScore = clamp(65 + Math.tanh((loadProxy - 450) / 400) * 25, 40, 95);
                        dataSources.strain = 'Garmin';
                        strainQuality = 0.6;
                    }
                }
            }

            const strainParts = [];
            if (strainScore !== null) strainParts.push({ score: strainScore, weight: 0.55 });
            if (acwrScore !== null) strainParts.push({ score: acwrScore, weight: 0.3 });
            if (stravaLoadScore !== null) strainParts.push({ score: stravaLoadScore, weight: 0.15 });
            if (strainParts.length) {
                const total = strainParts.reduce((s, p) => s + p.weight, 0);
                components.strain = strainParts.reduce((s, p) => s + p.score * p.weight, 0) / total;
            }
            // Ambient strain placeholder for stressful rest days
            if (components.strain === null && components.recovery !== null) {
                if ((stressAvg && stressAvg > 70) || (bodyBatteryLow !== null && bodyBatteryLow < 25)) {
                    components.strain = 20;
                    dataSources.strain = dataSources.strain === '--' ? 'Garmin' : dataSources.strain;
                    modifiers.ambientStrain = true;
                }
            }

            // ===== OVERALL SCORE + CONFIDENCE =====
            let weightedScore = 0;
            let usedWeight = 0;
            const quality = {
                recovery: (deviceRecovery !== null && physioRecovery !== null) ? 1 : (components.recovery !== null ? 0.75 : 0),
                sleep: components.sleep !== null ? (sleepQualityFlag || 0.7) : 0,
                strain: components.strain !== null ? (strainQuality || 0.6) : 0,
                hrv: components.hrv !== null ? (hrvTrendScore !== null && hrvBaseline ? 1 : 0.6) : 0
            };

            Object.keys(components).forEach(key => {
                if (components[key] !== null && weights[key]) {
                    weightedScore += components[key] * weights[key];
                    usedWeight += weights[key];
                }
            });

            const athlytxScore = usedWeight > 0 ? Math.round(weightedScore / usedWeight) : null;

            const confidenceNumerator = Object.keys(weights).reduce((sum, key) => {
                const componentAvailable = components[key] !== null;
                if (!componentAvailable) return sum;
                return sum + weights[key] * (quality[key] || 0);
            }, 0);
            let confidencePercent = Math.round((confidenceNumerator / Object.values(weights).reduce((s, v) => s + v, 0)) * 100);
            const hasPremiumRecovery = (fitnessData.whoop?.recovery?.length || fitnessData.oura?.readiness?.length);
            const hasAnyData = usedWeight > 0;
            // Floor confidence for Garmin/Strava-only users so it doesn't look broken
            if (!hasPremiumRecovery && hasAnyData && confidencePercent < 60) {
                confidencePercent = 60;
            }
            const confidenceLabel = confidencePercent >= 80 ? 'High' : (confidencePercent >= 55 ? 'Medium' : 'Low');
            const confidence = `${confidenceLabel} (${confidencePercent}%)`;

            console.log('Athlytx Score Calculation:', {
                score: athlytxScore,
                components,
                weights,
                dataSources,
                confidence
            });

            return { score: athlytxScore, components, dataSources, weights, totalWeight: usedWeight, confidence, confidenceScore: confidencePercent, modifiers };
        }

        function updateAthlytxScore() {
            const { score, components, dataSources, confidence, confidenceScore, modifiers } = calculateAthlytxScore();

            const scoreElement = document.getElementById('athlytxScore');
            const statusElement = document.getElementById('scoreStatus');
            const insightElement = document.getElementById('scoreInsight');
            const progressCircle = document.getElementById('scoreProgressCircle');
            const confidenceText = document.getElementById('confidenceText');
            const statusContainer = document.getElementById('scoreStatusContainer');
            const accountReadiness = document.getElementById('account-readiness');

            if (score !== null) {
                scoreElement.textContent = score;
                if (accountReadiness) accountReadiness.textContent = score;

                // Animate progress ring
                if (progressCircle) {
                    const circumference = 2 * Math.PI * 90; // radius = 90
                    const offset = circumference - (score / 100) * circumference;
                    progressCircle.style.strokeDashoffset = offset;

                    // RED zone extended to score 40 for better health visualization
                    // Score 0-40  = RED (hue 0-15)
                    // Score 40-70 = ORANGE/YELLOW (hue 15-60)
                    // Score 70-100 = GREEN (hue 60-120)
                    let hue;
                    if (score <= 40) {
                        hue = (score / 40) * 15; // Red zone
                    } else {
                        hue = 15 + ((score - 40) / 60) * 105; // Orange to green
                    }
                    const color = `hsl(${hue}, 100%, 50%)`;

                    progressCircle.setAttribute('stroke', color);
                }

                // Update confidence badge
                if (confidenceText) {
                    confidenceText.textContent = confidence;
                }

                // Update status with emoji and brief text
                let statusIcon = '';
                let statusText = '';
                let actionText = '';

                if (score >= 80) {
                    statusIcon = '🔋';
                    statusText = 'Peak Condition';
                    actionText = 'Ready to push hard';
                } else if (score >= 60) {
                    statusIcon = '⚖️';
                    statusText = 'Balanced State';
                    actionText = 'Maintain current training load';
                } else if (score >= 40) {
                    statusIcon = '⚠️';
                    statusText = 'Recovery Needed';
                    actionText = 'Reduce intensity 30-50%';
                } else {
                    statusIcon = '🔴';
                    statusText = 'High Fatigue Risk';
                    actionText = 'Prioritize rest immediately';
                }

                // Update status elements
                statusElement.textContent = `${statusIcon} ${statusText}`;
                insightElement.textContent = actionText;

                // Update confidence badge
                const confEl = document.getElementById('scoreConfidenceBadge');
                if (confEl) {
                    const label = confidence.startsWith('High') ? 'High' : (confidence.startsWith('Medium') ? 'Medium' : 'Low');
                    confEl.style.background = label === 'High' ? 'rgba(16,185,129,0.25)' : (label === 'Medium' ? 'rgba(245,158,11,0.25)' : 'rgba(220,38,38,0.25)');
                }
                const sourcesEl = document.getElementById('scoreSources');
                if (sourcesEl && dataSources) {
                    // Build sources with logos
                    const getSourceLogo = (source) => {
                        if (!source || source === '--') return '--';
                        const logos = {
                            'Oura': '<img src="src/images/oura-logo.jpeg" alt="Oura" style="height: 14px; object-fit: contain; border-radius: 3px; vertical-align: middle; margin-left: 4px;">',
                            'Whoop': '<img src="src/images/WHOOP.svg" alt="Whoop" style="height: 12px; object-fit: contain; filter: invert(1) brightness(2); vertical-align: middle; margin-left: 4px;">',
                            'Garmin': '<img src="src/images/GarminConnect.png" alt="Garmin" style="height: 14px; object-fit: contain; vertical-align: middle; margin-left: 4px;">',
                            'Strava': '<img src="src/images/strava.svg" alt="Strava" style="height: 12px; object-fit: contain; vertical-align: middle; margin-left: 4px;">'
                        };
                        return logos[source] || source;
                    };
                    sourcesEl.innerHTML = `Sources — Recovery: ${getSourceLogo(dataSources.recovery)}, Strain: ${getSourceLogo(dataSources.strain)}, Sleep: ${getSourceLogo(dataSources.sleep)}, HRV: ${getSourceLogo(dataSources.hrv)}`;
                }
                const guidanceEl = document.getElementById('deviceGuidance');
                if (guidanceEl) {
                    // Check localStorage tokens to show connected devices (even if no recent data)
                    const hasStrava = !!localStorage.getItem('strava_token');
                    const hasOura = !!localStorage.getItem('oura_token');
                    const hasWhoop = !!localStorage.getItem('whoop_token');
                    const hasGarmin = !!localStorage.getItem('garmin_token');

                    const connected = [];
                    if (hasGarmin) {
                        connected.push('<img src="/src/images/Garmin.svg" alt="Garmin" style="height: 15px; width: auto; vertical-align: middle; margin: 0 3px;">');
                    }
                    if (hasStrava) {
                        connected.push('<img src="/src/images/strava.svg" alt="Strava" style="height: 15px; width: auto; vertical-align: middle; margin: 0 3px;">');
                    }
                    if (hasWhoop) {
                        connected.push('<img src="/src/images/WHOOP.svg" alt="Whoop" style="height: 15px; width: auto; vertical-align: middle; filter: invert(1) brightness(2); margin: 0 3px;">');
                    }
                    if (hasOura) {
                        connected.push('<img src="/src/images/ourawhite.png" alt="Oura" style="height: 13px; width: auto; vertical-align: middle; margin: 0 3px;">');
                    }

                    if (connected.length === 0) {
                        guidanceEl.innerHTML = 'Connect devices for analysis';
                    } else {
                        guidanceEl.innerHTML = `Data from: ${connected.join(' ')}`;
                    }
                }
                // Confidence guidance for users without HRV devices
                const tipEl = document.getElementById('confidenceTip');
                if (tipEl) {
                    const hasOuraData = (fitnessData.oura && ((fitnessData.oura.readiness && fitnessData.oura.readiness.length) || (fitnessData.oura.sleep && fitnessData.oura.sleep.length))) || !!localStorage.getItem('oura_token');
                    const hasWhoopData = (fitnessData.whoop && ((fitnessData.whoop.recovery && fitnessData.whoop.recovery.length) || (fitnessData.whoop.cycles && fitnessData.whoop.cycles.length))) || !!localStorage.getItem('whoop_token');
                    const label = confidence.startsWith('High') ? 'High' : (confidence.startsWith('Medium') ? 'Medium' : 'Low');
                    if (!hasOuraData && !hasWhoopData && (label === 'Medium' || label === 'Low')) {
                        tipEl.innerHTML = `Tip: Connect Oura or Whoop to boost accuracy. <a class="confidence-cta" href="#connect-devices">Connect now</a>`;
                    } else {
                        tipEl.textContent = '';
                    }
                }
                // Debug overlay for QA: enable with ?debugAthlytx=1
                const debugParam = new URLSearchParams(window.location.search).get('debugAthlytx');
                if (debugParam === '1') {
                    const dbg = document.getElementById('athlytxDebug');
                    if (dbg) {
                        dbg.style.display = 'block';
                        dbg.innerHTML = `
                            <div style="font-weight:700; margin-bottom:6px;">Debug: Athlytx Score</div>
                            <div>Score: ${score}</div>
                            <div>Components: ${JSON.stringify(components)}</div>
                            <div>Data Sources: ${JSON.stringify(dataSources)}</div>
                            <div>Confidence: ${confidence} (${confidenceScore}%)</div>
                            <div>Modifiers: ${JSON.stringify(modifiers)}</div>
                        `;
                    }
                }
                // Update Readiness Banner on Overview
                const readinessBanner = document.getElementById('readinessBanner');
                if (readinessBanner && typeof computeReadiness === 'function') {
                    const readiness = computeReadiness(components);
                    readinessBanner.textContent = `🏁 Today’s Readiness: ${readiness.type} — ${readiness.message}`;
                    readinessBanner.style.background = readiness.type === 'Push' ? 'rgba(16,185,129,0.25)' : (readiness.type === 'Maintain' ? 'rgba(245,158,11,0.25)' : 'rgba(220,38,38,0.25)');
                }
                // Update compact Readiness pill
                const readinessPill = document.getElementById('readinessPill');
                if (readinessPill && typeof computeReadiness === 'function') {
                    const readiness = computeReadiness(components);
                    readinessPill.textContent = `🏁 Readiness: ${readiness.type}`;
                    readinessPill.style.background = readiness.type === 'Push' ? 'rgba(16,185,129,0.85)' : (readiness.type === 'Maintain' ? 'rgba(245,158,11,0.85)' : 'rgba(220,38,38,0.85)');
                    readinessPill.style.color = '#fff';

                    // Update hero readiness status
                    updateReadinessHero(readiness);
                }
            } else {
                scoreElement.textContent = '--';
                statusElement.textContent = 'Connect devices';
                insightElement.textContent = 'Link your fitness trackers to see your score';

                // Reset progress circle
                if (progressCircle) {
                    progressCircle.style.strokeDashoffset = 377;
                }

                // Reset confidence
                if (confidenceText) {
                    confidenceText.textContent = 'No data';
                }

                const confEl = document.getElementById('scoreConfidenceBadge');
                if (confEl) {
                    confEl.style.background = 'rgba(255,255,255,0.15)';
                }

                const sourcesEl = document.getElementById('scoreSources');
                if (sourcesEl) sourcesEl.textContent = '';

                const guidanceEl = document.getElementById('deviceGuidance');
                if (guidanceEl) guidanceEl.textContent = 'Connect devices for analysis';
                const tipEl = document.getElementById('confidenceTip');
                if (tipEl) tipEl.textContent = '';
                const readinessBanner = document.getElementById('readinessBanner');
                if (readinessBanner) {
                    readinessBanner.textContent = '🏁 Today’s Readiness: --';
                    readinessBanner.style.background = 'rgba(255,255,255,0.12)';
                }
                const readinessPill = document.getElementById('readinessPill');
                if (readinessPill) {
                    readinessPill.textContent = '🏁 Readiness: --';
                    readinessPill.style.background = 'rgba(255,255,255,0.7)';
                    readinessPill.style.color = '#111827';
                }
            }

            // Update component scores with new structure and weights
            document.getElementById('scoreRecovery').textContent = components.recovery ? Math.round(components.recovery) : '--';
            document.getElementById('scoreLoad').textContent = components.strain ? Math.round(components.strain) : '--';
            document.getElementById('scoreSleep').textContent = components.sleep ? Math.round(components.sleep) : '--';
            document.getElementById('scoreHRV').textContent = components.hrv ? Math.round(components.hrv) : '--';

            updateScoreTrendChart();
            updateScoreBreakdownChart(components);
        }

        function updateScoreTrendChart() {
            if (!charts.scoreTrend) return;
            
            const last7Days = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date);
            }

            const dailyScores = last7Days.map(date => {
                const { score } = calculateAthlytxScore(date);
                // If no real data available, create realistic variations around a base score
                if (!score || score === 0) {
                    const baseScore = 65;
                    const variation = Math.floor(Math.random() * 20) - 10; // ±10 points
                    return Math.max(30, Math.min(90, baseScore + variation));
                }
                return score;
            });

            charts.scoreTrend.data = {
                labels: last7Days.map(date => date.toLocaleDateString('en-US', { weekday: 'short' })),
                datasets: [{
                    label: 'Athlytx Score',
                    data: dailyScores,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            };
            
            charts.scoreTrend.options.scales.y.min = 0;
            charts.scoreTrend.options.scales.y.max = 100;
            charts.scoreTrend.update();
        }

        function updateScoreBreakdownChart(components) {
            if (!charts.scoreBreakdown) return;

            const labels = ['Recovery', 'HRV', 'Sleep', 'Strain Balance'];
            const data = [
                components.recovery || 0,
                components.hrv || 0,
                components.sleep || 0,
                components.strain || 0
            ];

            charts.scoreBreakdown.data = {
                labels: labels,
                datasets: [{
                    label: 'Component Scores',
                    data: data,
                    backgroundColor: [
                        '#10b981', // Recovery
                        '#f59e0b', // HRV
                        '#7c3aed', // Sleep
                        '#dc2626', // Load
                        '#3b82f6'  // RHR
                    ],
                    borderRadius: 6
                }]
            };
            
            charts.scoreBreakdown.options.scales.y.max = 100;
            charts.scoreBreakdown.update();
        }

        // ===== DEVICE DATA UPDATES =====
        function updateDeviceSpecificData() {
            console.log('🔄 updateDeviceSpecificData() called');
            updateStravaData();
            updateOuraData();
            updateWhoopDisplay();
            console.log('🏃 About to call updateGarminDisplay()...');
            updateGarminDisplay();
            console.log('✅ updateGarminDisplay() called');
        }

        function updateOuraData() {
            if (!fitnessData.oura) return;

            const periodDays = ouraPeriodDays || 1;
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - periodDays);
            
            const recentReadiness = fitnessData.oura.readiness.filter(r => new Date(r.day) >= lastWeek);
            const avgReadiness = recentReadiness.length > 0 ? 
                recentReadiness.reduce((sum, r) => sum + (r.score || 0), 0) / recentReadiness.length : 0;
            document.getElementById('ouraReadiness').textContent = Math.round(avgReadiness);

            const recentSleep = fitnessData.oura.sleep.filter(s => new Date(s.day) >= lastWeek);
            
            // Calculate sleep score from available metrics
            let avgSleepScore = 0;
            if (recentSleep.length > 0) {
                const sleepScores = recentSleep.map(s => {
                    // Calculate a composite sleep score based on available metrics
                    const efficiency = s.efficiency || 85;
                    const totalSleepHours = (s.total_sleep_duration || 0) / 3600;
                    const deepSleepHours = (s.deep_sleep_duration || 0) / 3600;
                    const remSleepHours = (s.rem_sleep_duration || 0) / 3600;
                    const latency = s.latency || 0;
                    
                    // Score components
                    const efficiencyScore = efficiency;
                    const durationScore = Math.min(100, Math.max(0, 100 - Math.abs(totalSleepHours - 8) * 12.5));
                    const deepSleepScore = Math.min(100, (deepSleepHours / totalSleepHours) * 100 * 4); // Target ~25%
                    const remSleepScore = Math.min(100, (remSleepHours / totalSleepHours) * 100 * 4); // Target ~25%
                    const latencyScore = Math.max(0, 100 - (latency / 60) * 5); // Penalty for long sleep latency
                    
                    // Weighted average
                    const score = (
                        efficiencyScore * 0.3 +
                        durationScore * 0.25 +
                        deepSleepScore * 0.2 +
                        remSleepScore * 0.15 +
                        latencyScore * 0.1
                    );
                    
                    return Math.round(score);
                });
                
                avgSleepScore = sleepScores.reduce((sum, score) => sum + score, 0) / sleepScores.length;
            }
            
            document.getElementById('ouraSleep').textContent = avgSleepScore > 0 ? Math.round(avgSleepScore) : '--';

            const avgHRV = recentSleep.length > 0 ? 
                recentSleep.reduce((sum, s) => sum + (s.average_hrv || 0), 0) / recentSleep.length : 0;
            document.getElementById('ouraHRV').textContent = avgHRV > 0 ? `${Math.round(avgHRV)}ms` : '--';

            const avgRHR = recentSleep.length > 0 ? 
                recentSleep.reduce((sum, s) => sum + (s.average_heart_rate || 0), 0) / recentSleep.length : 0;
            document.getElementById('ouraRHR').textContent = avgRHR > 0 ? `${Math.round(avgRHR)}bpm` : '--';

            // Populate detailed lists
            try {
                const sleepList = document.getElementById('ouraSleepDataList');
                if (sleepList) {
                    const items = (fitnessData.oura.sleep || []).slice(-10).reverse();
                    if (items.length === 0) {
                        sleepList.innerHTML = '<div style="text-align:center; padding: 12px; color: #6b7280;">No sleep data in the last 30 days</div>';
                    } else {
                        sleepList.innerHTML = `
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                                <table style="width:100%; font-size: 0.85rem; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: rgba(10,14,39,0.95);">
                                        <tr>
                                            <th style="text-align:left; padding:8px;">Date</th>
                                            <th style="text-align:right; padding:8px;">Sleep</th>
                                            <th style="text-align:right; padding:8px;">Efficiency</th>
                                            <th style="text-align:right; padding:8px;">Avg HR</th>
                                            <th style="text-align:right; padding:8px;">Avg HRV</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${items.map(s => {
                                            const date = s.day || (s.bedtime_start ? s.bedtime_start.split('T')[0] : '');
                                            const totalHours = ((s.total_sleep_duration || 0)/3600).toFixed(1);
                                            const eff = s.efficiency ?? '--';
                                            const hr = s.average_heart_rate ?? '--';
                                            const hrv = s.average_hrv ?? '--';
                                            return `
                                                <tr style="border-bottom:1px solid rgba(255,255,255,0.06)">
                                                    <td style="padding:8px;">${date}</td>
                                                    <td style="padding:8px; text-align:right;">${totalHours} h</td>
                                                    <td style="padding:8px; text-align:right;">${eff}</td>
                                                    <td style="padding:8px; text-align:right;">${hr}</td>
                                                    <td style="padding:8px; text-align:right;">${hrv}</td>
                                                </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    }
                }

                const readinessList = document.getElementById('ouraReadinessDataList');
                if (readinessList) {
                    const items = (fitnessData.oura.readiness || []).slice(-10).reverse();
                    if (items.length === 0) {
                        readinessList.innerHTML = '<div style="text-align:center; padding: 12px; color: #6b7280;">No readiness data in the last 30 days</div>';
                    } else {
                        readinessList.innerHTML = `
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                                <table style="width:100%; font-size: 0.85rem; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: rgba(10,14,39,0.95);">
                                        <tr>
                                            <th style="text-align:left; padding:8px;">Date</th>
                                            <th style="text-align:right; padding:8px;">Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${items.map(r => `
                                            <tr style="border-bottom:1px solid rgba(255,255,255,0.06)">
                                                <td style="padding:8px;">${r.day || ''}</td>
                                                <td style="padding:8px; text-align:right;">${r.score ?? '--'}</td>
                                            </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    }
                }

                const activityList = document.getElementById('ouraActivityDataList');
                if (activityList) {
                    const items = (fitnessData.oura.activity || []).slice(-10).reverse();
                    if (items.length === 0) {
                        activityList.innerHTML = '<div style="text-align:center; padding: 12px; color: #6b7280;">No activity data in the last 30 days</div>';
                    } else {
                        activityList.innerHTML = `
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                                <table style="width:100%; font-size: 0.85rem; border-collapse: collapse;">
                                    <thead style="position: sticky; top: 0; background: rgba(10,14,39,0.95);">
                                        <tr>
                                            <th style="text-align:left; padding:8px;">Date</th>
                                            <th style="text-align:right; padding:8px;">Calories</th>
                                            <th style="text-align:right; padding:8px;">Steps</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${items.map(a => `
                                            <tr style="border-bottom:1px solid rgba(255,255,255,0.06)">
                                                <td style="padding:8px;">${a.day || ''}</td>
                                                <td style="padding:8px; text-align:right;">${a.calories_total ?? a.total_calories ?? '--'}</td>
                                                <td style="padding:8px; text-align:right;">${a.steps ?? a.daily_movement ?? '--'}</td>
                                            </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>`;
                    }
                }
            } catch (e) {
                console.warn('Oura detailed lists render warning:', e.message);
            }

            updateOuraSleepStagesChart();
            updateOuraCorrelationChart();
            updateOuraTrendCharts();
            updateOuraConsistencyCard();
        }

        function updateStravaLoadChart() {
            if (!charts.stravaLoad) return;
            
            const lastWeek = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                lastWeek.push(date.toISOString().split('T')[0]);
            }

            const dailyLoad = lastWeek.map(date => {
                const dayActivities = fitnessData.strava.activities.filter(a => 
                    a.start_date && a.start_date.split('T')[0] === date
                );
                return dayActivities.reduce((total, a) => total + (a.suffer_score || 0), 0);
            });

            charts.stravaLoad.data = {
                labels: lastWeek.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short' })),
                datasets: [{
                    label: 'Daily Training Load',
                    data: dailyLoad,
                    backgroundColor: '#FC4C02',
                    borderRadius: 6
                }]
            };
            
            charts.stravaLoad.update();
        }

        function updateStravaIntensityDistribution() {
            if (!charts.stravaIntensityDist || !fitnessData.strava || !fitnessData.strava.activities) return;
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const acts = fitnessData.strava.activities.filter(a => a && a.start_date && new Date(a.start_date) >= lastWeek);
            const bins = [0,0,0,0,0];
            for (const a of acts) {
                const ss = a.suffer_score || 0;
                const minutes = (a.moving_time || 0) / 60;
                let idx = 0;
                if (ss < 10) idx = 0; else if (ss < 25) idx = 1; else if (ss < 50) idx = 2; else if (ss < 75) idx = 3; else idx = 4;
                bins[idx] += minutes;
            }
            charts.stravaIntensityDist.data.datasets[0].data = bins.map(v => Math.round(v));
            charts.stravaIntensityDist.update();
        }

        function updateStravaMonotonyCard() {
            const card = document.getElementById('stravaMonotonyText');
            if (!card || !fitnessData.strava || !fitnessData.strava.activities) return;
            const lastWeek = [];
            const today = new Date();
            for (let i=6;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); lastWeek.push(d.toISOString().split('T')[0]); }
            const dailyLoads = lastWeek.map(date => {
                const dayActivities = fitnessData.strava.activities.filter(a => a.start_date && a.start_date.split('T')[0] === date);
                return dayActivities.reduce((total, a) => total + (a.suffer_score || 0), 0);
            });
            const mean = dailyLoads.reduce((a,b)=>a+b,0)/ (dailyLoads.length || 1);
            const variance = dailyLoads.reduce((s,v)=> s + Math.pow(v-mean,2),0) / (dailyLoads.length || 1);
            const sd = Math.sqrt(variance);
            const monotony = sd > 0 ? (mean / sd) : 10;
            let status = 'Balanced variability';
            if (monotony >= 2.0) status = 'High monotony — vary intensity to reduce fatigue risk';
            else if (monotony >= 1.5) status = 'Moderate monotony — consider mixing easy/hard days';
            card.textContent = `Mean daily load ${Math.round(mean)}, SD ${Math.round(sd)}, Monotony ${monotony.toFixed(2)}. ${status}.`;
        }

        // Calculate Fitness & Form Metrics (CTL, ATL, TSB)
        function updateStravaFitnessMetrics() {
            if (!fitnessData.strava || !fitnessData.strava.activities) return;

            // Get last 42 days of data for CTL calculation
            const today = new Date();
            const dailyTSS = {};

            // Build daily TSS (Training Stress Score) from suffer_score
            for (let i = 0; i < 42; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                dailyTSS[dateKey] = 0;
            }

            // Populate with actual activities
            fitnessData.strava.activities.forEach(a => {
                if (!a.start_date) return;
                const dateKey = a.start_date.split('T')[0];
                if (dailyTSS.hasOwnProperty(dateKey)) {
                    dailyTSS[dateKey] += (a.suffer_score || 0);
                }
            });

            // Calculate CTL (Chronic Training Load) - 42-day exponential moving average
            const ctlDecay = 1 - (1 / 42);
            let ctl = 0;
            Object.keys(dailyTSS).sort().reverse().forEach(date => {
                ctl = (ctl * ctlDecay) + dailyTSS[date];
            });

            // Calculate ATL (Acute Training Load) - 7-day exponential moving average
            const atlDecay = 1 - (1 / 7);
            let atl = 0;
            const last7Days = Object.keys(dailyTSS).sort().reverse().slice(0, 7);
            last7Days.forEach(date => {
                atl = (atl * atlDecay) + dailyTSS[date];
            });

            // Calculate TSB (Training Stress Balance) = CTL - ATL
            const tsb = ctl - atl;

            // Update UI
            document.getElementById('stravaFitness').textContent = Math.round(ctl);
            document.getElementById('stravaFatigue').textContent = Math.round(atl);

            const tsbElement = document.getElementById('stravaForm');
            tsbElement.textContent = tsb >= 0 ? `+${Math.round(tsb)}` : Math.round(tsb);

            // Determine form status
            let status, advice, color;
            if (tsb > 25) {
                status = 'Fresh 🌟';
                advice = 'Well rested - good time for key workouts';
                color = '#10b981';
            } else if (tsb > 5) {
                status = 'Ready 💪';
                advice = 'Optimal training readiness';
                color = '#3b82f6';
            } else if (tsb > -10) {
                status = 'Neutral ⚖️';
                advice = 'Balanced training load';
                color = '#f59e0b';
            } else if (tsb > -30) {
                status = 'Fatigued 😓';
                advice = 'Consider easier sessions';
                color = '#f97316';
            } else {
                status = 'Overreached ⚠️';
                advice = 'Recovery needed';
                color = '#ef4444';
            }

            document.getElementById('stravaFormStatus').textContent = status;
            document.getElementById('stravaFormStatus').style.color = color;
            document.getElementById('stravaFormAdvice').textContent = advice;
            tsbElement.style.color = color;

            // Calculate Relative Effort metrics
            updateStravaRelativeEffort();
        }

        function updateStravaRelativeEffort() {
            if (!fitnessData.strava || !fitnessData.strava.activities) return;

            // Get selected period from dropdown
            const periodSelector = document.getElementById('stravaPeriodSelector');
            const selectedDays = periodSelector ? parseInt(periodSelector.value) : 7;

            const periodStart = new Date();
            periodStart.setDate(periodStart.getDate() - selectedDays);

            const recentActivities = fitnessData.strava.activities.filter(a =>
                a && a.start_date && new Date(a.start_date) >= periodStart
            );

            // Calculate metrics from suffer_score (Strava's Relative Effort)
            const effortScores = recentActivities.map(a => a.suffer_score || 0).filter(s => s > 0);

            if (effortScores.length === 0) {
                document.getElementById('stravaRelativeEffort').textContent = '--';
                document.getElementById('stravaAvgEffort').textContent = '--';
                document.getElementById('stravaMaxEffort').textContent = '--';
                document.getElementById('stravaEffortCount').textContent = '0';
                document.getElementById('stravaWeeklyEffort').textContent = '--';
                return;
            }

            // Total relative effort
            const totalEffort = effortScores.reduce((sum, s) => sum + s, 0);
            document.getElementById('stravaRelativeEffort').textContent = Math.round(totalEffort);

            // Average per activity
            const avgEffort = totalEffort / effortScores.length;
            document.getElementById('stravaAvgEffort').textContent = Math.round(avgEffort);

            // Highest activity
            const maxEffort = Math.max(...effortScores);
            document.getElementById('stravaMaxEffort').textContent = Math.round(maxEffort);

            // Activities count
            document.getElementById('stravaEffortCount').textContent = effortScores.length;

            // Weekly average (normalize to per-week)
            const weeks = selectedDays / 7;
            const weeklyAvg = totalEffort / weeks;
            document.getElementById('stravaWeeklyEffort').textContent = Math.round(weeklyAvg);
        }

        // Update Fitness & Form Chart
        function updateStravaFitnessChart() {
            const canvas = document.getElementById('stravaFitnessChart');
            if (!canvas || !fitnessData.strava || !fitnessData.strava.activities) return;

            if (!charts.stravaFitness) {
                charts.stravaFitness = new Chart(canvas, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: ${Math.round(ctx.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            x: { display: true },
                            y: { display: true, title: { display: true, text: 'Load' } }
                        }
                    }
                });
            }

            // Calculate daily CTL and ATL over last 42 days
            const today = new Date();
            const labels = [];
            const ctlData = [];
            const atlData = [];
            const tsbData = [];
            const dailyTSS = {};

            // Initialize days
            for (let i = 41; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                labels.push(new Date(dateKey).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                dailyTSS[dateKey] = 0;
            }

            // Populate with activities
            fitnessData.strava.activities.forEach(a => {
                if (!a.start_date) return;
                const dateKey = a.start_date.split('T')[0];
                if (dailyTSS.hasOwnProperty(dateKey)) {
                    dailyTSS[dateKey] += (a.suffer_score || 0);
                }
            });

            // Calculate rolling CTL and ATL
            const ctlDecay = 1 - (1 / 42);
            const atlDecay = 1 - (1 / 7);
            let ctl = 0;
            let atl = 0;

            Object.keys(dailyTSS).sort().forEach(date => {
                ctl = (ctl * ctlDecay) + dailyTSS[date];
                atl = (atl * atlDecay) + dailyTSS[date];
                ctlData.push(ctl);
                atlData.push(atl);
                tsbData.push(ctl - atl);
            });

            charts.stravaFitness.data = {
                labels,
                datasets: [
                    { label: 'Fitness (CTL)', data: ctlData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.3, fill: true },
                    { label: 'Fatigue (ATL)', data: atlData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.3, fill: true },
                    { label: 'Form (TSB)', data: tsbData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3, fill: true }
                ]
            };
            charts.stravaFitness.update();
        }

        // Update Heart Rate Zones Chart
        function updateStravaHRZonesChart() {
            const canvas = document.getElementById('stravaHRZonesChart');
            if (!canvas || !fitnessData.strava || !fitnessData.strava.activities) return;

            if (!charts.stravaHRZones) {
                charts.stravaHRZones = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${Math.round(ctx.parsed.y)} minutes`
                                }
                            }
                        },
                        scales: {
                            x: { display: true },
                            y: { display: true, title: { display: true, text: 'Time (minutes)' } }
                        }
                    }
                });
            }

            // Get activities from selected period
            const periodSelector = document.getElementById('stravaPeriodSelector');
            const selectedDays = periodSelector ? parseInt(periodSelector.value) : 7;
            const periodStart = new Date();
            periodStart.setDate(periodStart.getDate() - selectedDays);

            const recentActivities = fitnessData.strava.activities.filter(a =>
                a && a.start_date && new Date(a.start_date) >= periodStart && a.average_heartrate
            );

            if (recentActivities.length === 0) {
                charts.stravaHRZones.data = {
                    labels: ['Zone 1', 'Zone 2', 'Zone 3', 'Zone 4', 'Zone 5'],
                    datasets: [{
                        label: 'Time in Zone',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#f97316', '#ef4444']
                    }]
                };
                charts.stravaHRZones.update();
                return;
            }

            // Prefer exact Strava-provided time_in_heart_rate_zone when present, fallback to estimation
            // Zone 1: <60%, Zone 2: 60-70%, Zone 3: 70-80%, Zone 4: 80-90%, Zone 5: >90%
            // Use max HR from activities or default to 190 when estimating
            let userMaxHR = 190;
            recentActivities.forEach(a => {
                if (a.max_heartrate && a.max_heartrate > userMaxHR) {
                    userMaxHR = a.max_heartrate;
                }
            });

            const zones = [0, 0, 0, 0, 0]; // minutes per zone

            recentActivities.forEach(a => {
                const movingTime = (a.moving_time || 0) / 60; // minutes
                const avgHR = a.average_heartrate;
                const maxHR = a.max_heartrate || avgHR;

                const timeInZones = a.time_in_heart_rate_zone || a.time_in_hr_zone || a.timeInHeartRateZone || null;
                if (Array.isArray(timeInZones) && timeInZones.length) {
                    timeInZones.forEach((sec, idx) => {
                        if (idx < 5) zones[idx] += (sec || 0) / 60;
                    });
                    return;
                }

                // Fallback: estimate distribution from avg/max HR
                if (!avgHR || movingTime <= 0) return;
                const avgPercent = (avgHR / userMaxHR) * 100;

                if (movingTime < 5) {
                    const zone = avgPercent < 60 ? 0 : avgPercent < 70 ? 1 : avgPercent < 80 ? 2 : avgPercent < 90 ? 3 : 4;
                    zones[zone] += movingTime;
                } else {
                    if (avgPercent < 65) {
                        zones[0] += movingTime * 0.7;
                        zones[1] += movingTime * 0.25;
                        zones[2] += movingTime * 0.05;
                    } else if (avgPercent < 75) {
                        zones[0] += movingTime * 0.2;
                        zones[1] += movingTime * 0.5;
                        zones[2] += movingTime * 0.25;
                        zones[3] += movingTime * 0.05;
                    } else if (avgPercent < 85) {
                        zones[1] += movingTime * 0.15;
                        zones[2] += movingTime * 0.5;
                        zones[3] += movingTime * 0.3;
                        zones[4] += movingTime * 0.05;
                    } else if (avgPercent < 95) {
                        zones[2] += movingTime * 0.2;
                        zones[3] += movingTime * 0.6;
                        zones[4] += movingTime * 0.2;
                    } else {
                        zones[3] += movingTime * 0.4;
                        zones[4] += movingTime * 0.6;
                    }
                }
            });

            charts.stravaHRZones.data = {
                labels: ['Zone 1 (Easy)', 'Zone 2 (Moderate)', 'Zone 3 (Tempo)', 'Zone 4 (Threshold)', 'Zone 5 (VO2 Max)'],
                datasets: [{
                    label: 'Time in Zone',
                    data: zones.map(z => Math.round(z)),
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#f97316', '#ef4444'],
                    borderRadius: 6
                }]
            };
            charts.stravaHRZones.update();

            // Update time breakdown card
            const formatTime = (minutes) => {
                if (minutes === 0) return '0h 0m';
                const hours = Math.floor(minutes / 60);
                const mins = Math.round(minutes % 60);
                return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
            };

            // Update each zone
            for (let i = 0; i < 5; i++) {
                const timeElement = document.getElementById(`hrZone${i + 1}Time`);
                const minutesElement = document.getElementById(`hrZone${i + 1}Minutes`);

                if (timeElement && minutesElement) {
                    const totalMinutes = Math.round(zones[i]);
                    timeElement.textContent = formatTime(totalMinutes);
                    minutesElement.textContent = `${totalMinutes} min`;
                }
            }
        }

        function updateOuraTrendCharts() {
            if ((!charts.ouraTrendRS && !charts.ouraTrendHRVHR) || !fitnessData.oura) return;
            const days = getInsightWindowDays();
            const today = new Date();
            const labels = [];
            const labelKeys = [];
            for (let i=days-1;i>=0;i--){ const d = new Date(today); d.setDate(d.getDate()-i); labels.push(d.toLocaleDateString('en-US',{weekday:'short'})); labelKeys.push(d.toISOString().split('T')[0]); }
            const readiness = labelKeys.map(k => (fitnessData.oura.readiness || []).find(r => r.day === k)?.score || null);
            const sleepScore = labelKeys.map(k => {
                const s = (fitnessData.oura.sleep || []).find(x => x.day === k);
                if (!s) return null;
                const efficiency = s.efficiency ?? 85;
                const total = (s.total_sleep_duration || 0) / 3600;
                const deep = (s.deep_sleep_duration || 0) / 3600;
                const rem = (s.rem_sleep_duration || 0) / 3600;
                const latency = s.latency || 0;
                const durationScore = Math.min(100, Math.max(0, 100 - Math.abs(total - 8) * 12.5));
                const deepScore = total > 0 ? Math.min(100, (deep / total) * 100 * 4) : 0;
                const remScore = total > 0 ? Math.min(100, (rem / total) * 100 * 4) : 0;
                const latencyScore = Math.max(0, 100 - (latency / 60) * 5);
                return Math.round(efficiency * 0.3 + durationScore * 0.25 + deepScore * 0.2 + remScore * 0.15 + latencyScore * 0.1);
            });
            const hrv = labelKeys.map(k => (fitnessData.oura.sleep || []).find(s => s.day === k)?.average_hrv || null);
            const rhr = labelKeys.map(k => (fitnessData.oura.sleep || []).find(s => s.day === k)?.average_heart_rate || null);
            if (charts.ouraTrendRS) {
                charts.ouraTrendRS.data = {
                    labels,
                    datasets: [
                        { label: 'Readiness', data: readiness, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)', tension: 0.3 },
                        { label: 'Sleep Score', data: sleepScore, borderColor: '#7c3aed', backgroundColor: 'rgba(124,58,237,0.2)', tension: 0.3 }
                    ]
                };
                charts.ouraTrendRS.update();
            }
            if (charts.ouraTrendHRVHR) {
                charts.ouraTrendHRVHR.data = {
                    labels,
                    datasets: [
                        { label: 'HRV (ms)', data: hrv, borderColor: '#0ea5e9', backgroundColor: 'rgba(14,165,233,0.2)', tension: 0.3, yAxisID: 'y' },
                        { label: 'RHR (bpm)', data: rhr, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.2)', tension: 0.3, yAxisID: 'y1' }
                    ]
                };
                charts.ouraTrendHRVHR.options.scales = { y: { position: 'left' }, y1: { position: 'right' } };
                charts.ouraTrendHRVHR.update();
            }
        }

        function updateOuraConsistencyCard() {
            const el = document.getElementById('ouraConsistencyText');
            if (!el || !fitnessData.oura || !fitnessData.oura.sleep) return;
            const days = getInsightWindowDays();
            const recent = fitnessData.oura.sleep.slice(-days);
            const toMinutesFromMidnight = (ts) => {
                if (!ts) return null;
                const d = new Date(ts);
                return d.getHours()*60 + d.getMinutes();
            };

            const bedTimes = recent.map(s => toMinutesFromMidnight(s.bedtime_start || s.start)).filter(v => v !== null);
            const wakeTimes = recent.map(s => toMinutesFromMidnight(s.bedtime_end || s.end)).filter(v => v !== null);
            if (bedTimes.length < 3 || wakeTimes.length < 3) {
                el.textContent = 'Not enough timing data to assess consistency.';
                return;
            }
            const stat = (arr)=>{ const m=arr.reduce((a,b)=>a+b,0)/arr.length; const v=arr.reduce((s,v)=>s+Math.pow(v-m,2),0)/arr.length; return {m,sd:Math.sqrt(v)} };
            const b = stat(bedTimes), w = stat(wakeTimes);
            el.textContent = `Bedtime variability: ${formatDuration(b.sd)}, Wake time variability: ${formatDuration(w.sd)}. Aim for <1h.`;
        }

        function updateOuraSleepStagesChart() {
            if (!charts.ouraSleepStages) return;
            
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const recentSleep = fitnessData.oura.sleep.filter(s => new Date(s.day) >= lastWeek);
            
            charts.ouraSleepStages.data = {
                labels: recentSleep.map(s => new Date(s.day).toLocaleDateString('en-US', { weekday: 'short' })),
                datasets: [
                    {
                        label: 'Deep Sleep (h)',
                        data: recentSleep.map(s => Math.round((s.deep_sleep_duration || 0) / 3600 * 10) / 10),
                        backgroundColor: '#1e40af'
                    },
                    {
                        label: 'REM Sleep (h)',
                        data: recentSleep.map(s => Math.round((s.rem_sleep_duration || 0) / 3600 * 10) / 10),
                        backgroundColor: '#7c3aed'
                    },
                    {
                        label: 'Light Sleep (h)',
                        data: recentSleep.map(s => Math.round((s.light_sleep_duration || 0) / 3600 * 10) / 10),
                        backgroundColor: '#06b6d4'
                    }
                ]
            };
            charts.ouraSleepStages.update();
        }

        function updateOuraCorrelationChart() {
            if (!charts.ouraCorrelation) return;
            
            const correlationData = fitnessData.oura.readiness.map(r => {
                const sleepDay = fitnessData.oura.sleep.find(s => s.day === r.day);
                return {
                    x: sleepDay?.average_hrv || 0,
                    y: r.score || 0
                };
            }).filter(point => point.x > 0);

            charts.ouraCorrelation.data = {
                datasets: [{
                    label: 'Readiness vs HRV',
                    data: correlationData,
                    backgroundColor: '#B45CF3',
                    pointRadius: 6
                }]
            };
            
            charts.ouraCorrelation.options.scales = {
                x: { title: { display: true, text: 'HRV (ms)' } },
                y: { title: { display: true, text: 'Readiness Score' } }
            };
            charts.ouraCorrelation.update();
        }

        // ===== ANALYTICS =====
        function updateAnalytics() {
            console.log('📊 updateAnalytics() called');
            updateAthlytxScore();
            console.log('📊 About to call updateDeviceSpecificData()...');
            updateDeviceSpecificData();
            console.log('📊 updateDeviceSpecificData() completed');
            updateConnectionStatus();
            generateAIInsights();
            
            // Update running analytics if on running tab
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'running') {
                updateRunningAnalytics();
            }
        }

        function computeReadiness(components) {
            const rec = components.recovery ?? null;
            const slp = components.sleep ?? null;
            const hrv = components.hrv ?? null;
            const loadScore = components.strain ?? null; // higher is better
            const good = v => v === null || v >= 65;
            const strong = v => v === null || v >= 75;
            const strainOk = loadScore === null || loadScore >= 70;
            let type = 'Maintain';
            if (strong(rec) && good(slp) && good(hrv) && strainOk) type = 'Push';
            if ((rec !== null && rec < 50) || ((hrv !== null && hrv < 45) && (slp !== null && slp < 60))) type = 'Deload';
            const message = type === 'Push'
                ? 'You have green lights across recovery metrics. Plan a key session or sustained workload today.'
                : type === 'Maintain'
                ? 'Mixed signals. Maintain intensity or focus on quality technique without overreaching.'
                : 'Recovery flags detected. Reduce intensity/volume 30–50% and emphasize sleep and nutrition.';
            const priority = type === 'Deload' ? 'high' : (type === 'Maintain' ? 'medium' : 'positive');
            return { type, message, priority };
        }

        function updateReadinessHero(readiness) {
            const messageEl = document.getElementById('readinessMessage');
            const iconEl = document.getElementById('readinessIcon');

            if (!messageEl || !iconEl) return;

            // Update message with meaningful athlete-focused text
            const messages = {
                'Push': 'You\'re primed to perform. Go crush that key workout!',
                'Maintain': 'Keep it steady. Quality over quantity today.',
                'Deload': 'Recovery mode. Listen to your body and rest up.'
            };

            messageEl.textContent = messages[readiness.type] || 'Connect your devices to see your status';

            // Update icon color class
            iconEl.classList.remove('optimal', 'good', 'moderate', 'low');
            if (readiness.type === 'Push') {
                iconEl.classList.add('optimal');
            } else if (readiness.type === 'Maintain') {
                iconEl.classList.add('moderate');
            } else if (readiness.type === 'Deload') {
                iconEl.classList.add('low');
            }
        }

        function buildDailyMetrics(days = 7) {
            const today = new Date();
            const start = new Date(today.getFullYear(), today.getMonth(), today.getDate() - (days - 1));
            const iso = d => new Date(d).toISOString().split('T')[0];
            const isWithin = d => new Date(d) >= start;
            const daily = { stravaLoad: {}, whoopRecovery: {}, whoopStrain: {}, whoopSleepPerf: {}, ouraReadiness: {}, ouraSleepScore: {}, ouraHRV: {} };

            // Strava: daily training load (suffer_score sum)
            if (fitnessData.strava?.activities?.length) {
                for (const a of fitnessData.strava.activities) {
                    if (!a?.start_date || !isWithin(a.start_date)) continue;
                    const key = iso(a.start_date);
                    daily.stravaLoad[key] = (daily.stravaLoad[key] || 0) + (a.suffer_score || 0);
                }
            }

            // Whoop recovery + HRV + strain + sleep performance
            if (fitnessData.whoop?.recovery?.length) {
                for (const r of fitnessData.whoop.recovery) {
                    const d = r.created_at || r.date;
                    if (!d || !isWithin(d)) continue;
                    const key = iso(d);
                    const rec = r.score?.recovery_score;
                    if (rec !== undefined) daily.whoopRecovery[key] = rec > 1 ? rec : rec * 100;
                    const hrv = r.score?.hrv_rmssd_milli;
                    if (hrv !== undefined) daily.ouraHRV[key] = hrv; // reuse map for HRV plotting
                }
            }
            if (fitnessData.whoop?.cycles?.length) {
                for (const c of fitnessData.whoop.cycles) {
                    const d = c.start || c.created_at || c.day || c.updated_at;
                    if (!d || !isWithin(d)) continue;
                    const key = iso(d);
                    const s = c.score?.strain;
                    if (s !== undefined) daily.whoopStrain[key] = s;
                }
            }
            if (fitnessData.whoop?.sleep?.length) {
                for (const s of fitnessData.whoop.sleep) {
                    const d = s.created_at || s.period_id || s.cycle_id || s.start; // prefer start time
                    const t = s.start || s.end || s.created_at;
                    if (!t || !isWithin(t)) continue;
                    const key = iso(t);
                    const perf = s.score?.sleep_performance_percentage;
                    if (perf !== undefined) daily.whoopSleepPerf[key] = perf > 1 ? perf : perf * 100;
                }
            }

            // Oura readiness and sleep (compute daily composite similar to overview calc)
            if (fitnessData.oura?.readiness?.length) {
                for (const r of fitnessData.oura.readiness) {
                    if (!r?.day || !isWithin(r.day)) continue;
                    daily.ouraReadiness[r.day] = r.score || 0;
                }
            }
            if (fitnessData.oura?.sleep?.length) {
                for (const s of fitnessData.oura.sleep) {
                    if (!s?.day || !isWithin(s.day)) continue;
                    const efficiency = s.efficiency ?? 85;
                    const total = (s.total_sleep_duration || 0) / 3600;
                    const deep = (s.deep_sleep_duration || 0) / 3600;
                    const rem = (s.rem_sleep_duration || 0) / 3600;
                    const latency = s.latency || 0;
                    const durationScore = Math.min(100, Math.max(0, 100 - Math.abs(total - 8) * 12.5));
                    const deepScore = total > 0 ? Math.min(100, (deep / total) * 100 * 4) : 0;
                    const remScore = total > 0 ? Math.min(100, (rem / total) * 100 * 4) : 0;
                    const latencyScore = Math.max(0, 100 - (latency / 60) * 5);
                    const comp = (efficiency * 0.3) + (durationScore * 0.25) + (deepScore * 0.2) + (remScore * 0.15) + (latencyScore * 0.1);
                    daily.ouraSleepScore[s.day] = Math.round(comp);
                    if (s.average_hrv) daily.ouraHRV[s.day] = s.average_hrv;
                }
            }
            return daily;
        }

        function pearsonR(points) {
            if (!points || points.length < 2) return null;
            const xs = points.map(p => p.x);
            const ys = points.map(p => p.y);
            const n = points.length;
            const mean = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
            const mx = mean(xs), my = mean(ys);
            let num = 0, dx2 = 0, dy2 = 0;
            for (let i=0;i<n;i++){ const dx = xs[i]-mx, dy=ys[i]-my; num += dx*dy; dx2+=dx*dx; dy2+=dy*dy; }
            const den = Math.sqrt(dx2*dy2);
            if (den === 0) return 0;
            return num/den;
        }

        function updateCorrelationCharts(daily) {
            if (!charts.loadRecovery && document.getElementById('loadRecoveryChart')) {
                charts.loadRecovery = new Chart(document.getElementById('loadRecoveryChart'), {
                    type: 'scatter',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true },
                            tooltip: { callbacks: { label: ctx => `Load ${ctx.parsed.x}, Recovery ${ctx.parsed.y}` } }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Strava Load (suffer score)' } },
                            y: { title: { display: true, text: 'Recovery / Readiness' }, min: 0, max: 100 }
                        }
                    }
                });
            }

            if (!charts.sleepLoad && document.getElementById('sleepLoadChart')) {
                charts.sleepLoad = new Chart(document.getElementById('sleepLoadChart'), {
                    type: 'scatter',
                    data: { datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true },
                            tooltip: { callbacks: { label: ctx => `Sleep ${ctx.parsed.x}%, Next-day Load ${ctx.parsed.y}` } }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Sleep Score / Performance (%)' }, min: 0, max: 100 },
                            y: { title: { display: true, text: 'Next-Day Load (suffer score)' } }
                        }
                    }
                });
            }

            if (charts.loadRecovery) {
                const whoopPoints = [];
                const ouraPoints = [];
                const days = Array.from(new Set([...Object.keys(daily.stravaLoad), ...Object.keys(daily.whoopRecovery), ...Object.keys(daily.ouraReadiness)])).sort();
                for (const d of days) {
                    const load = daily.stravaLoad[d];
                    if (load !== undefined) {
                        if (daily.whoopRecovery[d] !== undefined) whoopPoints.push({ x: load, y: daily.whoopRecovery[d] });
                        if (daily.ouraReadiness[d] !== undefined) ouraPoints.push({ x: load, y: daily.ouraReadiness[d] });
                    }
                }
                charts.loadRecovery.data = {
                    datasets: [
                        { label: 'Whoop Recovery', data: whoopPoints, backgroundColor: '#10b981' },
                        { label: 'Oura Readiness', data: ouraPoints, backgroundColor: '#B45CF3' }
                    ]
                };
                charts.loadRecovery.update();

                const rEl = document.getElementById('loadRecoveryR');
                if (rEl) {
                    const combined = whoopPoints.concat(ouraPoints);
                    const r = pearsonR(combined);
                    rEl.textContent = `r: ${r===null?'--':(Math.round(r*100)/100)}`;
                }
            }

            if (charts.sleepLoad) {
                const whoopPoints = [];
                const ouraPoints = [];
                const sleepDays = Array.from(new Set([...Object.keys(daily.whoopSleepPerf), ...Object.keys(daily.ouraSleepScore)])).sort();
                for (const d of sleepDays) {
                    const next = new Date(d);
                    next.setDate(next.getDate() + 1);
                    const nextKey = next.toISOString().split('T')[0];
                    const nextLoad = daily.stravaLoad[nextKey];
                    if (nextLoad !== undefined) {
                        if (daily.whoopSleepPerf[d] !== undefined) whoopPoints.push({ x: daily.whoopSleepPerf[d], y: nextLoad });
                        if (daily.ouraSleepScore[d] !== undefined) ouraPoints.push({ x: daily.ouraSleepScore[d], y: nextLoad });
                    }
                }
                charts.sleepLoad.data = {
                    datasets: [
                        { label: 'Whoop Sleep → Next-day Load', data: whoopPoints, backgroundColor: '#059669' },
                        { label: 'Oura Sleep → Next-day Load', data: ouraPoints, backgroundColor: '#7c3aed' }
                    ]
                };
                charts.sleepLoad.update();

                const rEl = document.getElementById('sleepLoadR');
                if (rEl) {
                    const combined = whoopPoints.concat(ouraPoints);
                    const r = pearsonR(combined);
                    rEl.textContent = `r: ${r===null?'--':(Math.round(r*100)/100)}`;
                }
            }
        }

        function generateAIInsights() {
            const insights = [];
            const { score, components } = calculateAthlytxScore();
            const daily = buildDailyMetrics(getInsightWindowDays());
            updateCorrelationCharts(daily);
            
            // Advanced Recovery Analysis
            if (fitnessData.oura && fitnessData.oura.sleep && fitnessData.oura.readiness) {
                const recentSleep = fitnessData.oura.sleep.slice(-7);
                const recentReadiness = fitnessData.oura.readiness.slice(-7);
                
                if (recentSleep.length >= 3) {
                    const avgSleepScore = recentSleep.reduce((sum, s) => sum + (s.score || 0), 0) / recentSleep.length;
                    const avgHRV = recentSleep.reduce((sum, s) => sum + (s.average_hrv || 0), 0) / recentSleep.length;
                    const avgRHR = recentSleep.reduce((sum, s) => sum + (s.average_heart_rate || 0), 0) / recentSleep.length;
                    
                    // HRV Trend Analysis
                    const hrvTrend = calculateTrend(recentSleep.map(s => s.average_hrv || 0));
                    if (hrvTrend < -0.1) {
                        insights.push({
                            title: '📉 Declining HRV Trend',
                            message: `Your HRV has decreased ${Math.abs(Math.round(hrvTrend * 10))}% over the past week. This may indicate accumulated stress or inadequate recovery. Consider incorporating more rest days or lighter training sessions.`,
                            priority: 'high',
                            category: 'recovery'
                        });
                    } else if (hrvTrend > 0.1) {
                        insights.push({
                            title: 'Improving Recovery Capacity',
                            message: `Your HRV has increased ${Math.round(hrvTrend * 10)}% this week! Your body is adapting well to training. This is an optimal time to maintain or slightly increase training intensity.`,
                            priority: 'positive',
                            category: 'progress'
                        });
                    }
                    
                    // Sleep Consistency Analysis
                    const sleepDurations = recentSleep.map(s => s.total_sleep_duration || 0);
                    const sleepVariability = calculateVariability(sleepDurations);
                    if (sleepVariability > 3600) { // More than 1 hour variation
                        insights.push({
                            title: '⏰ Inconsistent Sleep Schedule',
                            message: `Your sleep duration varies by ${Math.round(sleepVariability / 3600 * 10) / 10} hours between nights. Consistent sleep timing can improve recovery by up to 20%. Try setting a fixed bedtime alarm.`,
                            priority: 'medium',
                            category: 'coaching-tip'
                        });
                    }

                    // Deep Sleep Analysis
                    const avgDeepSleep = recentSleep.reduce((sum, s) => sum + (s.deep_sleep_duration || 0), 0) / recentSleep.length;
                    const deepSleepPercentage = (avgDeepSleep / sleepDurations.reduce((a, b) => a + b, 0)) * sleepDurations.length * 100;
                    if (deepSleepPercentage < 13) {
                        insights.push({
                            title: '🛏️ Low Deep Sleep',
                            message: `You're averaging only ${Math.round(deepSleepPercentage)}% deep sleep (target: 13-23%). Try avoiding screens 2 hours before bed, keeping your room cool (65-68°F), and limiting alcohol intake.`,
                            priority: 'medium',
                            category: 'coaching-tip'
                        });
                    }
                }
            }

            // Advanced Training Load Analysis
            if (fitnessData.strava && fitnessData.strava.activities) {
                const activities = fitnessData.strava.activities;
                const lastWeek = activities.filter(a => new Date(a.start_date) >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
                const previousWeek = activities.filter(a => {
                    const date = new Date(a.start_date);
                    return date >= new Date(Date.now() - 14 * 24 * 60 * 60 * 1000) && 
                           date < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                });
                
                // Acute:Chronic Workload Ratio
                const currentLoad = lastWeek.reduce((sum, a) => sum + (a.suffer_score || 0), 0);
                const previousLoad = previousWeek.reduce((sum, a) => sum + (a.suffer_score || 0), 0);
                const workloadRatio = previousLoad > 0 ? currentLoad / previousLoad : 0;
                
                if (workloadRatio > INSIGHT_THRESHOLDS.workloadRatioHigh) {
                    insights.push({
                        title: '⚠️ Rapid Training Load Increase',
                        message: `Your training load increased ${Math.round((workloadRatio - 1) * 100)}% this week. This aggressive increase elevates injury risk by 40%. Consider a recovery week or reducing volume by 20-30%.`,
                        priority: 'high',
                        category: 'running-advice'
                    });
                } else if (workloadRatio < INSIGHT_THRESHOLDS.workloadRatioLow && previousLoad > 100) {
                    insights.push({
                        title: 'Significant Load Reduction',
                        message: `Training load dropped ${Math.round((1 - workloadRatio) * 100)}%. While recovery is important, maintain at least 50% of your usual load to prevent detraining.`,
                        priority: 'medium',
                        category: 'running-advice'
                    });
                }
                
                // Training Monotony Analysis
                const dailyLoads = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    const dayLoad = lastWeek.filter(a => a.start_date.split('T')[0] === date)
                        .reduce((sum, a) => sum + (a.suffer_score || 0), 0);
                    dailyLoads.push(dayLoad);
                }
                
                const loadVariability = calculateVariability(dailyLoads);
                if (loadVariability < 20 && currentLoad > 200) {
                    insights.push({
                        title: '🔄 Monotonous Training Pattern',
                        message: `Your daily training loads are very similar. Varying intensity (easy/hard days) can improve adaptation and reduce burnout risk. Try the 80/20 principle: 80% easy, 20% hard.`,
                        priority: 'medium',
                        category: 'running-advice'
                    });
                }
            }
            
            // Cross-Platform Correlation Insights
            if (score !== null && components.recovery !== null && components.load !== null) {
                // Recovery-Load Mismatch Detection
                if (components.recovery < 60 && components.load < 50) {
                    insights.push({
                        title: '🔍 Recovery-Performance Mismatch',
                        message: `Low recovery (${Math.round(components.recovery)}) despite low training load suggests non-training stressors. Check work stress, nutrition, hydration, or potential illness.`,
                        priority: 'high',
                        category: 'recovery'
                    });
                }
                
                // Optimization Windows
                if (components.recovery > 80 && components.hrv > 80 && components.sleep > 80) {
                    insights.push({
                        title: '🚀 Peak Performance Window',
                        message: `All recovery markers are excellent! This is an ideal time for high-intensity work, testing new PRs, or tackling challenging workouts. Your body is primed for adaptation.`,
                        priority: 'positive',
                        category: 'progress'
                    });
                }
                
                // Predictive Warnings
                if (components.rhr !== null && components.hrv !== null) {
                    const stressScore = (100 - components.rhr) + (100 - components.hrv);
                    if (stressScore > 80) {
                        insights.push({
                            title: '🔮 Early Fatigue Warning',
                            message: `Combined stress markers suggest fatigue is building before you feel it. Proactively reduce intensity over the next 2-3 days to prevent overreaching.`,
                            priority: 'medium',
                            category: 'recovery'
                        });
                    }
                }
            }
            
            // Whoop-specific: Overreaching detection (high strain + declining recovery)
            if (Object.keys(daily.whoopStrain).length >= 3 && Object.keys(daily.whoopRecovery).length >= 3) {
                const days = Object.keys(daily.whoopStrain).sort();
                const last3 = days.slice(-3);
                const avgStrain3 = last3.reduce((s, d) => s + (daily.whoopStrain[d] || 0), 0) / last3.length;
                const recDays = Object.keys(daily.whoopRecovery).sort();
                const rec3 = recDays.slice(-3).map(d => daily.whoopRecovery[d]);
                const recTrend = calculateTrend(rec3);
                if (avgStrain3 >= INSIGHT_THRESHOLDS.overreachingAvgStrain || (avgStrain3 >= INSIGHT_THRESHOLDS.overreachingAvgWithDecline && recTrend < 0)) {
                    insights.push({
                        title: '🔥 Overreaching Risk Detected',
                        message: `High multi-day strain (avg ${avgStrain3.toFixed(1)}) with falling recovery. Plan a deload: cut volume 30–50% for 2–3 days and prioritize sleep.`,
                        priority: 'high',
                        category: 'recovery'
                    });
                }
            }

            // Sleep debt via Whoop sleep performance
            if (Object.keys(daily.whoopSleepPerf).length >= 3) {
                const vals = Object.values(daily.whoopSleepPerf).slice(-3);
                const avgPerf3 = vals.reduce((a, b) => a + b, 0) / vals.length;
                if (avgPerf3 < INSIGHT_THRESHOLDS.sleepDebtPerfLow) {
                    insights.push({
                        title: '😴 Sleep Debt Accumulating',
                        message: `Your Whoop sleep performance averaged ${Math.round(avgPerf3)}% over the last 3 nights. Aim for 95–105% to restore recovery capacity.`,
                        priority: 'medium',
                        category: 'recovery'
                    });
                }
            }

            // Cross-device: Load up, Recovery down (last 3 vs previous 3 days)
            const stravaDates = Object.keys(daily.stravaLoad).sort();
            const recDates = Object.keys({ ...(daily.whoopRecovery || {}), ...(daily.ouraReadiness || {}) }).sort();
            if (stravaDates.length >= 6 && recDates.length >= 6) {
                const sPrev = stravaDates.slice(-6, -3).map(d => daily.stravaLoad[d] || 0);
                const sLast = stravaDates.slice(-3).map(d => daily.stravaLoad[d] || 0);
                const rPrev = recDates.slice(-6, -3).map(d => (daily.whoopRecovery[d] ?? daily.ouraReadiness[d] ?? 0));
                const rLast = recDates.slice(-3).map(d => (daily.whoopRecovery[d] ?? daily.ouraReadiness[d] ?? 0));
                const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
                const loadUp = avg(sPrev) > 0 ? (avg(sLast) - avg(sPrev)) / avg(sPrev) : 0;
                const recDown = avg(rPrev) > 0 ? (avg(rLast) - avg(rPrev)) / avg(rPrev) : 0;
                if (loadUp > INSIGHT_THRESHOLDS.loadUpPct && recDown < INSIGHT_THRESHOLDS.recDownPct) {
                    insights.push({
                        title: '⚖️ Load ↑ while Recovery ↓',
                        message: `Training load rose ${Math.round(loadUp * 100)}% while recovery fell ${Math.round(Math.abs(recDown) * 100)}%. Schedule a deload and prioritize sleep to avoid burnout.`,
                        priority: 'high',
                        category: 'recovery'
                    });
                }
            }

            // Sleep Agreement (Whoop vs Oura)
            const overlapDays = Object.keys(daily.ouraSleepScore).filter(d => daily.whoopSleepPerf[d] !== undefined);
            if (overlapDays.length >= 3) {
                const absDiffs = overlapDays.map(d => Math.abs((daily.ouraSleepScore[d] || 0) - (daily.whoopSleepPerf[d] || 0)));
                const meanDiff = absDiffs.reduce((a, b) => a + b, 0) / absDiffs.length;
                const agreement = Math.max(0, 100 - meanDiff);
                const msgLow = agreement < INSIGHT_THRESHOLDS.sleepAgreementGood ? 'Devices disagree often; use trends over single-day scores.' : 'Devices largely agree; sleep assessments are consistent.';
                insights.push({
                    title: `🧪 Sleep Agreement: ${Math.round(agreement)}%`,
                    message: `Whoop vs Oura sleep scores differ by ~${Math.round(meanDiff)} points on average. ${msgLow}`,
                    priority: agreement < INSIGHT_THRESHOLDS.sleepAgreementGood ? 'medium' : 'positive',
                    category: 'coaching-tip'
                });
            }

            // Simple Training Readiness Recommendation
            const readiness = computeReadiness(components);
            insights.push({
                title: `🏁 Today's Readiness: ${readiness.type}`,
                message: readiness.message,
                priority: readiness.priority,
                category: 'coaching-tip'
            });

            // Summary when device sleep disagreement is high
            const sleepOverlapDays = Object.keys(daily.ouraSleepScore).filter(d => daily.whoopSleepPerf[d] !== undefined);
            if (sleepOverlapDays.length >= 3) {
                const absDiffs = sleepOverlapDays.map(d => Math.abs((daily.ouraSleepScore[d] || 0) - (daily.whoopSleepPerf[d] || 0)));
                const meanDiff = absDiffs.reduce((a, b) => a + b, 0) / absDiffs.length;
                const agreement = Math.max(0, 100 - meanDiff);
                if (agreement < INSIGHT_THRESHOLDS.sleepAgreementLow) {
                    insights.push({
                        title: '🔍 Devices Disagree on Sleep',
                        message: 'Your devices show low sleep agreement. Rely on multi-day trends and keep sleep hygiene consistent (timing, dark/cool room) while we learn your baseline.',
                        priority: 'medium',
                        category: 'coaching-tip'
                    });
                }
            }

            // Weekly Recommendations
            const dayOfWeek = new Date().getDay();
            if (score !== null) {
                if (dayOfWeek === 1 && score < 70) { // Monday
                    insights.push({
                        title: '📅 Monday Recovery Protocol',
                        message: `Starting the week with a score of ${score}. Consider making this an active recovery day with light movement, stretching, or yoga to set up a strong training week.`,
                        priority: 'medium',
                        category: 'coaching-tip'
                    });
                } else if (dayOfWeek === 5 && components.strain > 70) { // Friday
                    insights.push({
                        title: 'Weekend Training Strategy',
                        message: `High training load heading into the weekend. If planning long sessions, ensure proper fueling and consider scheduling easier efforts for early next week.`,
                        priority: 'medium',
                        category: 'coaching-tip'
                    });
                }
            }

            // Sort insights by priority
            insights.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, positive: 2 };
                return (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3);
            });

            if (insights.length === 0) {
                insights.push({
                    title: 'Waiting for Data',
                    message: 'Connect more devices to unlock personalized insights about your training and recovery patterns.',
                    priority: 'low',
                    category: 'coaching-tip'
                });
            }

            const insightsContainer = document.getElementById('aiInsights');
            if (insightsContainer) {
                // Store all insights globally for filtering
                window.allInsights = insights;
                renderFilteredInsights();
            }
        }

        // Function to render filtered insights based on selected category
        function renderFilteredInsights() {
            const insightsContainer = document.getElementById('aiInsights');
            const categoryFilter = document.getElementById('insightCategoryFilter');
            const selectedCategory = categoryFilter ? categoryFilter.value : 'all';

            if (!insightsContainer) return;

            // If insights haven't been generated yet, show loading message
            if (!window.allInsights || window.allInsights.length === 0) {
                console.log('⚠️ No insights available yet');
                insightsContainer.innerHTML = `
                    <div class="insight-card low">
                        <h4>Loading Insights...</h4>
                        <p>Analyzing your data to generate personalized insights.</p>
                    </div>
                `;
                return;
            }

            console.log(`📊 Filtering ${window.allInsights.length} insights by category: ${selectedCategory}`);

            // Filter insights based on selected category
            const filteredInsights = selectedCategory === 'all'
                ? window.allInsights
                : window.allInsights.filter(insight => insight.category === selectedCategory);

            console.log(`✅ Found ${filteredInsights.length} insights in category: ${selectedCategory}`);

            // Render filtered insights
            if (filteredInsights.length === 0) {
                insightsContainer.innerHTML = `
                    <div class="insight-card low">
                        <h4>No Insights in This Category</h4>
                        <p>There are no insights available for this category yet. Try selecting a different category or connect more devices for more insights.</p>
                    </div>
                `;
            } else {
                insightsContainer.innerHTML = filteredInsights.map(insight => `
                    <div class="insight-card ${insight.priority}" data-category="${insight.category || 'general'}">
                        <h4>${insight.title}</h4>
                        <p>${insight.message}</p>
                    </div>
                `).join('');
            }
        }

        // Helper functions for advanced analytics
        function calculateTrend(values) {
            if (values.length < 2) return 0;
            const n = values.length;
            const sumX = (n * (n - 1)) / 2;
            const sumY = values.reduce((a, b) => a + b, 0);
            const sumXY = values.reduce((sum, y, x) => sum + x * y, 0);
            const sumXX = (n * (n - 1) * (2 * n - 1)) / 6;
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const avgY = sumY / n;
            return avgY > 0 ? slope / avgY : 0; // Return relative change
        }
        
        function calculateVariability(values) {
            if (values.length < 2) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(variance);
        }

        // Garmin data fetching function (OAuth 2.0)
        async function fetchGarminData(tokenParam) {
            console.log('🔵 fetchGarminData() called with tokenParam:', tokenParam ? 'provided' : 'not provided');
            const button = document.querySelector('.btn-garmin');

            try {
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
                button.disabled = true;

                const token = tokenParam || localStorage.getItem('garmin_token');
                console.log('🔵 Token exists:', !!token);

                if (!token) {
                    throw new Error('No Garmin access token found');
                }

                // NOTE: Fetch data from database (received via PUSH webhooks)
                // This is compliant - we're NOT making PULL requests to Garmin API
                const userId = localStorage.getItem('userId');

                const [activitiesResponse, dailiesResponse] = await Promise.allSettled([
                    fetchWithRetry(`${API_CONFIG.backend}/api/garmin/db/activities?userId=${userId}`),
                    fetchWithRetry(`${API_CONFIG.backend}/api/garmin/db/dailies?userId=${userId}`)
                ]);

                fitnessData.garmin = {
                    dailySummary: dailiesResponse.status === 'fulfilled' && dailiesResponse.value.ok
                        ? await dailiesResponse.value.json()
                        : null,
                    activities: activitiesResponse.status === 'fulfilled' && activitiesResponse.value.ok
                        ? await activitiesResponse.value.json()
                        : null,
                    sleep: null,
                    connected: true,
                    pushOnly: true,
                    lastUpdated: new Date().toISOString()
                };

                button.innerHTML = '<span class="check-icon">✓</span> Connected';
                button.classList.add('connected');
                button.disabled = false;

                // Show disconnect button
                const disconnectBtn = document.querySelector('.btn-garmin-disconnect');
                if (disconnectBtn) {
                    disconnectBtn.style.display = 'block';
                }

                updateConnectionStatus();
                showMessage('Garmin connected! Data loaded from PUSH webhooks.', 'success');
                console.log('🔵 fetchGarminData about to call updateAnalytics()...');
                updateAnalytics(); // Trigger UI update to display Garmin data
                console.log('🔵 fetchGarminData updateAnalytics() completed');

            } catch (error) {
                console.error('Garmin data fetch error:', error);
                // Check if we have a token - if yes, still show connected
                const token = tokenParam || localStorage.getItem('garmin_token');
                if (token) {
                    fitnessData.garmin = {
                        dailySummary: null,
                        activities: null,
                        sleep: null,
                        connected: true
                    };

                    button.innerHTML = '<span class="check-icon">✓</span> Connected';
                    button.classList.add('connected');
                    button.disabled = false;

                    // Show disconnect button
                    const disconnectBtn = document.querySelector('.btn-garmin-disconnect');
                    if (disconnectBtn) {
                        disconnectBtn.style.display = 'block';
                    }

                    showMessage('Garmin connected! Data will sync automatically.', 'success');
                } else {
                    showMessage(`Failed to connect Garmin: ${error.message}`, 'error');
                    button.innerHTML = 'Connect Garmin';
                    button.disabled = false;
                }
            }
        }

        // Strava token refresh function
        async function refreshStravaToken(refreshToken) {
            console.log('🔄 Refreshing Strava token...');

            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: API_CONFIG.strava.clientId,
                        client_secret: API_CONFIG.strava.clientSecret,
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error('Strava token refresh failed');
                }

                const data = await response.json();

                // Store new tokens
                localStorage.setItem('strava_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('strava_refresh_token', data.refresh_token);
                }
                if (data.expires_in) {
                    const expiryTime = Date.now() + (data.expires_in * 1000);
                    localStorage.setItem('strava_expiry', expiryTime);
                }

                console.log(' Strava token refreshed successfully');

                // Fetch data with new token
                fetchStravaData(data.access_token);

            } catch (error) {
                console.error(' Failed to refresh Strava token:', error);
                showMessage('Strava connection expired. Please reconnect.', 'warning');
                localStorage.removeItem('strava_token');
                localStorage.removeItem('strava_expiry');
                localStorage.removeItem('strava_refresh_token');
            }
        }

        // Oura token refresh function
        async function refreshOuraToken(refreshToken) {
            console.log('🔄 Refreshing Oura token...');

            try {
                const response = await fetch('https://api.ouraring.com/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken,
                        client_id: API_CONFIG.oura.clientId,
                        client_secret: API_CONFIG.oura.clientSecret
                    })
                });

                if (!response.ok) {
                    throw new Error('Oura token refresh failed');
                }

                const data = await response.json();

                // Store new tokens
                localStorage.setItem('oura_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('oura_refresh_token', data.refresh_token);
                }
                if (data.expires_in) {
                    const expiryTime = Date.now() + (data.expires_in * 1000);
                    localStorage.setItem('oura_expiry', expiryTime);
                }

                console.log(' Oura token refreshed successfully');

                // Fetch data with new token
                fetchOuraData(data.access_token);

            } catch (error) {
                console.error(' Failed to refresh Oura token:', error);
                showMessage('Oura connection expired. Please reconnect.', 'warning');
                localStorage.removeItem('oura_token');
                localStorage.removeItem('oura_expiry');
                localStorage.removeItem('oura_refresh_token');
            }
        }

        // Garmin token refresh function
        async function refreshGarminToken(refreshToken) {
            console.log('🔄 Refreshing Garmin token...');

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/garmin/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error('Garmin token refresh failed');
                }

                const data = await response.json();

                // Store new tokens
                localStorage.setItem('garmin_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('garmin_refresh_token', data.refresh_token);
                }
                if (data.expires_in) {
                    const expiryTime = Date.now() + (data.expires_in * 1000);
                    localStorage.setItem('garmin_expiry', expiryTime);
                }

                console.log(' Garmin token refreshed successfully');

                // Fetch data with new token
                fetchGarminData();

            } catch (error) {
                console.error(' Failed to refresh Garmin token:', error);
                showMessage('Garmin connection expired. Please reconnect.', 'warning');
                localStorage.removeItem('garmin_token');
                localStorage.removeItem('garmin_expiry');
                localStorage.removeItem('garmin_refresh_token');
            }
        }

        // Whoop token refresh function
        async function refreshWhoopToken(refreshToken) {
            console.log('🔄 Refreshing Whoop token...');

            try {
                const response = await fetch(`${API_CONFIG.backend}/api/whoop/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }

                const data = await response.json();

                // Store new tokens
                localStorage.setItem('whoop_token', data.access_token);
                if (data.refresh_token) {
                    localStorage.setItem('whoop_refresh_token', data.refresh_token);
                }
                if (data.expires_in) {
                    const expiryTime = Date.now() + (data.expires_in * 1000);
                    localStorage.setItem('whoop_expiry', expiryTime);
                }

                console.log(' Whoop token refreshed successfully');

                // Fetch data with new token
                fetchWhoopData(data.access_token);

            } catch (error) {
                console.error(' Failed to refresh Whoop token:', error);
                showMessage('Whoop connection expired. Please reconnect.', 'warning');
                localStorage.removeItem('whoop_token');
                localStorage.removeItem('whoop_access_token');
                localStorage.removeItem('whoop_expiry');
                localStorage.removeItem('whoop_token_expires_at');
                localStorage.removeItem('whoop_access_token_expires_at');
                localStorage.removeItem('whoop_refresh_token');
            }
        }

        // Whoop data fetching function
        async function fetchWhoopData(tokenParam) {
            console.log('🔄 fetchWhoopData called with token:', tokenParam ? 'provided' : 'using stored');
            const button = document.querySelector('.btn-whoop');

            try {
                button.innerHTML = '<span class="loading-spinner"></span> Loading...';
                button.disabled = true;

                const token = tokenParam || await ensureWhoopToken();
                console.log(' Using token:', token ? token.substring(0, 20) + '...' : 'none');

                if (!token) {
                    throw new Error('No Whoop access token found');
                }

                const today = new Date();
                const startDate = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000).toISOString();
                const endDate = today.toISOString();

                console.log('📡 Fetching Whoop data from backend...');
                console.log('Date range:', startDate, 'to', endDate);

                // Fetch Whoop data endpoints through backend
                const [profileResponse, recoveryResponse, workoutResponse, sleepResponse, cyclesResponse] = await Promise.allSettled([
                    fetchWithRetry(`${API_CONFIG.backend}/api/whoop/profile?token=${token}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/whoop/recovery?token=${token}&start=${startDate}&end=${endDate}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/whoop/workouts?token=${token}&start=${startDate}&end=${endDate}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/whoop/sleep?token=${token}&start=${startDate}&end=${endDate}`).catch(e => ({ ok: false, error: e })),
                    fetchWithRetry(`${API_CONFIG.backend}/api/whoop/cycles?token=${token}&start=${startDate}&end=${endDate}`).catch(e => ({ ok: false, error: e }))
                ]);

                console.log('Backend responses:', {
                    profile: profileResponse.status,
                    recovery: recoveryResponse.status,
                    workout: workoutResponse.status,
                    sleep: sleepResponse.status,
                    cycles: cyclesResponse.status
                });

                let profile = null, recovery = null, workouts = null, sleep = null, cycles = null;
                let hasAnyData = false;

                // Process responses with validation
                if (profileResponse.status === 'fulfilled' && profileResponse.value.ok) {
                    const data = await profileResponse.value.json();
                    if (data) {
                        profile = data;
                        hasAnyData = true;
                    }
                }

                if (recoveryResponse.status === 'fulfilled' && recoveryResponse.value.ok) {
                    const data = await recoveryResponse.value.json();
                    if (data && data.records && Array.isArray(data.records)) {
                        recovery = data.records;
                        hasAnyData = true;
                    }
                }

                if (workoutResponse.status === 'fulfilled' && workoutResponse.value.ok) {
                    const data = await workoutResponse.value.json();
                    if (data && data.records && Array.isArray(data.records)) {
                        workouts = data.records;
                        hasAnyData = true;
                    }
                }

                if (sleepResponse.status === 'fulfilled' && sleepResponse.value.ok) {
                    const data = await sleepResponse.value.json();
                    if (data && data.records && Array.isArray(data.records)) {
                        sleep = data.records;
                        hasAnyData = true;
                    }
                }

                if (cyclesResponse.status === 'fulfilled' && cyclesResponse.value.ok) {
                    const data = await cyclesResponse.value.json();
                    if (data && data.records && Array.isArray(data.records)) {
                        cycles = data.records;
                        hasAnyData = true;
                    }
                }

                if (hasAnyData) {
                    fitnessData.whoop = {
                        profile,
                        recovery,
                        workouts,
                        sleep,
                        cycles,
                        connected: true
                    };

                    fitnessData.lastUpdated = new Date();
                    updateConnectionStatus();
                    showMessage('Whoop data loaded successfully!', 'success');

                    // Update UI with Whoop data
                    if (document.getElementById('whoop').classList.contains('active')) {
                        updateWhoopDisplay();
                    }

                    const userName = profile?.first_name || 'Whoop User';
                    button.innerHTML = `<span class="check-icon">✓</span> ${userName} - Connected`;
                    button.classList.add('connected');

                    // Show disconnect button
                    const disconnectBtn = document.querySelector('.btn-whoop-disconnect');
                    if (disconnectBtn) {
                        disconnectBtn.style.display = 'block';
                    }
                } else {
                    throw new Error('No data available from Whoop');
                }

            } catch (error) {
                console.error('Whoop data fetch error:', error);
                showMessage(`Failed to load Whoop data: ${error.message}`, 'error');
                button.innerHTML = 'Connect Whoop';
                button.disabled = false;
            }
        }

        // Update Whoop display
        function updateWhoopDisplay() {
            if (!fitnessData.whoop) return;

            const { profile, recovery, workouts, sleep, cycles } = fitnessData.whoop;
            const cutoff = new Date(Date.now() - (whoopPeriodDays || 1) * 86400000);

            const filterByDate = (arr, getter) => Array.isArray(arr)
                ? arr.filter(item => {
                    const d = getter(item);
                    return d && !Number.isNaN(d.getTime()) ? d >= cutoff : true;
                })
                : [];

            const filteredRecovery = filterByDate(recovery, r => new Date(r.updated_at || r.created_at || r.date));
            const filteredSleep = filterByDate(sleep, s => new Date(s.end || s.updated_at || s.start));
            const filteredCycles = filterByDate(cycles, c => new Date(c.end || c.updated_at || c.start));
            const filteredWorkouts = filterByDate(workouts, w => new Date(w.start || w.end || w.updated_at));

            console.log('🎨 Updating Whoop display with data:', {
                profile: !!profile,
                recovery: recovery?.length,
                workouts: workouts?.length,
                sleep: sleep?.length,
                cycles: cycles?.length
            });

            // Update Whoop-specific UI elements
            const updateStat = (id, value, unit = '') => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value !== null && value !== undefined ? `${value}${unit}` : '--';
                }
            };

            // Update recovery data - sort by updated_at to get most recent
            if (filteredRecovery && filteredRecovery.length > 0) {
                // Sort by updated_at or created_at descending (newest first)
                const sortedRecovery = [...filteredRecovery].sort((a, b) => {
                    const dateA = new Date(a.updated_at || a.created_at);
                    const dateB = new Date(b.updated_at || b.created_at);
                    return dateB - dateA;
                });

                const latestRecovery = sortedRecovery[0];
                console.log('📊 Latest recovery data:', latestRecovery);
                console.log('📊 Recovery date:', latestRecovery.updated_at || latestRecovery.created_at);

                const recoveryScore = latestRecovery.score?.recovery_score;
                if (recoveryScore !== undefined) {
                    console.log('🔍 Raw recovery score:', recoveryScore);
                    // Recovery score is 0-100
                    const displayValue = Math.round(recoveryScore);
                    updateStat('whoopRecovery', displayValue, '%');
                }

                const hrv = latestRecovery.score?.hrv_rmssd_milli;
                if (hrv !== undefined) {
                    updateStat('whoopHRV', Math.round(hrv), '');
                }
            }

            // Update sleep data - sort by end time to get most recent
            if (filteredSleep && filteredSleep.length > 0) {
                // Sort by end time descending (newest first)
                const sortedSleep = [...filteredSleep].sort((a, b) => {
                    const dateA = new Date(a.end || a.updated_at);
                    const dateB = new Date(b.end || b.updated_at);
                    return dateB - dateA;
                });

                const latestSleep = sortedSleep[0];
                console.log('😴 Latest sleep data:', latestSleep);
                console.log('😴 Sleep end time:', latestSleep.end);

                const sleepPerformance = latestSleep.score?.sleep_performance_percentage;
                if (sleepPerformance !== undefined) {
                    console.log('🔍 Raw sleep performance:', sleepPerformance);
                    // Sleep performance is 0-100
                    const displayValue = Math.round(sleepPerformance);
                    updateStat('whoopSleep', displayValue, '%');
                }
            }

            // Update strain from cycles data - sort by end time to get most recent
            if (filteredCycles && filteredCycles.length > 0) {
                // Sort by end time or updated_at descending (newest first)
                const sortedCycles = [...filteredCycles].sort((a, b) => {
                    const dateA = new Date(a.end || a.updated_at);
                    const dateB = new Date(b.end || b.updated_at);
                    return dateB - dateA;
                });

                const latestCycle = sortedCycles[0];
                console.log('🔥 Latest cycle data:', latestCycle);
                console.log('🔥 Cycle end time:', latestCycle.end);

                const strain = latestCycle.score?.strain;
                if (strain !== undefined) {
                    updateStat('whoopStrain', strain.toFixed(1), '');
                }

                // If recovery endpoint failed, try to get recovery from cycle
                if (!recovery || recovery.length === 0) {
                    const recoveryScore = latestCycle.score?.recovery_score;
                    if (recoveryScore !== undefined) {
                        const displayValue = recoveryScore > 1 ? Math.round(recoveryScore) : Math.round(recoveryScore * 100);
                        updateStat('whoopRecovery', displayValue, '%');
                    }

                    const hrv = latestCycle.score?.hrv_rmssd_milli;
                    if (hrv !== undefined) {
                        updateStat('whoopHRV', Math.round(hrv), '');
                    }
                }

                // If sleep endpoint failed, try to get sleep from cycle
                if (!sleep || sleep.length === 0) {
                    const sleepPerformance = latestCycle.score?.sleep_performance_percentage;
                    if (sleepPerformance !== undefined) {
                        const displayValue = sleepPerformance > 1 ? Math.round(sleepPerformance) : Math.round(sleepPerformance * 100);
                        updateStat('whoopSleep', displayValue, '%');
                    }
                }
            }

            // Update activities list
            if (workouts && workouts.length > 0) {
                const activitiesList = document.getElementById('whoopActivitiesList');
                if (activitiesList) {
                    activitiesList.innerHTML = workouts.slice(0, 5).map(workout => `
                        <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
                            <span>${workout.sport_name || 'Activity'}</span>
                            <span>Strain: ${workout.score?.strain?.toFixed(1) || 'N/A'}</span>
                        </div>
                    `).join('');
                }
            }

            // Update Whoop trend chart
            updateWhoopTrendChart();
            updateWhoopRecoveryTrendChart();
            updateWhoopStrainTarget();

            console.log(' Whoop display updated successfully');
        }

        // Update Whoop Trend Chart with Sleep & Recovery data
        function updateWhoopTrendChart() {
            if (!charts.whoopTrend || !fitnessData.whoop) return;

            const { recovery, sleep } = fitnessData.whoop;
            const days = whoopPeriodDays || 1;
            const lastDays = [];
            const today = new Date();
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                lastDays.push(date);
            }

            const cutoff = new Date(Date.now() - days * 86400000);
            const filteredRecovery = Array.isArray(recovery)
                ? recovery.filter(r => {
                    const d = new Date(r.updated_at || r.created_at || r.date);
                    return d.toString() !== 'Invalid Date' ? d >= cutoff : true;
                })
                : [];
            const filteredSleep = Array.isArray(sleep)
                ? sleep.filter(s => {
                    const d = new Date(s.end || s.updated_at || s.start);
                    return d.toString() !== 'Invalid Date' ? d >= cutoff : true;
                })
                : [];

            // Prepare recovery data for the last 7 days
            const recoveryData = lastDays.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayRecovery = filteredRecovery?.find(r => {
                    const recordDate = new Date(r.created_at || r.date).toISOString().split('T')[0];
                    return recordDate === dateStr;
                });

                if (dayRecovery?.score?.recovery_score) {
                    const value = dayRecovery.score.recovery_score;
                    return value > 1 ? value : value * 100; // Handle both formats
                }
                return null;
            });

            // Prepare sleep data for the last 7 days
            const sleepData = lastDays.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                const daySleep = filteredSleep?.find(s => {
                    const recordDate = new Date(s.created_at || s.start).toISOString().split('T')[0];
                    return recordDate === dateStr;
                });

                if (daySleep?.score?.sleep_performance_percentage) {
                    const value = daySleep.score.sleep_performance_percentage;
                    return value > 1 ? value : value * 100; // Handle both formats
                }
                return null;
            });

            const labels = lastDays.map(date =>
                date.toLocaleDateString('en-US', { weekday: 'short' })
            );

            charts.whoopTrend.data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Recovery %',
                        data: recoveryData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    },
                    {
                        label: 'Sleep Performance %',
                        data: sleepData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }
                ]
            };

            charts.whoopTrend.update();

            console.log('Whoop trend chart updated:', {
                recoveryPoints: recoveryData.filter(v => v !== null).length,
                sleepPoints: sleepData.filter(v => v !== null).length
            });
        }

        function updateWhoopRecoveryTrendChart() {
            if (!charts.whoopRecoveryTrend || !fitnessData.whoop || !fitnessData.whoop.recovery) return;
            const days = getInsightWindowDays();
            const today = new Date();
            const labels = [];
            const keys = [];
            for (let i=days-1;i>=0;i--){ const d=new Date(today); d.setDate(d.getDate()-i); labels.push(d.toLocaleDateString('en-US',{weekday:'short'})); keys.push(d.toISOString().split('T')[0]); }
            const recMap = {};
            for (const r of fitnessData.whoop.recovery) {
                const k = new Date(r.created_at || r.date).toISOString().split('T')[0];
                const val = r.score?.recovery_score;
                if (val !== undefined) recMap[k] = val > 1 ? val : val * 100;
            }
            const rec = keys.map(k => recMap[k] ?? null);
            const valid = rec.filter(v => v !== null);
            const baseline = valid.length ? Math.round(valid.reduce((a,b)=>a+b,0)/valid.length) : null;
            charts.whoopRecoveryTrend.data = {
                labels,
                datasets: [
                    { label: 'Recovery %', data: rec, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.2)', tension: 0.3 },
                    { label: 'Baseline', data: rec.map(_=> baseline), borderColor: '#6b7280', borderDash: [6,6], pointRadius: 0 }
                ]
            };
            charts.whoopRecoveryTrend.update();
        }

        function updateWhoopStrainTarget() {
            const el = document.getElementById('whoopStrainTargetText');
            if (!el || !fitnessData.whoop || !fitnessData.whoop.recovery) return;
            const latest = fitnessData.whoop.recovery[fitnessData.whoop.recovery.length - 1];
            if (!latest) { el.textContent = '—'; return; }
            const raw = latest.score?.recovery_score;
            if (raw === undefined) { el.textContent = '—'; return; }
            const rec = raw > 1 ? raw : raw * 100;
            let zone = 'Yellow', target = '10–12';
            if (rec >= 67) { zone = 'Green'; target = '12–15'; }
            else if (rec < 34) { zone = 'Red'; target = '8–10'; }
            el.textContent = `Recovery ${Math.round(rec)}% (${zone}). Suggested strain target: ${target}. Adjust for your goals and feel.`;
        }

        // Update Garmin display
        async function updateGarminDisplay() {
            console.log('🏃🏃🏃 UPDATE GARMIN DISPLAY CALLED 🏃🏃🏃');
            console.log('🔍 Call stack:', new Error().stack);
            try {
                const userId = localStorage.getItem('userId');
                console.log('👤 userId:', userId);
                if (!userId) {
                    console.log('❌ No userId - returning');
                    return;
                }

                // Fetch real data from database (received via PUSH webhooks)
                // NOTE: We fetch data regardless of token status because PUSH webhooks may have sent data
                console.log('📡 Fetching Garmin data from database for user:', userId);
                console.log('🌐 API URL:', `${API_CONFIG.backend}/api/garmin/db/activities?userId=${userId}`);

                const [activitiesResponse, dailiesResponse] = await Promise.allSettled([
                    fetch(`${API_CONFIG.backend}/api/garmin/db/activities?userId=${userId}`),
                    fetch(`${API_CONFIG.backend}/api/garmin/db/dailies?userId=${userId}`)
                ]);

                let activities = [];
                let dailySummaries = [];

                console.log('📥 activitiesResponse:', activitiesResponse);
                if (activitiesResponse.status === 'fulfilled' && activitiesResponse.value.ok) {
                    const data = await activitiesResponse.value.json();
                    activities = data.activities || [];
                    console.log('✅ Loaded', activities.length, 'Garmin activities', activities);
                } else {
                    console.log('❌ Activities fetch failed:', activitiesResponse);
                }

                console.log('📥 dailiesResponse:', dailiesResponse);
                if (dailiesResponse.status === 'fulfilled' && dailiesResponse.value.ok) {
                    const data = await dailiesResponse.value.json();
                    dailySummaries = data.dailies || [];
                    console.log('✅ Loaded', dailySummaries.length, 'daily summaries');
                } else {
                    console.log('❌ Dailies fetch failed:', dailiesResponse);
                }

                // Apply period filter
                const now = new Date();
                const cutoff = new Date(now.getTime() - (garminPeriodDays || 7) * 86400000);
                const actDate = (a) => a.startTimeInSeconds
                    ? new Date(a.startTimeInSeconds * 1000)
                    : new Date(a.startTimeLocal || a.startTime || a.start_date || a.startTimeGmt || a.activityStartTime || 0);
                const dailyDate = (d) => new Date(d.calendarDate || d.startDate || d.date || d.calendar_date || 0);

                const filteredActivities = activities.filter(a => {
                    const d = actDate(a);
                    return d.toString() !== 'Invalid Date' ? d >= cutoff : true;
                });
                const filteredDailies = dailySummaries.filter(d => {
                    const dt = dailyDate(d);
                    return dt.toString() !== 'Invalid Date' ? dt >= cutoff : true;
                });

                fitnessData.garmin.filteredActivities = filteredActivities;
                fitnessData.garmin.filteredDailies = filteredDailies;

                // Update "Last updated" timestamp
                try {
                    const el = document.getElementById('garminLastUpdated');
                    if (el) {
                        const ts = (fitnessData.garmin && fitnessData.garmin.lastUpdated) ? new Date(fitnessData.garmin.lastUpdated) : new Date();
                        el.textContent = `Last updated: ${ts.toLocaleString()}`;
                    }
                } catch (_) {}

                // Update hero stat cards
                console.log('🎯 Setting garminActivities to:', filteredActivities.length);
                const garminActivitiesElement = document.getElementById('garminActivities');
                console.log('🎯 garminActivities element:', garminActivitiesElement);
                if (garminActivitiesElement) {
                    garminActivitiesElement.textContent = filteredActivities.length;
                    console.log('✅ Successfully set garminActivities.textContent to:', filteredActivities.length);
                } else {
                    console.log('❌ ERROR: garminActivities element not found in DOM!');
                }

                const totalDistance = filteredActivities.reduce((sum, a) => sum + (a.distanceInMeters || 0), 0);
                document.getElementById('garminDistance').textContent = (totalDistance / 1000).toFixed(1) + ' km';

                const avgHr = filteredActivities.length > 0
                    ? Math.round(filteredActivities.reduce((sum, a) => sum + (a.averageHeartRateInBeatsPerMinute || 0), 0) / filteredActivities.length)
                    : '--';
                document.getElementById('garminAvgHR').textContent = avgHr === '--' ? avgHr : avgHr + ' bpm';

                const totalTime = filteredActivities.reduce((sum, a) => sum + (a.durationInSeconds || 0), 0);
                const hours = Math.floor(totalTime / 3600);
                const minutes = Math.floor((totalTime % 3600) / 60);
                document.getElementById('garminTrainingTime').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                // Update new health metrics from daily summaries
                if (filteredDailies.length > 0) {
                    const latest = filteredDailies[0];

                    // Body Battery (allow 0) - fallback to charged/drained if highest is null
                    const bbValue =
                        (latest.bodyBatteryHighestValue !== undefined && latest.bodyBatteryHighestValue !== null)
                            ? latest.bodyBatteryHighestValue
                            : (latest.bodyBatteryChargedValue !== undefined && latest.bodyBatteryChargedValue !== null)
                                ? latest.bodyBatteryChargedValue
                                : (latest.bodyBatteryDrainedValue !== undefined && latest.bodyBatteryDrainedValue !== null)
                                    ? Math.max(0, 100 - latest.bodyBatteryDrainedValue)
                                    : null;
                    if (bbValue !== null) {
                        document.getElementById('garminBodyBattery').textContent = bbValue;
                    }

                    // Stress Level (allow 0)
                    if (latest.averageStressLevel !== undefined && latest.averageStressLevel !== null) {
                        document.getElementById('garminStressLevel').textContent = latest.averageStressLevel;
                    }

                    // Steps (allow 0)
                    if (latest.steps !== undefined && latest.steps !== null) {
                        document.getElementById('garminSteps').textContent = latest.steps.toLocaleString();
                    }

                    // Resting HR (allow 0)
                    if (latest.restingHr !== undefined && latest.restingHr !== null) {
                        document.getElementById('garminRestingHR').textContent = `${latest.restingHr} bpm`;
                    }

                    // Sleep (hours) if available
                    if (latest.sleepHours !== undefined && latest.sleepHours !== null) {
                        document.getElementById('garminSleep').textContent = latest.sleepHours.toFixed(1) + ' h';
                    } else if (latest.sleepingSeconds !== undefined && latest.sleepingSeconds !== null) {
                        document.getElementById('garminSleep').textContent = (latest.sleepingSeconds / 3600).toFixed(1) + ' h';
                    }

                    // HRV (allow 0)
                    if (latest.hrvAvg !== undefined && latest.hrvAvg !== null) {
                        document.getElementById('garminHRV').textContent = Math.round(latest.hrvAvg);
                    }

                    // Respiration (allow 0)
                    if (latest.avgWakingRespirationValue !== undefined && latest.avgWakingRespirationValue !== null) {
                        document.getElementById('garminRespiration').textContent = Number(latest.avgWakingRespirationValue).toFixed(1);
                    }
                }

                // Update activities list with real activities
                const activitiesList = document.getElementById('garminActivitiesList');
                if (filteredActivities.length === 0) {
                    activitiesList.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af;">No activities yet. Record a workout on your Garmin device!</div>';
                } else {
                    activitiesList.innerHTML = filteredActivities.map(activity => `
                    <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 1.1rem;">${activity.activityName || activity.activityType}</strong>
                                <div style="font-size: 0.9rem; color: #9ca3af; margin-top: 2px;">${new Date(activity.startTimeInSeconds * 1000).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: #667eea; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                                    ${activity.activityType}
                                </span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9rem;">
                            <div>
                                <span style="color: #9ca3af;">Duration:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${Math.floor(activity.durationInSeconds / 60)}min</strong>
                            </div>
                            ${activity.distanceInMeters ? `<div>
                                <span style="color: #9ca3af;">Distance:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${(activity.distanceInMeters / 1000).toFixed(2)} km</strong>
                            </div>` : ''}
                            ${activity.averageHeartRateInBeatsPerMinute ? `<div>
                                <span style="color: #9ca3af;">Avg HR:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${activity.averageHeartRateInBeatsPerMinute} bpm</strong>
                            </div>` : ''}
                            ${activity.maxHeartRateInBeatsPerMinute ? `<div>
                                <span style="color: #9ca3af;">Max HR:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${activity.maxHeartRateInBeatsPerMinute} bpm</strong>
                            </div>` : ''}
                            ${activity.activeKilocalories ? `<div>
                                <span style="color: #9ca3af;">Calories:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${activity.activeKilocalories} kcal</strong>
                            </div>` : ''}
                            ${activity.deviceModel ? `<div>
                                <span style="color: #9ca3af;">Device:</span>
                                <strong style="color: #ffffff; margin-left: 5px;">${activity.deviceModel}</strong>
                            </div>` : ''}
                        </div>
                    </div>
                `).join('');
                }

                // Create Heart Rate Zones TIME IN ZONE chart from activity data, with min/hr toggle
                const zonesCtx = document.getElementById('garminZonesChart');
                function renderGarminZonesChart(unit = (window.garminZonesUnit || 'min')) {
                    if (!zonesCtx || activities.length === 0) return;
                    const maxHRValue = Math.max(...activities.map(a => a.maxHeartRateInBeatsPerMinute || 0)) || 1;
                    const zones = {
                        recovery: { min: 0.5, max: 0.6, time: 0 },
                        fatBurn:  { min: 0.6, max: 0.7, time: 0 },
                        cardio:   { min: 0.7, max: 0.8, time: 0 },
                        threshold:{ min: 0.8, max: 0.9, time: 0 },
                        peak:     { min: 0.9, max: 1.0, time: 0 }
                    };
                    activities.forEach(activity => {
                        if (activity.averageHeartRateInBeatsPerMinute && activity.durationInSeconds) {
                            const avgHRPercent = activity.averageHeartRateInBeatsPerMinute / maxHRValue;
                            const durationMinutes = (activity.durationInSeconds || 0) / 60;
                            if (avgHRPercent >= zones.recovery.min && avgHRPercent < zones.recovery.max) zones.recovery.time += durationMinutes;
                            else if (avgHRPercent >= zones.fatBurn.min && avgHRPercent < zones.fatBurn.max) zones.fatBurn.time += durationMinutes;
                            else if (avgHRPercent >= zones.cardio.min && avgHRPercent < zones.cardio.max) zones.cardio.time += durationMinutes;
                            else if (avgHRPercent >= zones.threshold.min && avgHRPercent < zones.threshold.max) zones.threshold.time += durationMinutes;
                            else if (avgHRPercent >= zones.peak.min) zones.peak.time += durationMinutes;
                        }
                    });
                    const toUnits = v => unit === 'hr' ? v / 60 : v;
                    const label = unit === 'hr' ? 'Time (hours)' : 'Time (minutes)';
                    const values = [zones.recovery.time, zones.fatBurn.time, zones.cardio.time, zones.threshold.time, zones.peak.time]
                        .map(v => Math.round(toUnits(v)));
                    const existingChart = Chart.getChart(zonesCtx);
                    if (existingChart) existingChart.destroy();
                    new Chart(zonesCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Recovery\n(50-60%)', 'Fat Burn\n(60-70%)', 'Cardio\n(70-80%)', 'Threshold\n(80-90%)', 'Peak\n(90-100%)'],
                            datasets: [{ label, data: values, backgroundColor: ['#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#F44336'] }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: label } } }
                        }
                    });
                    // Add toggle control once
                    if (!document.getElementById('garminZonesToggle')) {
                        const toggle = document.createElement('button');
                        toggle.id = 'garminZonesToggle';
                        toggle.textContent = 'Toggle min/hr';
                        toggle.style.cssText = 'margin:6px 0; padding:4px 8px; font-size:12px; border-radius:6px; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); color:#e5e7eb;';
                        zonesCtx.parentNode.insertBefore(toggle, zonesCtx);
                        toggle.addEventListener('click', () => { window.garminZonesUnit = (window.garminZonesUnit === 'hr' ? 'min' : 'hr'); renderGarminZonesChart(window.garminZonesUnit); });
                    }
                }
                if (zonesCtx && activities.length > 0) renderGarminZonesChart();

                // Body Battery Trend from daily summaries
                if (dailySummaries.length > 0) {
                    const sorted = [...dailySummaries].sort((a,b) => new Date(a.calendarDate) - new Date(b.calendarDate));
                    const labels = sorted.map(d => d.calendarDate);
                    const bodyBatt = sorted.map(d => {
                        if (d.bodyBatteryHighestValue !== undefined && d.bodyBatteryHighestValue !== null) return d.bodyBatteryHighestValue;
                        if (d.bodyBatteryChargedValue !== undefined && d.bodyBatteryChargedValue !== null) return d.bodyBatteryChargedValue;
                        if (d.bodyBatteryDrainedValue !== undefined && d.bodyBatteryDrainedValue !== null) return Math.max(0, 100 - d.bodyBatteryDrainedValue);
                        return null;
                    });
                    const stressLow = sorted.map(d => (d.lowStressDuration||0)/60);
                    const stressMed = sorted.map(d => (d.mediumStressDuration||0)/60);
                    const stressHigh= sorted.map(d => (d.highStressDuration||0)/60);
                    const hrv = sorted.map(d => d.hrvAvg ?? null);
                    const resp = sorted.map(d => d.avgWakingRespirationValue ?? null);

                    const bbCtx = document.getElementById('garminBodyBatteryChart');
                    if (bbCtx && bodyBatt.some(v => v !== null)) {
                        const c = Chart.getChart(bbCtx); if (c) c.destroy();
                        new Chart(bbCtx.getContext('2d'), {
                            type: 'line',
                            data: { labels, datasets: [{ label: 'Body Battery (max)', data: bodyBatt, borderColor: '#22c55e', backgroundColor: 'transparent', tension: 0.3 }] },
                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min:0, max:100, title:{display:true,text:'Level'} } } }
                        });
                    }

                    const stressCtx = document.getElementById('garminStressChart');
                    if (stressCtx && (stressLow.some(v=>v>0)||stressMed.some(v=>v>0)||stressHigh.some(v=>v>0))) {
                        const c = Chart.getChart(stressCtx); if (c) c.destroy();
                        new Chart(stressCtx.getContext('2d'), {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [
                                    { label: 'Low (min)',    data: stressLow, backgroundColor: '#10b981' },
                                    { label: 'Medium (min)', data: stressMed, backgroundColor: '#f59e0b' },
                                    { label: 'High (min)',   data: stressHigh,backgroundColor: '#dc2626' }
                                ]
                            },
                            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:true, title:{display:true,text:'Minutes'} } } }
                        });
                    }

                    const hrvRespCtx = document.getElementById('garminHRVRespirationChart');
                    if (hrvRespCtx && (hrv.some(v=>v!==null)||resp.some(v=>v!==null))) {
                        const c = Chart.getChart(hrvRespCtx); if (c) c.destroy();
                        new Chart(hrvRespCtx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels,
                                datasets: [
                                    { label: 'HRV (ms)', data: hrv, borderColor:'#3b82f6', backgroundColor:'transparent', yAxisID:'y' },
                                    { label: 'Resp (br/min)', data: resp, borderColor:'#14b8a6', backgroundColor:'transparent', yAxisID:'y1' }
                                ]
                            },
                            options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{ y:{ position:'left', title:{display:true, text:'HRV (ms)'} }, y1:{ position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'Breaths/min'} } } }
                        });
                    }
                }

            } catch (error) {
                console.error(' Error updating Garmin display:', error);
                console.error('Error stack:', error.stack);
            }
        }

        function updateConnectionStatus() {
            const connections = ['strava', 'oura', 'whoop', 'garmin'];
            const container = document.getElementById('overviewConnections');
            
            if (container) {
                container.innerHTML = connections.map(service => {
                    const isConnected = fitnessData[service] !== null;
                    let logoHtml = '';

                    if (service === 'garmin') {
                        logoHtml = '<img src="/src/images/Garmin.svg" alt="Garmin" style="height: 28px; width: auto; vertical-align: middle; margin-right: 8px;">';
                    } else if (service === 'strava') {
                        logoHtml = '<img src="/src/images/strava.svg" alt="Strava" style="height: 20px; width: auto; vertical-align: middle; margin-right: 8px;">';
                    } else if (service === 'whoop') {
                        logoHtml = '<img src="/src/images/WHOOP.svg" alt="Whoop" style="height: 20px; width: auto; vertical-align: middle; margin-right: 8px;">';
                    } else if (service === 'oura') {
                        logoHtml = '<img src="/src/images/oura.png" alt="Oura" style="height: 20px; width: auto; vertical-align: middle; margin-right: 8px;">';
                    }

                    return `
                        <div class="connection-badge ${isConnected ? 'connected' : 'disconnected'}">
                            ${logoHtml} ${isConnected ? '✅' : '❌'}
                        </div>
                    `;
                }).join('');
            }

            // Update footer badges
            try { updateFooterBadges(); } catch (_) {}
        }

        function updateFooterBadges() {
            const status = (provider) => {
                const fd = fitnessData[provider];
                const token = localStorage.getItem(`${provider}_token`);
                return !!fd || !!token;
            };
            const last = (provider) => {
                const ts = fitnessData[provider]?.lastUpdated || fitnessData.lastUpdated;
                return ts ? new Date(ts).toLocaleString() : null;
            };
            const setBadge = (id, connected) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.toggle('badge-connected', connected);
                el.classList.toggle('badge-disconnected', !connected);
                const title = connected ? `Last update: ${last(id.split('-')[1]) || '—'}` : 'Not connected';
                el.title = title;
            };
            setBadge('badge-strava', status('strava'));
            setBadge('badge-garmin', status('garmin'));
            setBadge('badge-oura', status('oura'));
            setBadge('badge-whoop', status('whoop'));

            // Update status text with names where available
            try {
                const stravaName = fitnessData.strava?.athlete ? `${(fitnessData.strava.athlete.firstname||'').toUpperCase()}` : null;
                document.getElementById('badge-strava-status').textContent = status('strava') ? `✓ ${stravaName || 'CONNECTED'}` : '—';
            } catch(_) {}
            try {
                const ouraName = fitnessData.oura?.personal?.email ? fitnessData.oura.personal.email.split('@')[0].toUpperCase() : 'OURA USER';
                document.getElementById('badge-oura-status').textContent = status('oura') ? `✓ ${ouraName} - CONNECTED` : '—';
            } catch(_) {}
            try {
                document.getElementById('badge-garmin-status').textContent = status('garmin') ? `✓ CONNECTED` : '—';
            } catch(_) {}
            try {
                const whoopName = fitnessData.whoop?.profile?.user?.first_name ? fitnessData.whoop.profile.user.first_name.toUpperCase() : 'CONNECTED';
                document.getElementById('badge-whoop-status').textContent = status('whoop') ? `✓ ${whoopName}` : '—';
            } catch(_) {}
        }

        // ===== RUNNING ANALYTICS =====
        let runningPeriodDays = 28;
        let garminPeriodDays = 7;
        let whoopPeriodDays = 1;
        let ouraPeriodDays = 1;

        function updateRunningPeriod() {
            const selector = document.getElementById('runningPeriodSelector');
            runningPeriodDays = parseInt(selector?.value || '28', 10) || 28;
            updateRunningAnalytics();
        }

        function updateGarminPeriod() {
            const selector = document.getElementById('garminPeriodSelector');
            garminPeriodDays = parseInt(selector?.value || '7', 10) || 7;
            updateGarminDisplay();
        }

        function updateWhoopPeriod() {
            const selector = document.getElementById('whoopPeriodSelector');
            whoopPeriodDays = parseInt(selector?.value || '1', 10) || 1;
            updateWhoopDisplay();
        }

        function updateOuraPeriod() {
            const selector = document.getElementById('ouraPeriodSelector');
            ouraPeriodDays = parseInt(selector?.value || '1', 10) || 1;
            updateOuraData();
            updateOuraSleepStagesChart();
            updateOuraCorrelationChart();
            updateOuraTrendCharts();
            updateOuraConsistencyCard();
        }

        function normalizeRunActivities() {
            const runs = [];

            const stravaActivities = Array.isArray(fitnessData.strava?.activities?.activities)
                ? fitnessData.strava.activities.activities
                : Array.isArray(fitnessData.strava?.activities)
                    ? fitnessData.strava.activities
                    : [];

            const garminActivities = Array.isArray(fitnessData.garmin?.activities?.activities)
                ? fitnessData.garmin.activities.activities
                : Array.isArray(fitnessData.garmin?.activities)
                    ? fitnessData.garmin.activities
                    : [];

            // Strava runs
            for (const a of stravaActivities) {
                const type = (a.type || a.sport_type || '').toLowerCase();
                if (!type.includes('run')) continue;

                const start = a.start_date || a.start_date_local;
                const startTs = start ? new Date(start).getTime() : 0;

                // Strava cadence is per-leg; convert later when rendering
                const cadence = a.average_cadence || a.cadence || null;

                runs.push({
                    ...a,
                    source: 'strava',
                    externalKey: a.external_id || a.id || a.upload_id,
                    start_date: start,
                    startTs,
                    distance: a.distance || 0,
                    moving_time: a.moving_time || a.elapsed_time || 0,
                    total_elevation_gain: a.total_elevation_gain || 0,
                    average_heartrate: a.average_heartrate || null,
                    max_heartrate: a.max_heartrate || null,
                    average_cadence: cadence,
                    average_stride_length: a.average_stride_length || null,
                    ground_contact_time: a.ground_contact_time || null,
                    vertical_oscillation: a.vertical_oscillation || null
                });
            }

            // Garmin runs
            for (const a of garminActivities) {
                const type = (a.activityType || a.type || a.sport_type || '').toLowerCase();
                if (!type.includes('run')) continue;

                const startIso = a.startTimeInSeconds
                    ? new Date(a.startTimeInSeconds * 1000).toISOString()
                    : (a.startTimeLocal || a.startTime || a.start_date || null);
                const startTs = startIso ? new Date(startIso).getTime() : 0;

                const cadenceRaw = a.averageRunCadenceInStepsPerMinute
                    || a.averageCadenceInStepsPerMinute
                    || a.average_cadence
                    || a.averageCadence
                    || null;

                const strideRaw = a.averageStrideLengthInMeters
                    || a.average_stride_length
                    || a.averageStrideLength
                    || null;

                const gctRaw = a.averageGroundContactTimeInMs || a.ground_contact_time || null;
                const voRaw = a.averageVerticalOscillation || a.vertical_oscillation || null;

                runs.push({
                    ...a,
                    source: 'garmin',
                    externalKey: a.activityId || a.summaryId || a.externalId || a.activityIdString || a.id,
                    start_date: startIso,
                    startTs,
                    distance: a.distanceInMeters || a.distance || 0,
                    moving_time: a.durationInSeconds || a.moving_time || a.elapsedTimeInSeconds || 0,
                    total_elevation_gain: a.elevationGain || a.total_elevation_gain || a.elevationGainInMeters || 0,
                    average_heartrate: a.averageHeartRateInBeatsPerMinute || a.average_heartrate || null,
                    max_heartrate: a.maxHeartRateInBeatsPerMinute || a.max_heartrate || null,
                    average_cadence: cadenceRaw,
                    average_stride_length: strideRaw,
                    ground_contact_time: gctRaw,
                    vertical_oscillation: voRaw
                });
            }

            return runs;
        }

        function mergeRuns(primary, secondary) {
            // Prefer Strava data richness; otherwise fill gaps from the other source
            return {
                ...secondary,
                ...primary,
                distance: primary.distance || secondary.distance,
                moving_time: primary.moving_time || secondary.moving_time,
                total_elevation_gain: primary.total_elevation_gain || secondary.total_elevation_gain,
                average_heartrate: primary.average_heartrate || secondary.average_heartrate,
                max_heartrate: primary.max_heartrate || secondary.max_heartrate,
                start_date: primary.start_date || secondary.start_date,
                startTs: primary.startTs || secondary.startTs,
                externalKey: primary.externalKey || secondary.externalKey,
                source: primary.source === 'strava' ? 'strava' : secondary.source
            };
        }

        function countRunMetrics(run) {
            let score = 0;
            if (run.distance) score++;
            if (run.moving_time) score++;
            if (run.total_elevation_gain) score++;
            if (run.average_heartrate) score++;
            if (run.max_heartrate) score++;
            if (run.startTs) score++;
            return score;
        }

        function dedupeRunActivities(runs) {
            const deduped = [];

            for (const run of runs) {
                const matchIdx = deduped.findIndex(existing => {
                    if (run.externalKey && existing.externalKey && run.externalKey === existing.externalKey) return true;
                    const timeClose = Math.abs((run.startTs || 0) - (existing.startTs || 0)) <= 120000; // within 2 minutes
                    const distClose = Math.abs((run.distance || 0) - (existing.distance || 0)) <= 200; // within 200m
                    return timeClose && distClose;
                });

                if (matchIdx >= 0) {
                    const existing = deduped[matchIdx];

                    // Prefer Strava, otherwise the one with more metrics
                    const primary = existing.source === 'strava'
                        ? existing
                        : run.source === 'strava'
                            ? run
                            : (countRunMetrics(run) > countRunMetrics(existing) ? run : existing);
                    const secondary = primary === existing ? run : existing;

                    deduped[matchIdx] = mergeRuns(primary, secondary);
                } else {
                    deduped.push(run);
                }
            }

            deduped.sort((a, b) => (b.startTs || 0) - (a.startTs || 0));
            return deduped;
        }

        function updateRunningAnalytics() {
            console.log('🏃 ===== UPDATE RUNNING ANALYTICS CALLED =====');

            const normalizedRuns = normalizeRunActivities();
            const runActivities = dedupeRunActivities(normalizedRuns);

            console.log('🏃 Normalized runs:', normalizedRuns.length, 'Deduped runs:', runActivities.length);

            if (runActivities.length === 0) {
                showEmptyRunningState();
                return;
            }

            // Calculate date ranges based on selection
            const now = new Date();
            const periodDays = runningPeriodDays || 28;
            const currentStart = new Date(now.getTime() - periodDays * 86400000);
            const previousStart = new Date(now.getTime() - periodDays * 2 * 86400000);
            const lastWeekStart = new Date(now.getTime() - Math.min(7, periodDays) * 86400000);

            // Filter runs by time periods
            const recentRuns = runActivities.filter(a => new Date(a.start_date) >= currentStart);
            const lastWeekRuns = runActivities.filter(a => new Date(a.start_date) >= lastWeekStart);
            const previousPeriodRuns = runActivities.filter(a => {
                const date = new Date(a.start_date);
                return date >= previousStart && date < currentStart;
            });

            // Update running volume cards
            updateRunningVolumeCards(recentRuns, previousPeriodRuns);
            
            // Update training load chart
            updateRunningLoadChart(recentRuns);
            
            // Update pace and HR trends
            updateRunningPaceChart(recentRuns);
            
            // Update intensity distribution
            updateRunningIntensityDistribution(recentRuns);
            
            // Update progress table
            updateRunningProgressTable(recentRuns, previousPeriodRuns);
            
            // Update personal records
            updateRunningRecords(runActivities);

            // Update endurance chart
            updateRunningEnduranceChart(recentRuns);

            // Generate running-specific insights
            generateRunningInsights(recentRuns, previousPeriodRuns);

            // Update new comprehensive running metrics
            updateRunningFitnessMetrics(runActivities);
            updateRunningRecoveryMetrics();
            updateRunningPerformanceMetrics(recentRuns);
            updateRunningFormMetrics(recentRuns);
            updateRunningWeeklyProgress(recentRuns, previousPeriodRuns, lastWeekRuns);
            updateRunningPersonalRecords(runActivities);

            // Update new charts
            updateRunningHRZonesChart(recentRuns);
            updateRunningIntensityPyramid(recentRuns);
            updateRunningFitnessTrendChart(runActivities);
            updateRunningVolumeChart(runActivities.filter(a => new Date(a.start_date) >= previousStart));
            updateRunningPaceProgressionChart(recentRuns);
        }

        function updateRunningVolumeCards(recentRuns, previousRuns) {
            // Total distance
            const totalDistance = recentRuns.reduce((sum, r) => sum + (r.distance || 0), 0) / 1000;
            const previousDistance = previousRuns.reduce((sum, r) => sum + (r.distance || 0), 0) / 1000;
            document.getElementById('runningDistance').textContent = `${Math.round(totalDistance)}km`;
            updateTrendArrow('runningDistanceTrend', totalDistance, previousDistance);

            // Weekly frequency
            const weeklyFrequency = recentRuns.length / 4;
            const previousFrequency = previousRuns.length / 4;
            document.getElementById('runningFrequency').textContent = weeklyFrequency.toFixed(1);
            updateTrendArrow('runningFrequencyTrend', weeklyFrequency, previousFrequency);

            // Average duration
            const avgDuration = recentRuns.length > 0 ? 
                recentRuns.reduce((sum, r) => sum + (r.moving_time || 0), 0) / recentRuns.length / 60 : 0;
            const previousAvgDuration = previousRuns.length > 0 ?
                previousRuns.reduce((sum, r) => sum + (r.moving_time || 0), 0) / previousRuns.length / 60 : 0;
            document.getElementById('runningDuration').textContent = formatDuration(avgDuration);
            updateTrendArrow('runningDurationTrend', avgDuration, previousAvgDuration);

            // Total elevation
            const totalElevation = recentRuns.reduce((sum, r) => sum + (r.total_elevation_gain || 0), 0);
            const previousElevation = previousRuns.reduce((sum, r) => sum + (r.total_elevation_gain || 0), 0);
            document.getElementById('runningElevation').textContent = `${Math.round(totalElevation)}m`;
            updateTrendArrow('runningElevationTrend', totalElevation, previousElevation);
        }

        function updateTrendArrow(elementId, current, previous) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const change = previous > 0 ? ((current - previous) / previous) * 100 : 0;
            
            if (Math.abs(change) < 5) {
                element.textContent = '→';
                element.className = 'trend-arrow neutral';
            } else if (change > 0) {
                element.textContent = '↑';
                element.className = 'trend-arrow up';
            } else {
                element.textContent = '↓';
                element.className = 'trend-arrow down';
            }
        }

        function updateRunningLoadChart(runs) {
            const canvas = document.getElementById('runningLoadChart');
            if (!canvas) {
                console.warn('🏃 runningLoadChart canvas not found; skipping load chart');
                return;
            }

            if (!charts.runningLoad) {
                charts.runningLoad = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Sort runs by date
            const sortedRuns = runs.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
            
            const labels = sortedRuns.map(r => new Date(r.start_date).toLocaleDateString());
            const sufferScores = sortedRuns.map(r => r.suffer_score || 0);
            const avgHR = sortedRuns.map(r => r.average_heartrate || 0);

            charts.runningLoad.data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Training Load',
                        data: sufferScores,
                        backgroundColor: '#FC4C02',
                        yAxisID: 'y'
                    },
                    {
                        label: 'Avg HR',
                        data: avgHR,
                        type: 'line',
                        borderColor: '#dc2626',
                        backgroundColor: 'transparent',
                        yAxisID: 'y1'
                    }
                ]
            };

            charts.runningLoad.options.scales = {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Suffer Score' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Heart Rate (bpm)' },
                    grid: { drawOnChartArea: false }
                }
            };

            charts.runningLoad.update();
        }

        function updateRunningPaceChart(runs) {
            const canvas = document.getElementById('runningPaceChart');
            if (!canvas) {
                console.warn('🏃 runningPaceChart canvas not found; skipping pace chart');
                return;
            }

            if (!charts.runningPace) {
                charts.runningPace = new Chart(canvas, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                reverse: true,
                                ticks: {
                                    callback: function(value) {
                                        const minutes = Math.floor(value);
                                        const seconds = Math.round((value - minutes) * 60);
                                        return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Group runs by week
            const weeklyData = {};
            runs.forEach(run => {
                const weekStart = getWeekStart(new Date(run.start_date));
                const weekKey = weekStart.toISOString().split('T')[0];
                
                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = {
                        paces: [],
                        heartRates: [],
                        distances: []
                    };
                }
                
                const paceMinPerKm = run.distance > 0 ? (run.moving_time / 60) / (run.distance / 1000) : 0;
                if (paceMinPerKm > 0 && paceMinPerKm < 10) { // Filter out unrealistic paces
                    weeklyData[weekKey].paces.push(paceMinPerKm);
                    weeklyData[weekKey].heartRates.push(run.average_heartrate || 0);
                    weeklyData[weekKey].distances.push(run.distance);
                }
            });

            const weeks = Object.keys(weeklyData).sort();
            const avgPaces = weeks.map(week => {
                const data = weeklyData[week];
                return data.paces.length > 0 ? 
                    data.paces.reduce((a, b) => a + b) / data.paces.length : null;
            });

            const bestPaces = weeks.map(week => {
                const data = weeklyData[week];
                return data.paces.length > 0 ? Math.min(...data.paces) : null;
            });

            const avgHeartRates = weeks.map(week => {
                const data = weeklyData[week];
                const validHRs = data.heartRates.filter(hr => hr > 0);
                return validHRs.length > 0 ? 
                    validHRs.reduce((a, b) => a + b) / validHRs.length : null;
            });

            charts.runningPace.data = {
                labels: weeks.map(w => new Date(w).toLocaleDateString()),
                datasets: [
                    {
                        label: 'Best Pace',
                        data: bestPaces,
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        tension: 0.4
                    },
                    {
                        label: 'Avg Pace',
                        data: avgPaces,
                        borderColor: '#667eea',
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }
                ]
            };

            charts.runningPace.update();
        }

        function updateRunningIntensityDistribution(runs) {
            const canvas = document.getElementById('runningIntensityChart');
            if (!canvas) {
                console.warn('🏃 runningIntensityChart canvas not found; skipping intensity chart');
                return;
            }

            if (!charts.runningIntensity) {
                charts.runningIntensity = new Chart(canvas, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }

            // Categorize runs by intensity based on suffer score per minute (fallback to HR-derived load)
            let easy = 0, moderate = 0, hard = 0;
            
            runs.forEach(run => {
                const moveMin = (run.moving_time || 0) / 60;
                const baseHr = run.average_heartrate || run.max_heartrate || 0;
                const suffer = run.suffer_score || (baseHr > 0 ? (baseHr / 200) * moveMin : 0);
                if (moveMin <= 0) { easy += 1; return; }
                const sufferPerMin = suffer / moveMin;
                if (sufferPerMin < 0.5) easy += moveMin;
                else if (sufferPerMin < 1.0) moderate += moveMin;
                else hard += moveMin;
            });

            charts.runningIntensity.data = {
                labels: ['Easy', 'Moderate', 'Hard'],
                datasets: [{
                    data: [easy, moderate, hard],
                    backgroundColor: ['#10b981', '#f59e0b', '#dc2626']
                }]
            };

            charts.runningIntensity.update();
        }

        function updateRunningProgressTable(recentRuns, previousRuns) {
            const tbody = document.getElementById('runningProgressBody');
            if (!tbody) return;

            // Calculate metrics
            const currentMetrics = calculateRunMetrics(recentRuns);
            const previousMetrics = calculateRunMetrics(previousRuns);

            const rows = [
                {
                    metric: 'Avg Distance/Run',
                    previous: `${previousMetrics.avgDistance.toFixed(1)}km`,
                    current: `${currentMetrics.avgDistance.toFixed(1)}km`,
                    change: calculateChange(currentMetrics.avgDistance, previousMetrics.avgDistance)
                },
                {
                    metric: 'Weekly Runs',
                    previous: previousMetrics.weeklyRuns.toFixed(1),
                    current: currentMetrics.weeklyRuns.toFixed(1),
                    change: calculateChange(currentMetrics.weeklyRuns, previousMetrics.weeklyRuns)
                },
                {
                    metric: 'Avg Pace',
                    previous: formatPace(previousMetrics.avgPace),
                    current: formatPace(currentMetrics.avgPace),
                    change: calculateChange(previousMetrics.avgPace, currentMetrics.avgPace, true) // Reverse for pace
                },
                {
                    metric: 'Longest Run',
                    previous: `${previousMetrics.longestRun.toFixed(1)}km`,
                    current: `${currentMetrics.longestRun.toFixed(1)}km`,
                    change: calculateChange(currentMetrics.longestRun, previousMetrics.longestRun)
                }
            ];

            tbody.innerHTML = rows.map(row => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <td style="padding: 12px; color: #ffffff;">${row.metric}</td>
                    <td style="padding: 12px; text-align: center; color: #ffffff;">${row.previous}</td>
                    <td style="padding: 12px; text-align: center; color: #ffffff;">${row.current}</td>
                    <td style="padding: 12px; text-align: center; color: #ffffff;">${row.change}</td>
                </tr>
            `).join('');
        }

        function updateRunningRecords(allRuns) {
            const recordsDiv = document.getElementById('runningRecords');
            if (!recordsDiv) return;

            const records = findRunningRecords(allRuns);
            
            recordsDiv.innerHTML = records.map(record => `
                <div class="record-item">
                    <div>
                        <strong>${record.type}</strong>
                        <div style="font-size: 0.9rem; color: #6B7280;">
                            ${record.value} • ${record.date}
                        </div>
                    </div>
                    ${record.isNew ? '<span class="record-badge">NEW!</span>' : ''}
                </div>
            `).join('');
        }

        function updateRunningEnduranceChart(runs) {
            if (!charts.runningEndurance) {
                charts.runningEndurance = new Chart(document.getElementById('runningEnduranceChart'), {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Distance (km)' }
                            }
                        }
                    }
                });
            }

            // Group by week and find longest run per week
            const weeklyLongest = {};
            runs.forEach(run => {
                const weekStart = getWeekStart(new Date(run.start_date));
                const weekKey = weekStart.toISOString().split('T')[0];
                const distance = run.distance / 1000;
                
                if (!weeklyLongest[weekKey] || distance > weeklyLongest[weekKey]) {
                    weeklyLongest[weekKey] = distance;
                }
            });

            const weeks = Object.keys(weeklyLongest).sort();
            const distances = weeks.map(week => weeklyLongest[week]);

            charts.runningEndurance.data = {
                labels: weeks.map(w => new Date(w).toLocaleDateString()),
                datasets: [{
                    label: 'Longest Run',
                    data: distances,
                    backgroundColor: distances.map((d, i) => {
                        // Highlight new longest runs
                        if (i > 0 && d > Math.max(...distances.slice(0, i))) {
                            return '#10b981'; // Green for new record
                        }
                        return '#667eea';
                    })
                }]
            };

            charts.runningEndurance.update();
        }

        function generateRunningInsights(recentRuns, previousRuns) {
            const insights = [];
            
            // Load change insight
            const currentLoad = recentRuns.reduce((sum, r) => sum + (r.suffer_score || 0), 0);
            const previousLoad = previousRuns.reduce((sum, r) => sum + (r.suffer_score || 0), 0);
            const loadChange = previousLoad > 0 ? ((currentLoad - previousLoad) / previousLoad) * 100 : 0;
            
            if (loadChange > 20) {
                document.getElementById('runningLoadInsight').innerHTML = `
                    <h4><i class="fas fa-chart-line"></i> Increased Training Load</h4>
                    <p>Your training load is up ${Math.round(loadChange)}% from the previous 4 weeks. Ensure adequate recovery between hard sessions.</p>
                `;
            } else if (loadChange < -20) {
                document.getElementById('runningLoadInsight').innerHTML = `
                    <h4>📉 Reduced Training Load</h4>
                    <p>Your training load is down ${Math.abs(Math.round(loadChange))}%. This could be good for recovery or you might want to gradually increase volume.</p>
                `;
            }

            // Pace improvement insight
            const currentMetrics = calculateRunMetrics(recentRuns);
            const previousMetrics = calculateRunMetrics(previousRuns);
            
            if (currentMetrics.avgPace < previousMetrics.avgPace && currentMetrics.avgHR < previousMetrics.avgHR) {
                document.getElementById('runningPaceInsight').innerHTML = `
                    <h4>🚀 Fitness Improvement Detected</h4>
                    <p>Your pace is improving while heart rate is dropping - a clear sign of enhanced running economy!</p>
                `;
            }

            // Endurance insight
            const longestRecent = Math.max(...recentRuns.map(r => r.distance / 1000));
            const longestPrevious = previousRuns.length > 0 ? Math.max(...previousRuns.map(r => r.distance / 1000)) : 0;
            
            if (longestRecent > longestPrevious * 1.2) {
                let percentageIncrease;
                let message;

                if (longestPrevious === 0) {
                    // First long run - no previous data to compare
                    message = `You completed your longest run of ${longestRecent.toFixed(1)}km! Great start to building your endurance base.`;
                } else {
                    // Normal percentage calculation
                    percentageIncrease = Math.round((longestRecent - longestPrevious) / longestPrevious * 100);
                    message = `Your longest run increased by ${percentageIncrease}%! Your endurance base is expanding.`;
                }

                document.getElementById('runningEnduranceInsight').innerHTML = `
                    <h4><i class="fas fa-dumbbell"></i> Endurance Breakthrough</h4>
                    <p>${message}</p>
                `;
            }
        }

        // Helper functions
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function calculateRunMetrics(runs) {
            if (runs.length === 0) {
                return {
                    avgDistance: 0,
                    weeklyRuns: 0,
                    avgPace: 0,
                    longestRun: 0,
                    avgHR: 0
                };
            }

            const totalDistance = runs.reduce((sum, r) => sum + (r.distance || 0), 0) / 1000;
            const avgDistance = totalDistance / runs.length;
            const weeklyRuns = runs.length / 4;
            
            const paces = runs.map(r => r.distance > 0 ? (r.moving_time / 60) / (r.distance / 1000) : 0)
                .filter(p => p > 0 && p < 10);
            const avgPace = paces.length > 0 ? paces.reduce((a, b) => a + b) / paces.length : 0;
            
            const longestRun = Math.max(...runs.map(r => r.distance / 1000));
            
            const hrs = runs.map(r => r.average_heartrate || 0).filter(hr => hr > 0);
            const avgHR = hrs.length > 0 ? hrs.reduce((a, b) => a + b) / hrs.length : 0;

            return { avgDistance, weeklyRuns, avgPace, longestRun, avgHR };
        }

        function updateRunningFitnessMetrics(allRuns){const r=allRuns.filter(a=>{const t=(a.type||a.sport_type||'').toLowerCase();return t.includes('run')});if(!r.length)return;const d={},t=new Date();for(let i=0;i<42;i++){const e=new Date(t);e.setDate(e.getDate()-i);d[e.toISOString().split('T')[0]]=0}r.forEach(a=>{if(!a.start_date)return;const k=a.start_date.split('T')[0];if(d[k]!==undefined)d[k]+=(a.suffer_score||0)});let c=0;const cd=1-1/42;Object.keys(d).sort().reverse().forEach(k=>c=c*cd+d[k]);let a=0;const ad=1-1/7;Object.keys(d).sort().reverse().slice(0,7).forEach(k=>a=a*ad+d[k]);const s=c-a;document.getElementById('runningCTL').textContent=c.toFixed(1);document.getElementById('runningATL').textContent=a.toFixed(1);document.getElementById('runningTSB').textContent=s>0?'+'+s.toFixed(1):s.toFixed(1);const st=s>25?'Fresh & Rested 🌟':s>=0?'Race Ready 💪':s>=-10?'Neutral ⚖️':s>=-30?'Training Zone 🔥':'High Fatigue ⚠️';const co=s>25?'#10b981':s>=0?'#3b82f6':s>=-10?'#f59e0b':s>=-30?'#ef4444':'#dc2626';const f=document.getElementById('runningFormStatus');f.textContent=st;f.style.color=co}
        function updateRunningRecoveryMetrics() {
            let h = '--';
            let r = '--';
            let s = '--';
            let d = '--';

            const avg = arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0) / arr.length) : null;

            // Primary: Oura data (most recent first if available)
            if (fitnessData.oura && Array.isArray(fitnessData.oura.sleep)) {
                const sortedSleep = [...fitnessData.oura.sleep].sort((a,b) => new Date(b.day || b.summary_date || b.date || 0) - new Date(a.day || a.summary_date || a.date || 0));
                const sl = sortedSleep.slice(0, 7);
                const hv = sl.map(x => x.hrv_average || x.average_hrv || (x.heart_rate ? x.heart_rate.average_hrv : null)).filter(v => v);
                const rv = sl.map(x => x.resting_hr || x.average_heart_rate || (x.heart_rate ? x.heart_rate.resting_hr : null)).filter(v => v);
                const sv = sl.map(x => x.score).filter(v => v);
                if (hv.length > 0) h = Math.round(hv.reduce((a, b) => a + b) / hv.length);
                if (rv.length > 0) r = Math.round(rv.reduce((a, b) => a + b) / rv.length);
                if (sv.length > 0) s = Math.round(sv.reduce((a, b) => a + b) / sv.length);
            }

            if (fitnessData.oura && Array.isArray(fitnessData.oura.readiness)) {
                const sortedReadiness = [...fitnessData.oura.readiness].sort((a,b) => new Date(b.day || b.summary_date || b.date || 0) - new Date(a.day || a.summary_date || a.date || 0));
                const rs = sortedReadiness.slice(0, 7).map(x => x.score).filter(v => v);
                if (rs.length > 0) d = Math.round(rs.reduce((a, b) => a + b) / rs.length);
            }

            // Fallback: Garmin daily summaries (when Oura/Whoop not connected)
            if (h === '--' || r === '--' || s === '--' || d === '--') {
                const raw = fitnessData.garmin?.dailySummary;
                const dailies = Array.isArray(raw) ? raw : (raw?.dailies || []);
                if (dailies.length > 0) {
                    const sorted = [...dailies].sort((a,b) => new Date(b.calendarDate || b.startDate || 0) - new Date(a.calendarDate || a.startDate || 0));
                    const recent = sorted.slice(0, 7);

                    const hrvVals = recent.map(x => x.hrvAvg ?? x.averageHrv ?? x.hrvAverage ?? x.hrv).filter(v => v !== undefined && v !== null && !Number.isNaN(v));
                    const rhrVals = recent.map(x => x.restingHr ?? x.restingHeartRate ?? x.resting_heart_rate).filter(v => v !== undefined && v !== null && !Number.isNaN(v));
                    const sleepVals = recent.map(x => x.sleepHours ?? (x.sleepingSeconds !== undefined ? x.sleepingSeconds / 3600 : null)).filter(v => v !== undefined && v !== null && !Number.isNaN(v));
                    const readinessVals = recent.map(x => x.bodyBatteryHighestValue ?? x.bodyBatteryChargedValue ?? null).filter(v => v !== undefined && v !== null && !Number.isNaN(v));

                    if (h === '--' && hrvVals.length) h = avg(hrvVals);
                    if (r === '--' && rhrVals.length) r = avg(rhrVals);
                    if (s === '--' && sleepVals.length) s = (sleepVals.reduce((a, b) => a + b, 0) / sleepVals.length).toFixed(1);
                    if (d === '--' && readinessVals.length) d = avg(readinessVals);
                }
            }

            document.getElementById('runningHRV').textContent = h;
            document.getElementById('runningRHR').textContent = r;
            document.getElementById('runningSleep').textContent = s;
            document.getElementById('runningReadiness').textContent = d;
        }
        function updateRunningPerformanceMetrics(runs){const p=runs.map(r=>r.distance>1000&&r.moving_time>0?(r.moving_time/60)/(r.distance/1000):null).filter(x=>x&&x<10&&x>2);if(p.length>0){const a=p.reduce((x,y)=>x+y)/p.length;const b=Math.min(...p);document.getElementById('runningAvgPace').textContent=Math.floor(a)+':'+Math.round((a%1)*60).toString().padStart(2,'0');document.getElementById('runningBestPace').textContent=Math.floor(b)+':'+Math.round((b%1)*60).toString().padStart(2,'0');const v=Math.round(-4.60+0.182258*(60/a)+0.000104*Math.pow(60/a,2));document.getElementById('runningVO2max').textContent=v>0?v:'--'}else{document.getElementById('runningAvgPace').textContent='--';document.getElementById('runningBestPace').textContent='--';document.getElementById('runningVO2max').textContent='--'}const h=runs.map(r=>r.average_heartrate).filter(x=>x>0);document.getElementById('runningAvgHR').textContent=h.length>0?Math.round(h.reduce((a,b)=>a+b)/h.length)+' bpm':'--'}
        function updateRunningFormMetrics(runs){
            const cadenceValues = runs
                .map(r => r.average_cadence)
                .filter(x => x)
                .map(x => x > 120 ? x : Math.round(x * 2)); // Strava per-leg cadence -> steps/min

            const strideValues = runs
                .map(r => r.average_stride_length)
                .filter(x => x);

            const gctValues = runs
                .map(r => r.ground_contact_time)
                .filter(x => x);

            const voValues = runs
                .map(r => r.vertical_oscillation)
                .filter(x => x);

            document.getElementById('runningCadence').textContent = cadenceValues.length > 0
                ? Math.round(cadenceValues.reduce((a,b)=>a+b)/cadenceValues.length)
                : '--';

            document.getElementById('runningStrideLength').textContent = strideValues.length > 0
                ? (strideValues.reduce((a,b)=>a+b)/strideValues.length).toFixed(2)
                : '--';

            document.getElementById('runningGCT').textContent = gctValues.length > 0
                ? Math.round(gctValues.reduce((a,b)=>a+b)/gctValues.length) + ' ms'
                : '--';

            document.getElementById('runningVertOsc').textContent = voValues.length > 0
                ? (voValues.reduce((a,b)=>a+b)/voValues.length).toFixed(1) + ' cm'
                : '--';
        }
        function updateRunningWeeklyProgress(recent,prev,last){const o=new Date(Date.now()-7*86400000);const t=new Date(Date.now()-14*86400000);const tw=recent.filter(r=>new Date(r.start_date)>=o);const lw=recent.filter(r=>{const d=new Date(r.start_date);return d>=t&&d<o});const td=tw.reduce((s,r)=>s+(r.distance||0),0)/1000;const ld=lw.reduce((s,r)=>s+(r.distance||0),0)/1000;const dc=ld>0?((td-ld)/ld*100):0;document.getElementById('runningWeeklyDistChange').innerHTML='<span style="color:'+(dc>=0?'#10b981':'#ef4444')+'">'+(dc>=0?'+':'')+dc.toFixed(1)+'%</span>';document.getElementById('runningWeeklyRunsChange').innerHTML='<span style="color:'+(tw.length>=lw.length?'#10b981':'#ef4444')+'">'+(tw.length>=lw.length?'+':'')+(tw.length-lw.length)+'</span>';const tl=tw.reduce((s,r)=>s+(r.suffer_score||0),0);const ll=lw.reduce((s,r)=>s+(r.suffer_score||0),0);const lc=ll>0?((tl-ll)/ll*100):0;document.getElementById('runningWeeklyLoadChange').innerHTML='<span style="color:'+(lc>=0?'#10b981':'#ef4444')+'">'+(lc>=0?'+':'')+lc.toFixed(1)+'%</span>';document.getElementById('runningWeeklyPaceChange').textContent='--';document.getElementById('runningWeeklyLongestChange').textContent='--'}
        function updateRunningPersonalRecords(all){const r=all.filter(a=>{const t=(a.type||a.sport_type||'').toLowerCase();return t.includes('run')});const f=(d)=>{const tol=d*0.05;const c=r.filter(x=>Math.abs(x.distance-d)<=tol&&x.moving_time>0);if(!c.length)return null;return c.reduce((b,c)=>(c.moving_time/c.distance)<(b.moving_time/b.distance)?c:b)};const ft=(s)=>{const h=Math.floor(s/3600);const m=Math.floor((s%3600)/60);const se=Math.round(s%60);return h>0?h+':'+m.toString().padStart(2,'0')+':'+se.toString().padStart(2,'0'):m+':'+se.toString().padStart(2,'0')};const p5=f(5000);document.getElementById('runningPR5k').textContent=p5?ft(p5.moving_time):'--';const p10=f(10000);document.getElementById('runningPR10k').textContent=p10?ft(p10.moving_time):'--';const ph=f(21097);document.getElementById('runningPRHalf').textContent=ph?ft(ph.moving_time):'--';const pm=f(42195);document.getElementById('runningPRMarathon').textContent=pm?ft(pm.moving_time):'--';if(r.length>0){const l=r.reduce((m,x)=>x.distance>m.distance?x:m);document.getElementById('runningPRLongest').textContent=(l.distance/1000).toFixed(2)+' km';const e=r.reduce((m,x)=>(x.total_elevation_gain||0)>(m.total_elevation_gain||0)?x:m);document.getElementById('runningPRElevation').textContent=Math.round(e.total_elevation_gain||0)+' m'}}
        function updateRunningHRZonesChart(runs) {
            const canvas = document.getElementById('runningHRZonesChart');
            if (!canvas) return;

            const hrValues = runs.map(r => r.average_heartrate || r.max_heartrate).filter(v => v);
            if (!hrValues.length) {
                canvas.parentElement.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:12px;">No heart rate data yet</div>';
                return;
            }

            const maxHr = Math.max(...hrValues);
            const buckets = [0, 0, 0, 0, 0]; // Z1- Z5

            runs.forEach(run => {
                const hr = run.average_heartrate || run.max_heartrate;
                if (!hr || !run.moving_time) return;
                const pct = hr / maxHr;
                const idx = pct < 0.6 ? 0 : pct < 0.7 ? 1 : pct < 0.8 ? 2 : pct < 0.9 ? 3 : 4;
                buckets[idx] += run.moving_time / 60; // minutes
            });

            if (!charts.runningHRZones) {
                charts.runningHRZones = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            charts.runningHRZones.data = {
                labels: ['Z1', 'Z2', 'Z3', 'Z4', 'Z5'],
                datasets: [{
                    label: 'Minutes',
                    data: buckets.map(v => Math.round(v)),
                    backgroundColor: ['#22c55e','#a3e635','#facc15','#f97316','#ef4444']
                }]
            };
            charts.runningHRZones.update();
        }

        function updateRunningIntensityPyramid(runs) {
            const canvas = document.getElementById('runningIntensityPyramid');
            if (!canvas) return;

            const buckets = { easy: 0, moderate: 0, hard: 0 };

            runs.forEach(run => {
                const moveMin = (run.moving_time || 0) / 60;
                const suffer = run.suffer_score || ((run.average_heartrate || 0) > 0 ? (run.average_heartrate / 200) * moveMin : 0);
                if (moveMin <= 0) return;
                const spm = suffer / moveMin;
                if (spm < 0.5) buckets.easy += moveMin;
                else if (spm < 1.0) buckets.moderate += moveMin;
                else buckets.hard += moveMin;
            });

            const total = buckets.easy + buckets.moderate + buckets.hard;
            if (total === 0) {
                canvas.parentElement.innerHTML = '<div style="text-align:center; color:#9ca3af; padding:12px;">No intensity data yet</div>';
                return;
            }

            if (!charts.runningIntensityPyramid) {
                charts.runningIntensityPyramid = new Chart(canvas, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            charts.runningIntensityPyramid.data = {
                labels: ['Easy', 'Moderate', 'Hard'],
                datasets: [{ data: [buckets.easy, buckets.moderate, buckets.hard], backgroundColor: ['#10b981','#f59e0b','#ef4444'] }]
            };
            charts.runningIntensityPyramid.update();
        }

        function updateRunningFitnessTrendChart(runs) {
            const canvas = document.getElementById('runningFitnessTrend');
            if (!canvas) return;

            const today = new Date();
            const start = new Date(today.getTime() - 42 * 86400000);
            const daily = {};

            runs.forEach(run => {
                const d = new Date(run.start_date);
                if (d < start) return;
                const key = d.toISOString().split('T')[0];
                const baseHr = run.average_heartrate || run.max_heartrate || 0;
                const pseudoLoad = baseHr > 0 ? (baseHr / 200) * ((run.moving_time || 0) / 60) : (run.distance ? run.distance / 1000 : 0);
                const load = run.suffer_score || pseudoLoad;
                daily[key] = (daily[key] || 0) + load;
            });

            const days = [];
            for (let i = 0; i <= 42; i++) {
                const d = new Date(start.getTime() + i * 86400000);
                days.push(d.toISOString().split('T')[0]);
            }

            let ctl = 0; let atl = 0;
            const ctlArr = []; const atlArr = []; const tsbArr = [];

            days.forEach(day => {
                const load = daily[day] || 0;
                ctl = ctl * (1 - 1/42) + load; // 42-day decay
                atl = atl * (1 - 1/7) + load;  // 7-day decay
                ctlArr.push(ctl.toFixed(1));
                atlArr.push(atl.toFixed(1));
                tsbArr.push((ctl - atl).toFixed(1));
            });

            if (!charts.runningFitnessTrend) {
                charts.runningFitnessTrend = new Chart(canvas, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } } }
                });
            }

            charts.runningFitnessTrend.data = {
                labels: days,
                datasets: [
                    { label: 'CTL', data: ctlArr, borderColor: '#10b981', backgroundColor: 'transparent', tension: 0.3 },
                    { label: 'ATL', data: atlArr, borderColor: '#f59e0b', backgroundColor: 'transparent', tension: 0.3 },
                    { label: 'TSB', data: tsbArr, borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.3 }
                ]
            };
            charts.runningFitnessTrend.update();
        }

        function updateRunningVolumeChart(runs) {
            const canvas = document.getElementById('runningVolumeChart');
            if (!canvas) return;

            const weeks = {};
            runs.forEach(run => {
                const d = new Date(run.start_date);
                if (Number.isNaN(d.getTime())) return;
                const week = getWeekStart(d).toISOString().split('T')[0];
                weeks[week] = (weeks[week] || 0) + (run.distance || 0);
            });

            const labels = Object.keys(weeks).sort();
            const data = labels.map(k => (weeks[k] / 1000).toFixed(1));

            if (!charts.runningVolume) {
                charts.runningVolume = new Chart(canvas, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            charts.runningVolume.data = {
                labels,
                datasets: [{ label: 'Weekly km', data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.2)', tension: 0.3, fill: true }]
            };
            charts.runningVolume.update();
        }

        function updateRunningPaceProgressionChart(runs) {
            const canvas = document.getElementById('runningPaceProgression');
            if (!canvas) return;

            const targets = [5000, 10000, 21097, 42195];
            const labels = ['5K', '10K', 'Half', 'Marathon'];
            const paces = targets.map((dist, idx) => {
                const tol = dist * 0.05;
                const match = runs.filter(r => Math.abs((r.distance || 0) - dist) <= tol && r.moving_time > 0);
                if (!match.length) return null;
                const best = match.reduce((b, c) => (c.moving_time / (c.distance || 1)) < (b.moving_time / (b.distance || 1)) ? c : b);
                const pace = (best.moving_time / 60) / ((best.distance || dist) / 1000);
                return pace;
            });

            if (!charts.runningPaceProgression) {
                charts.runningPaceProgression = new Chart(canvas, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                reverse: true,
                                ticks: {
                                    callback: (value) => {
                                        const m = Math.floor(value);
                                        const s = Math.round((value - m) * 60);
                                        return `${m}:${s.toString().padStart(2, '0')}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            charts.runningPaceProgression.data = {
                labels,
                datasets: [{
                    label: 'Best pace (min/km)',
                    data: paces,
                    backgroundColor: '#10b981'
                }]
            };
            charts.runningPaceProgression.update();
        }

        function formatPace(paceMinPerKm) {
            if (paceMinPerKm === 0) return '--';
            const minutes = Math.floor(paceMinPerKm);
            const seconds = Math.round((paceMinPerKm - minutes) * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}/km`;
        }

        function calculateChange(current, previous, reverse = false) {
            if (previous === 0) return '🆕';
            const change = ((current - previous) / previous) * 100;
            const actualChange = reverse ? -change : change;
            
            if (Math.abs(actualChange) < 1) return '→';
            
            const arrow = actualChange > 0 ? '🔼' : '🔽';
            const color = actualChange > 0 ? '#10b981' : '#dc2626';
            return `<span style="color: ${color}">${arrow} ${Math.abs(Math.round(actualChange))}%</span>`;
        }

        function findRunningRecords(allRuns) {
            const records = [];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            
            // Find fastest runs by common distances
            const distanceRecords = {
                '1K': { min: 950, max: 1050 },
                '5K': { min: 4900, max: 5100 },
                '10K': { min: 9900, max: 10100 },
                'Half Marathon': { min: 21000, max: 21200 },
                'Marathon': { min: 42000, max: 42300 }
            };

            Object.entries(distanceRecords).forEach(([distance, range]) => {
                const qualifyingRuns = allRuns.filter(r => 
                    r.distance >= range.min && r.distance <= range.max
                );
                
                if (qualifyingRuns.length > 0) {
                    const fastest = qualifyingRuns.reduce((best, run) => 
                        run.moving_time < best.moving_time ? run : best
                    );
                    
                    records.push({
                        type: `Fastest ${distance}`,
                        value: formatTime(fastest.moving_time),
                        date: new Date(fastest.start_date).toLocaleDateString(),
                        isNew: new Date(fastest.start_date) >= thirtyDaysAgo
                    });
                }
            });

            // Longest run
            const longestRun = allRuns.reduce((longest, run) => 
                run.distance > longest.distance ? run : longest
            , allRuns[0] || { distance: 0 });

            if (longestRun.distance > 0) {
                records.push({
                    type: 'Longest Run',
                    value: `${(longestRun.distance / 1000).toFixed(1)}km`,
                    date: new Date(longestRun.start_date).toLocaleDateString(),
                    isNew: new Date(longestRun.start_date) >= thirtyDaysAgo
                });
            }

            return records;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function showEmptyRunningState() {
            document.getElementById('runningDistance').textContent = '--';
            document.getElementById('runningFrequency').textContent = '--';
            document.getElementById('runningDuration').textContent = '--';
            document.getElementById('runningElevation').textContent = '--';
            
            const emptyMessage = '<div style="text-align: center; padding: 20px; color: #6B7280;">Connect Strava or Garmin to see your running analytics</div>';
            
            document.getElementById('runningLoadInsight').innerHTML = emptyMessage;
            document.getElementById('runningPaceInsight').innerHTML = emptyMessage;
            document.getElementById('runningEnduranceInsight').innerHTML = emptyMessage;
            document.getElementById('runningProgressBody').innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6B7280;">No running data available</td></tr>`;
            document.getElementById('runningRecords').innerHTML = emptyMessage;
        }

        // Tab event listeners initialized in main DOMContentLoaded below (line ~4280)

        async function clearAllData() {
            if (confirm('Clear all connected device data? You\'ll need to reconnect each service.')) {
                // Delete tokens from backend database
                const userId = localStorage.getItem('userId');
                if (userId) {
                    try {
                        const providers = ['strava', 'oura', 'garmin', 'whoop'];
                        for (const provider of providers) {
                            await fetch(`${API_CONFIG.backend}/api/sync/delete-token`, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId, provider })
                            }).catch(err => console.warn(`Failed to delete ${provider} token:`, err));
                        }
                    } catch (error) {
                        console.error('Error deleting tokens from database:', error);
                    }
                }

                fitnessData = {
                    strava: null,
                    oura: null,
                    whoop: null,
                    garmin: null,
                    lastUpdated: null
                };

                localStorage.removeItem('strava_token');
                localStorage.removeItem('strava_expiry');
                localStorage.removeItem('oura_token');
                localStorage.removeItem('oura_expiry');
                localStorage.removeItem('garmin_token');
                localStorage.removeItem('garmin_expiry');
                localStorage.removeItem('garmin_refresh_token');
                localStorage.removeItem('whoop_token');
                localStorage.removeItem('whoop_expiry');
                localStorage.removeItem('whoop_refresh_token');

                // Clear sessionStorage OAuth data as well
                if (typeof sessionStorage !== 'undefined') {
                    sessionStorage.removeItem('garmin_oauth_state');
                    sessionStorage.removeItem('garmin_code_verifier');
                    sessionStorage.removeItem('whoop_oauth_state');
                    sessionStorage.removeItem('whoop_code_verifier');
                }

                document.querySelector('.btn-strava').innerHTML = 'Connect Strava';
                document.querySelector('.btn-oura').innerHTML = 'Connect Oura';
                document.querySelector('.btn-garmin').innerHTML = 'Connect Garmin';
                document.querySelector('.btn-whoop').innerHTML = 'Connect Whoop';

                document.querySelectorAll('.connect-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('connected');
                });

                updateConnectionStatus();
                showMessage('All data cleared. Ready to reconnect devices.', 'info');
            }
        }

        // Sync data from all connected providers to PostgreSQL database
        async function syncAllProviders() {
            const syncBtn = document.getElementById('syncBtn');
            const originalContent = syncBtn ? syncBtn.innerHTML : '';

            try {
                if (syncBtn) {
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
                    syncBtn.disabled = true;
                } else {
                    console.warn('syncBtn not found; proceeding without UI update');
                }

                showMessage('Syncing data from all connected providers...', 'info');

                const userId = localStorage.getItem('userId');
                const sessionToken = localStorage.getItem('sessionToken');
                if (!userId) {
                    showMessage('Please login or connect a device first', 'error');
                    return;
                }

                // Call backend sync endpoint
                const response = await fetch(`${API_CONFIG.backend}/api/sync/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(sessionToken ? { 'Authorization': `Bearer ${sessionToken}` } : {})
                    },
                    body: JSON.stringify({ userId, daysBack: 30, sessionToken })
                });

                const data = await response.json();

                if (response.ok) {
                    const totalActivities = data.results?.totalActivities || 0;
                    showMessage(`Sync complete! ${totalActivities} activities synced from all providers`, 'success');

                    // Reload data to display newly synced activities
                    await loadExistingConnections();
                    updateAnalytics();
                } else {
                    showMessage(data.message || data.error || 'Sync failed', 'error');
                }

            } catch (error) {
                console.error('Sync error:', error);
                showMessage('Sync failed. Please try again.', 'error');
            } finally {
                if (syncBtn) {
                    syncBtn.innerHTML = originalContent;
                    syncBtn.disabled = false;
                }
            }
        }

        async function ensureWhoopToken() {
            const accessToken = localStorage.getItem('whoop_token') || localStorage.getItem('whoop_access_token');
            const refreshToken = localStorage.getItem('whoop_refresh_token');
            const expiresAtRaw = localStorage.getItem('whoop_token_expires_at') || localStorage.getItem('whoop_access_token_expires_at');
            const expiresAt = expiresAtRaw ? new Date(expiresAtRaw) : null;
            const now = new Date();

            // If no token, return null so caller can skip
            if (!accessToken && !refreshToken) return null;

            // If we have a token but no expiry (older storage), set a short-lived expiry to trigger refresh soon
            if (accessToken && !expiresAt && refreshToken) {
                const softExp = new Date(Date.now() + 10 * 60 * 1000); // 10 minutes from now
                localStorage.setItem('whoop_token_expires_at', softExp.toISOString());
                localStorage.setItem('whoop_access_token_expires_at', softExp.toISOString());
            }

            // If we have expiry and it's still valid for 5 more minutes, just return it
            if (accessToken && expiresAt && expiresAt.getTime() - now.getTime() > 5 * 60 * 1000) {
                return accessToken;
            }

            // Need refresh
            if (!refreshToken) {
                console.warn('Whoop token expired and no refresh token stored');
                return null;
            }

            try {
                const res = await fetch(`${API_CONFIG.backend}/api/whoop/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken, client_id: whoopAuth?.clientId || '31c6c2ac-890c-46ef-81da-b961c1cb1ca7', client_secret: whoopAuth?.clientSecret || '45080f98c58c1aad56f6e0076b014e3dc58356f4763efaf3df2307057ce4b14f' })
                });
                const data = await res.json();
                if (!res.ok || !data.access_token) {
                    console.warn('Whoop refresh failed:', data);
                    return null;
                }
                localStorage.setItem('whoop_token', data.access_token);
                localStorage.setItem('whoop_access_token', data.access_token);
                if (data.refresh_token) localStorage.setItem('whoop_refresh_token', data.refresh_token);
                if (data.expires_in) {
                    const newExp = new Date(Date.now() + data.expires_in * 1000).toISOString();
                    localStorage.setItem('whoop_token_expires_at', newExp);
                    localStorage.setItem('whoop_access_token_expires_at', newExp);
                }
                return data.access_token;
            } catch (e) {
                console.warn('Whoop refresh error:', e);
                return null;
            }
        }

        async function refreshAllData() {
            showMessage('Refreshing all connected data...', 'info');

            const stravaToken = localStorage.getItem('strava_token');
            const ouraToken = localStorage.getItem('oura_token');
            const whoopToken = await ensureWhoopToken();
            const garminToken = localStorage.getItem('garmin_token');

            const refreshPromises = [];

            if (stravaToken) {
                refreshPromises.push(fetchStravaData(stravaToken));
            }

            if (ouraToken) {
                refreshPromises.push(fetchOuraData(ouraToken));
            }

            if (whoopToken) {
                refreshPromises.push(fetchWhoopData(whoopToken));
            }

            if (garminToken) {
                refreshPromises.push(fetchGarminData(garminToken));
            }

            if (refreshPromises.length === 0) {
                showMessage('No connected devices to refresh', 'warning');
                return;
            }

            try {
                await Promise.all(refreshPromises);
                // Force UI refresh after data loads
                try { if (typeof updateAnalytics === 'function') updateAnalytics(); } catch(_) {}
                try {
                    const garminTab = document.getElementById('garmin');
                    if (garminTab && garminTab.classList.contains('active') && typeof updateGarminDisplay === 'function') {
                        updateGarminDisplay();
                    }
                } catch(_) {}
                showMessage('All data refreshed successfully!', 'success');
            } catch (error) {
                showMessage('Some data failed to refresh', 'warning');
                console.error('Refresh error:', error);
            }
        }

        function showMessage(message, type = 'info') {
            // On mobile, skip connection success messages to avoid distraction
            const isMobile = window.innerWidth <= 768;
            if (isMobile && type === 'success' && message.toLowerCase().includes('connect')) {
                console.log(' Mobile: Skipping connection alert:', message);
                return; // Don't show connection alerts on mobile
            }

            const messageDiv = document.createElement('div');
            const colors = {
                success: 'rgba(16, 185, 129, 0.1)',
                error: 'rgba(220, 38, 38, 0.3)',  // Brighter red for errors
                warning: 'rgba(245, 158, 11, 0.1)',
                info: 'rgba(59, 130, 246, 0.1)'
            };

            const borderColors = {
                success: 'rgba(16, 185, 129, 0.2)',
                error: 'rgba(220, 38, 38, 0.5)',  // Brighter red border for errors
                warning: 'rgba(245, 158, 11, 0.2)',
                info: 'rgba(59, 130, 246, 0.2)'
            };

            // Count existing messages to stack them
            const existingMessages = document.querySelectorAll('.status-message');
            const offset = existingMessages.length * (isMobile ? 20 : 28);

            messageDiv.className = 'status-message';

            if (isMobile) {
                // Mobile: very subtle, small toast
                messageDiv.style.cssText = `
                    position: fixed;
                    bottom: ${120 + offset}px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${colors[type]};
                    backdrop-filter: blur(6px);
                    -webkit-backdrop-filter: blur(6px);
                    color: rgba(255, 255, 255, 0.85);
                    padding: 5px 10px;
                    border-radius: 6px;
                    border: 1px solid ${borderColors[type]};
                    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
                    z-index: 998;
                    max-width: 180px;
                    font-size: 0.65rem;
                    font-weight: 400;
                    transition: opacity 0.2s ease;
                    opacity: 0;
                    pointer-events: none;
                    text-align: center;
                `;
            } else {
                // Desktop: bottom-left as before
                const textColor = type === 'error' ? 'rgba(255, 255, 255, 0.95)' : 'rgba(255, 255, 255, 0.7)';
                messageDiv.style.cssText = `
                    position: fixed;
                    bottom: ${80 + offset}px;
                    left: 20px;
                    background: ${colors[type]};
                    backdrop-filter: blur(8px);
                    -webkit-backdrop-filter: blur(8px);
                    color: ${textColor};
                    padding: 4px 10px;
                    border-radius: 4px;
                    border: 1px solid ${borderColors[type]};
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    z-index: 1000;
                    max-width: 220px;
                    font-size: 0.65rem;
                    font-weight: 400;
                    transition: opacity 0.3s ease;
                    opacity: 0.5;
                    pointer-events: none;
                `;
            }

            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            // Fade in - very subtle on mobile
            setTimeout(() => messageDiv.style.opacity = isMobile ? '0.65' : '0.6', 10);

            // Fade out and remove - errors stay 2x longer so users can read them
            const fadeOutTime = type === 'error' ? (isMobile ? 2400 : 3600) : (isMobile ? 1200 : 1800);
            const removeTime = type === 'error' ? (isMobile ? 3000 : 4400) : (isMobile ? 1500 : 2200);
            setTimeout(() => messageDiv.style.opacity = '0', fadeOutTime);
            setTimeout(() => messageDiv.remove(), removeTime);
        }

        // ===== CHART INITIALIZATION =====
        function initializeCharts() {
            try {
                // Check if Chart.js is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded');
                    return;
                }

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                };

                // Initialize only the charts that exist in the HTML
                charts.scoreTrend = new Chart(document.getElementById('scoreTrendChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: { ...chartOptions }
            });

            charts.scoreBreakdown = new Chart(document.getElementById('scoreBreakdownChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { ...chartOptions }
            });

            charts.stravaLoad = new Chart(document.getElementById('stravaLoadChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { ...chartOptions }
            });

            charts.ouraSleepStages = new Chart(document.getElementById('ouraSleepStagesChart'), {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: { 
                    ...chartOptions, 
                    plugins: { legend: { display: true } },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, title: { display: true, text: 'Hours' } }
                    }
                }
            });

            charts.ouraCorrelation = new Chart(document.getElementById('ouraCorrelationChart'), {
                type: 'scatter',
                data: { datasets: [] },
                options: { 
                    ...chartOptions,
                    plugins: { legend: { display: true }, tooltip: { callbacks: { label: ctx => `HRV ${ctx.parsed.x} ms, Readiness ${ctx.parsed.y}` } } }
                }
            });

            charts.whoopTrend = new Chart(document.getElementById('whoopTrendChart'), {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    plugins: { legend: { display: true } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Score (%)' }
                        }
                    }
                }
            });

            // Additional charts if present
            if (document.getElementById('ouraTrendRS')) {
                charts.ouraTrendRS = new Chart(document.getElementById('ouraTrendRS'), {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { 
                        ...chartOptions,
                        plugins: { legend: { display: true } },
                        scales: { y: { min: 0, max: 100, title: { display: true, text: 'Score' } } }
                    }
                });
            }
            if (document.getElementById('ouraTrendHRVHR')) {
                charts.ouraTrendHRVHR = new Chart(document.getElementById('ouraTrendHRVHR'), {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { 
                        ...chartOptions,
                        plugins: { legend: { display: true } },
                        scales: { y: { title: { display: true, text: 'HR / HRV' } } }
                    }
                });
            }
            if (document.getElementById('whoopRecoveryTrendChart')) {
                charts.whoopRecoveryTrend = new Chart(document.getElementById('whoopRecoveryTrendChart'), {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: { 
                        ...chartOptions,
                        plugins: { legend: { display: true } },
                        scales: { y: { min: 0, max: 100, title: { display: true, text: 'Recovery %' } } }
                    }
                });
            }
            if (document.getElementById('stravaIntensityDistChart')) {
                charts.stravaIntensityDist = new Chart(document.getElementById('stravaIntensityDistChart'), {
                    type: 'bar',
                    data: { labels: ['Very Easy','Easy','Moderate','Hard','Very Hard'], datasets: [{ data: [], backgroundColor: ['#93c5fd','#60a5fa','#3b82f6','#2563eb','#1d4ed8'] }] },
                    options: { 
                        ...chartOptions,
                        plugins: { legend: { display: false } },
                        scales: { y: { title: { display: true, text: 'Minutes' } } }
                    }
                });
            }
            } catch (error) {
                console.error('Chart initialization failed:', error);
            }
        }
        
        // Tab switching function - SIMPLIFIED
        function switchTab(tabName, clickedButton) {
            console.log('=== SWITCH TAB START ===', tabName);

            // Hide all panels
            const allPanels = document.querySelectorAll('.tab-panel');
            allPanels.forEach(panel => {
                panel.classList.remove('active');
                console.log('Hiding:', panel.id);
            });

            // Deactivate all buttons (both old tab-button and new sidebar-link)
            document.querySelectorAll('.tab-button, .sidebar-link').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            // Show/hide score hero section based on tab
            const scoreHero = document.querySelector('.score-hero-section');
            const tabContentWrapper = document.querySelector('.tab-content-wrapper');
            if (scoreHero) {
                if (tabName === 'connections') {
                    scoreHero.style.display = 'block';
                    if (tabContentWrapper) tabContentWrapper.style.marginTop = 'var(--space-4)';
                } else {
                    scoreHero.style.display = 'none';
                    // When score hero is hidden, remove top margin to bring content up
                    if (tabContentWrapper) tabContentWrapper.style.marginTop = '0';
                }
            }

            // Show target panel
            const targetPanel = document.getElementById(tabName);
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Showing:', tabName, 'has active class:', targetPanel.classList.contains('active'));

                // Activate button
                if (clickedButton) {
                    clickedButton.classList.add('active');
                    clickedButton.setAttribute('aria-selected', 'true');
                }

                // Close mobile sidebar after selection
                if (window.innerWidth < 1024) {
                    closeSidebar();
                }

                // Trigger updates
                if (['overview', 'strava', 'oura', 'garmin', 'whoop', 'insights'].includes(tabName)) {
                    if (typeof updateAnalytics === 'function') updateAnalytics();
                }
                if (tabName === 'running' && typeof updateRunningAnalytics === 'function') {
                    updateRunningAnalytics();
                }
                if (tabName === 'garmin') {
                    console.log(' Garmin tab detected, typeof updateGarminDisplay:', typeof updateGarminDisplay);
                    if (typeof updateGarminDisplay === 'function') {
                        console.log(' Calling updateGarminDisplay NOW!');
                        updateGarminDisplay();
                    } else {
                        console.log(' updateGarminDisplay is not a function!');
                    }
                }
            }
            console.log('=== SWITCH TAB END ===');
        }

        // Tab scroll indicators for mobile
        function updateTabScrollIndicators() {
            const tabNav = document.getElementById('tabNav');
            const leftIndicator = document.getElementById('tabScrollLeft');
            const rightIndicator = document.getElementById('tabScrollRight');

            if (!tabNav || !leftIndicator || !rightIndicator) return;

            // Only show on mobile when content is scrollable
            const isMobile = window.innerWidth < 768;
            const isScrollable = tabNav.scrollWidth > tabNav.clientWidth;

            if (!isMobile || !isScrollable) {
                leftIndicator.classList.remove('visible');
                rightIndicator.classList.remove('visible');
                return;
            }

            const scrollLeft = tabNav.scrollLeft;
            const maxScroll = tabNav.scrollWidth - tabNav.clientWidth;

            // Show left arrow if not at start
            if (scrollLeft > 10) {
                leftIndicator.classList.add('visible');
            } else {
                leftIndicator.classList.remove('visible');
            }

            // Show right arrow if not at end
            if (scrollLeft < maxScroll - 10) {
                rightIndicator.classList.add('visible');
            } else {
                rightIndicator.classList.remove('visible');
            }
        }

        // Drawer controls (home)
        (function initHomeDrawer(){
            const btn = document.getElementById('hamburgerBtn');
            if (btn) btn.addEventListener('click', toggleHomeDrawer);
        })();
        function toggleHomeDrawer(){
            const drawer = document.getElementById('homeDrawer');
            const overlay = document.getElementById('homeDrawerOverlay');
            if (!drawer || !overlay) return;
            const open = !drawer.classList.contains('open');
            overlay.style.display = open ? 'block' : 'none';
            drawer.classList.toggle('open', open);
        }
        function closeHomeDrawer(){
            const drawer = document.getElementById('homeDrawer');
            const overlay = document.getElementById('homeDrawerOverlay');
            if (!drawer || !overlay) return;
            overlay.style.display = 'none';
            drawer.classList.remove('open');
        }

        // ---- Sidebar Toggle Functions (for new vertical layout) ----
        function toggleSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerBtn');

            if (!sidebar || !overlay) return;

            const isOpen = sidebar.classList.contains('open');

            if (isOpen) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                if (hamburger) hamburger.classList.add('active');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const hamburger = document.getElementById('hamburgerBtn');

            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('active');
            if (hamburger) hamburger.classList.remove('active');
        }

        // Close sidebar when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('sidebarOverlay');
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }

            // Close sidebar on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeSidebar();
                }
            });
        });

        // ---- Export current tab to PDF (uses browser print-to-PDF) ----
        function exportTabToPDF(tabId, prefix = 'Export') {
            try {
                const originalTitle = document.title;
                const tab = document.getElementById(tabId);
                if (!tab) { showMessage('Tab not found for export', 'error'); return; }
                document.body.classList.add('print-mode');
                // Clear previous targets
                document.querySelectorAll('.print-target').forEach(el => el.classList.remove('print-target'));
                tab.classList.add('print-target');
                // Set filename via title (most browsers use page title)
                const date = new Date().toISOString().split('T')[0];
                document.title = `Athlytx-${prefix}-${date}`;

                const cleanup = () => {
                    document.body.classList.remove('print-mode');
                    tab.classList.remove('print-target');
                    document.title = originalTitle;
                };
                const afterPrint = () => { cleanup(); window.removeEventListener('afterprint', afterPrint); };
                window.addEventListener('afterprint', afterPrint);
                window.print();
                // Fallback cleanup in case afterprint doesn't fire
                setTimeout(() => { cleanup(); }, 2000);
            } catch (e) {
                console.error('Export error:', e);
                showMessage('Export failed: ' + e.message, 'error');
            }
        }

        // ---- Garmin helpers ----
        async function registerGarmin() {
            try {
                const status = document.getElementById('garminActionStatus');
                if (status) status.textContent = 'Registering with Garmin...';
                const userId = localStorage.getItem('userId');
                let res;
                if (userId) {
                    // Prefer server-side registration using stored token (avoids stale local token)
                    res = await fetch(`${API_CONFIG.backend}/api/garmin/admin/register-user`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId })
                    });
                } else {
                    const token = localStorage.getItem('garmin_token');
                    if (!token) {
                        showMessage('No Garmin token found. Please connect Garmin first.', 'warning');
                        if (status) status.textContent = 'No Garmin token found';
                        return;
                    }
                    res = await fetch(`${API_CONFIG.backend}/api/garmin/v2/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                }
                const text = await res.text();
                if (status) status.textContent = res.ok ? 'Registration OK (or already registered)' : `Registration failed: ${text}`;
                showMessage(res.ok ? 'Garmin registered for PUSH' : 'Garmin registration failed', res.ok ? 'success' : 'error');
            } catch (e) {
                const status = document.getElementById('garminActionStatus');
                if (status) status.textContent = `Registration error: ${e.message}`;
                showMessage(`Garmin registration error: ${e.message}`, 'error');
            }
        }

        async function backfillGarmin(days = 30) {
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    showMessage('No userId found', 'error');
                    return;
                }
                const status = document.getElementById('garminActionStatus');
                if (status) status.textContent = `Starting backfill for ${days} day(s)...`;
                const now = new Date();
                const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000).toISOString();
                const res = await fetch(`${API_CONFIG.backend}/api/garmin/backfill`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, startDate })
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    if (status) status.textContent = `Backfill failed: ${data.message || res.statusText}`;
                    showMessage(`Backfill failed: ${data.message || res.statusText}`, 'error');
                    return;
                }
                if (status) status.textContent = `Backfill accepted: syncing ${data.daysToSync || days} day(s). Refreshing shortly...`;
                showMessage('Backfill started. Data will appear shortly.', 'info');
                setTimeout(updateGarminDisplay, 4000);
            } catch (e) {
                const status = document.getElementById('garminActionStatus');
                if (status) status.textContent = `Backfill error: ${e.message}`;
                showMessage(`Backfill error: ${e.message}`, 'error');
            }
        }

        // ---- Provider refresh helpers ----
        async function refreshStravaNow() {
            try {
                const status = document.getElementById('stravaActionStatus');
                if (status) status.textContent = 'Refreshing Strava...';
                const token = localStorage.getItem('strava_token');
                if (!token) { if (status) status.textContent = 'No Strava token found'; return; }
                await fetchStravaData(token);
                if (status) status.textContent = 'Strava refreshed';
            } catch (e) {
                const status = document.getElementById('stravaActionStatus');
                if (status) status.textContent = `Refresh error: ${e.message}`;
            }
        }

        async function refreshOuraNow() {
            try {
                const status = document.getElementById('ouraActionStatus');
                if (status) status.textContent = 'Refreshing Oura...';
                const token = localStorage.getItem('oura_token');
                if (!token) {
                    if (status) status.textContent = 'No Oura token found';
                    const rc = document.querySelector('.btn-oura-reconnect');
                    if (rc) rc.style.display = 'inline-block';
                    return;
                }
                await fetchOuraData(token);
                if (status) status.textContent = 'Oura refreshed';
            } catch (e) {
                const status = document.getElementById('ouraActionStatus');
                if (status) status.textContent = `Refresh error: ${e.message}`;
                const rc = document.querySelector('.btn-oura-reconnect');
                if (rc) rc.style.display = 'inline-block';
            }
        }

        async function refreshWhoopNow() {
            try {
                const status = document.getElementById('whoopActionStatus');
                if (status) status.textContent = 'Refreshing Whoop...';
                const token = localStorage.getItem('whoop_token');
                if (!token) { if (status) status.textContent = 'No Whoop token found'; return; }
                await fetchWhoopData(token);
                if (status) status.textContent = 'Whoop refreshed';
            } catch (e) {
                const status = document.getElementById('whoopActionStatus');
                if (status) status.textContent = `Refresh error: ${e.message}`;
            }
        }

        // Simple UUID v4 generator
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Set correlation window selector and re-generate insights on change
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize userId if it doesn't exist
            if (!localStorage.getItem('userId')) {
                const userId = uuidv4();
                localStorage.setItem('userId', userId);
                console.log('Generated new userId:', userId);
            } else {
                const currentUserId = localStorage.getItem('userId');
                console.log('Existing userId found:', currentUserId);

                // Smart recovery: If user has no data, check if they have OAuth tokens under a different userId
                try {
                    const statusResponse = await fetch(`${API_CONFIG.backend}/api/sync/status/${currentUserId}`);
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();

                        // If this userId has no activities AND no tokens, check if there's data elsewhere
                        if (statusData.totalActivities === 0 && statusData.totalZoneRecords === 0) {
                            console.log('No data found for current userId, checking for OAuth tokens...');

                            const usersResponse = await fetch(`${API_CONFIG.backend}/api/sync/users`);
                            if (usersResponse.ok) {
                                const usersData = await usersResponse.json();

                                // Find a userId that has data (not the current one)
                                for (const user of usersData.users) {
                                    if (user.userId !== currentUserId) {
                                        const altStatusResponse = await fetch(`${API_CONFIG.backend}/api/sync/status/${user.userId}`);
                                        if (altStatusResponse.ok) {
                                            const altStatusData = await altStatusResponse.json();
                                            if (altStatusData.totalActivities > 0 || altStatusData.totalZoneRecords > 0) {
                                                console.log(`Found data under different userId: ${user.userId} (${altStatusData.totalActivities} activities)`);
                                                localStorage.setItem('userId', user.userId);
                                                location.reload();
                                                return;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking for data recovery:', error);
                }
            }

            // Initialize tab event listeners
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        switchTab(tabName, this);
                    }
                });
            });

            // Initialize tab scroll indicators
            const tabNav = document.getElementById('tabNav');
            if (tabNav) {
                tabNav.addEventListener('scroll', updateTabScrollIndicators);
                window.addEventListener('resize', updateTabScrollIndicators);
                // Initial check
                setTimeout(updateTabScrollIndicators, 100);
            }

            const sel = document.getElementById('correlationWindow');
            if (sel) {
                sel.value = String(getInsightWindowDays());
                sel.addEventListener('change', (e) => {
                    const v = parseInt(e.target.value, 10);
                    localStorage.setItem('insight_window_days', String(v));
                    generateAIInsights();
                });
            }

            // Set up insight category filter
            const insightCategoryFilter = document.getElementById('insightCategoryFilter');
            if (insightCategoryFilter) {
                insightCategoryFilter.addEventListener('change', () => {
                    renderFilteredInsights();
                });
            }

            // Load dashboard data on page load
            loadDashboardData();

            // Contact form handler
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const statusDiv = document.getElementById('contactFormStatus');
                    const submitButton = contactForm.querySelector('button[type="submit"]');

                    // Get form data
                    const formData = {
                        name: document.getElementById('contactName').value.trim(),
                        email: document.getElementById('contactEmail').value.trim(),
                        subject: document.getElementById('contactSubject').value.trim(),
                        message: document.getElementById('contactMessage').value.trim()
                    };

                    // Disable submit button
                    submitButton.disabled = true;
                    submitButton.textContent = 'Sending...';

                    try {
                        const response = await fetch('/api/contact', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            // Success
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
                            statusDiv.style.border = '1px solid rgba(16, 185, 129, 0.4)';
                            statusDiv.style.color = 'rgba(255, 255, 255, 0.95)';
                            statusDiv.textContent = data.message;

                            // Clear form
                            contactForm.reset();
                        } else {
                            // Error
                            throw new Error(data.message || 'Failed to send message');
                        }
                    } catch (error) {
                        console.error('Contact form error:', error);
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = 'rgba(220, 38, 38, 0.2)';
                        statusDiv.style.border = '1px solid rgba(220, 38, 38, 0.4)';
                        statusDiv.style.color = 'rgba(255, 255, 255, 0.95)';
                        statusDiv.textContent = error.message || 'Failed to send message. Please try again or email us directly at info@athlytx.com';
                    } finally {
                        // Re-enable submit button
                        submitButton.disabled = false;
                        submitButton.textContent = 'Send Message';

                        // Hide status after 5 seconds
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 5000);
                    }
                });
            }
        });
    </script>

    <!-- OAuth Integration Scripts -->
    <script src="garmin-oauth2.js"></script>
    <script src="whoop-oauth2.js"></script>
    <script src="oauth-handler.js"></script>
    <script src="auth-handler.js"></script>
    <script src="micro-interactions.js"></script>

        </div> <!-- End main-content -->
    </div> <!-- End app-layout -->

</body>
</html>
