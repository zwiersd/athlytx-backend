<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Onboarding | Athlytx Elite</title>
    <link rel="stylesheet" href="/styles/design-tokens.css">
    <link rel="stylesheet" href="/styles/layout.css">
    <link rel="stylesheet" href="/styles/components.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-base) 0%, #1e2659 30%, #2c1810 70%, #0f0a1a 100%);
            min-height: 100vh;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--gradient-mesh);
            pointer-events: none;
            opacity: 0.6;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Logo */
        .logo {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        /* Progress Indicator */
        .progress-container {
            margin-bottom: 48px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 16px;
        }

        .progress-line {
            position: absolute;
            top: 16px;
            left: 5%;
            right: 5%;
            height: 2px;
            background: var(--glass-3);
            z-index: 0;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dark));
            width: 0%;
            transition: width 0.5s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--glass-2);
            border: 2px solid var(--border-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-tertiary);
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .step.completed .step-circle {
            background: var(--status-fresh);
            border-color: transparent;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-align: center;
            max-width: 80px;
        }

        .step.active .step-label {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Card */
        .card {
            background: var(--glass-2);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-2);
            border-radius: 24px;
            padding: 48px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            min-height: 420px;
            display: flex;
            flex-direction: column;
        }

        .step-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .step-content.active {
            display: flex;
        }

        .step-content h2 {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 12px 0;
        }

        .step-content p {
            color: var(--text-secondary);
            font-size: 15px;
            line-height: 1.6;
            margin: 0 0 32px 0;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--glass-3);
            border: 1px solid var(--border-1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--border-focus);
            background: var(--glass-4);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        /* Device Grid */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .device-card {
            background: var(--glass-3);
            border: 1px solid var(--border-1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .device-card:hover {
            border-color: var(--border-focus);
            background: var(--glass-4);
            transform: translateY(-2px);
        }

        .device-card.connected {
            border-color: var(--status-fresh);
            background: rgba(52, 199, 89, 0.1);
        }

        .device-card .device-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .device-card .device-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .device-card .device-status {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .device-card.connected .device-status {
            color: var(--status-fresh);
            font-weight: 600;
        }

        .device-card .connected-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--status-fresh);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            display: none;
        }

        .device-card.connected .connected-badge {
            display: block;
        }

        .devices-status {
            background: var(--glass-3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: center;
        }

        .devices-status .status-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .devices-status .status-count {
            color: var(--status-fresh);
            font-weight: 700;
            font-size: 18px;
            margin-top: 4px;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin: 24px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
        }

        .checkbox-group label {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            cursor: pointer;
        }

        .checkbox-group label a {
            color: var(--color-primary-light);
            text-decoration: none;
        }

        .checkbox-group label a:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: auto;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--glass-3);
            color: var(--text-primary);
            border: 1px solid var(--border-2);
        }

        .btn-secondary:hover {
            background: var(--glass-4);
            border-color: var(--border-3);
        }

        /* Mobile */
        @media (max-width: 768px) {
            .card {
                padding: 32px 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .devices-grid {
                grid-template-columns: 1fr;
            }

            .step-label {
                font-size: 10px;
                max-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Logo -->
        <div class="logo">
            <h1>Athlytx Elite</h1>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressFill"></div>
                </div>

                <div class="step active" data-step="1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Welcome</div>
                </div>

                <div class="step" data-step="2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Your Details</div>
                </div>

                <div class="step" data-step="3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Terms</div>
                </div>

                <div class="step" data-step="4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Connect Devices</div>
                </div>
            </div>
        </div>

        <!-- Card with Steps -->
        <div class="card">
            <!-- Step 1: Welcome -->
            <div class="step-content active" id="step1">
                <h2>Welcome to Athlytx! üéâ</h2>
                <p id="welcomeMessage">Let's get you set up in just a few quick steps. We'll collect some basic information and connect your fitness devices so you can start tracking your performance.</p>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="nextStep()">Get Started</button>
                </div>
            </div>

            <!-- Step 2: Personal Details -->
            <div class="step-content" id="step2">
                <h2>Tell Us About Yourself</h2>
                <p>We need a few details to personalize your training experience.</p>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstName">First Name *</label>
                        <input type="text" id="firstName" required>
                    </div>

                    <div class="form-group">
                        <label for="lastName">Last Name *</label>
                        <input type="text" id="lastName" required>
                    </div>

                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth *</label>
                        <input type="date" id="dateOfBirth" required>
                    </div>

                    <div class="form-group">
                        <label for="sport">Primary Sport *</label>
                        <select id="sport" required>
                            <option value="">Select your sport</option>
                            <option value="Running">Running</option>
                            <option value="Cycling">Cycling</option>
                            <option value="Triathlon">Triathlon</option>
                            <option value="Swimming">Swimming</option>
                            <option value="CrossFit">CrossFit</option>
                            <option value="Weightlifting">Weightlifting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="timezone">Timezone *</label>
                        <select id="timezone" required>
                            <option value="">Select your timezone</option>
                            <option value="America/New_York">Eastern Time (ET)</option>
                            <option value="America/Chicago">Central Time (CT)</option>
                            <option value="America/Denver">Mountain Time (MT)</option>
                            <option value="America/Los_Angeles">Pacific Time (PT)</option>
                            <option value="America/Phoenix">Arizona Time (MST)</option>
                            <option value="America/Anchorage">Alaska Time (AKT)</option>
                            <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                            <option value="Europe/London">London (GMT)</option>
                            <option value="Europe/Paris">Paris (CET)</option>
                            <option value="Europe/Berlin">Berlin (CET)</option>
                            <option value="Asia/Tokyo">Tokyo (JST)</option>
                            <option value="Australia/Sydney">Sydney (AEDT)</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn btn-primary" onclick="nextStep()">Continue</button>
                </div>
            </div>

            <!-- Step 3: Terms & Conditions -->
            <div class="step-content" id="step3">
                <h2>Terms & Conditions</h2>
                <p>Please review and accept our terms to continue.</p>

                <div style="background: var(--glass-3); border-radius: 12px; padding: 20px; margin-bottom: 24px; max-height: 200px; overflow-y: auto;">
                    <h3 style="color: var(--text-primary); font-size: 16px; margin: 0 0 12px 0;">Data Privacy</h3>
                    <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6; margin: 0;">
                        By using Athlytx, you agree to allow us to collect and analyze your fitness data from connected devices. We will never sell your data to third parties. Your data is encrypted and stored securely.
                    </p>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="acceptTerms">
                    <label for="acceptTerms">
                        I agree to the <a href="terms.html" target="_blank">Terms of Service</a> and <a href="privacy.html" target="_blank">Privacy Policy</a>
                    </label>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn btn-primary" id="acceptBtn" onclick="nextStep()" disabled>Accept & Continue</button>
                </div>
            </div>

            <!-- Step 4: Connect Devices -->
            <div class="step-content" id="step4">
                <h2>Connect Your Devices</h2>
                <p>Connect at least one fitness device to start tracking your performance. You can add more later.</p>

                <div class="devices-status">
                    <div class="status-text">Connected Devices</div>
                    <div class="status-count" id="connectedCount">0 / 4</div>
                </div>

                <div class="devices-grid">
                    <div class="device-card" data-provider="garmin" onclick="connectDevice('garmin')">
                        <div class="connected-badge">‚úì Connected</div>
                        <div class="device-icon">‚åö</div>
                        <div class="device-name">Garmin</div>
                        <div class="device-status">Click to connect</div>
                    </div>

                    <div class="device-card" data-provider="strava" onclick="connectDevice('strava')">
                        <div class="connected-badge">‚úì Connected</div>
                        <div class="device-icon">üö¥</div>
                        <div class="device-name">Strava</div>
                        <div class="device-status">Click to connect</div>
                    </div>

                    <div class="device-card" data-provider="whoop" onclick="connectDevice('whoop')">
                        <div class="connected-badge">‚úì Connected</div>
                        <div class="device-icon">üí™</div>
                        <div class="device-name">Whoop</div>
                        <div class="device-status">Click to connect</div>
                    </div>

                    <div class="device-card" data-provider="oura" onclick="connectDevice('oura')">
                        <div class="connected-badge">‚úì Connected</div>
                        <div class="device-icon">üíç</div>
                        <div class="device-name">Oura</div>
                        <div class="device-status">Click to connect</div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn btn-primary" id="completeBtn" onclick="completeOnboarding()" disabled>Complete Setup</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000'
            : window.location.origin;

        let currentStep = 1;
        let connectedDevices = new Set();
        let session = null;
        let inviteToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Get session
            const sessionData = localStorage.getItem('athlytx_session');
            if (!sessionData) {
                window.location.href = '/athlete';
                return;
            }

            session = JSON.parse(sessionData);

            // Check for invitation token
            const urlParams = new URLSearchParams(window.location.search);
            inviteToken = urlParams.get('invite');

            // Update welcome message if invited
            if (inviteToken) {
                fetchInvitationDetails();
            }

            // Set up terms checkbox listener
            document.getElementById('acceptTerms').addEventListener('change', (e) => {
                document.getElementById('acceptBtn').disabled = !e.target.checked;
            });

            // Listen for device connection messages
            window.addEventListener('message', handleDeviceCallback);

            // Check existing device connections
            checkDeviceStatus();
        });

        async function fetchInvitationDetails() {
            try {
                const response = await fetch(`${API_URL}/api/auth/invite/details?token=${inviteToken}`);
                const data = await response.json();

                if (data.success && data.coach) {
                    const welcomeMsg = document.getElementById('welcomeMessage');
                    welcomeMsg.innerHTML = `<strong>${data.coach.name || data.coach.email}</strong> has invited you to join Athlytx Elite! Let's get you set up so you can start training together.`;
                }
            } catch (error) {
                console.error('Failed to fetch invitation details:', error);
            }
        }

        async function checkDeviceStatus() {
            try {
                const response = await fetch(`${API_URL}/api/devices/status?sessionToken=${session.sessionToken}`);
                const data = await response.json();

                if (data.devices) {
                    data.devices.forEach(device => {
                        connectedDevices.add(device.provider);
                        markDeviceConnected(device.provider);
                    });
                    updateDeviceCount();
                }
            } catch (error) {
                console.error('Failed to check device status:', error);
            }
        }

        function nextStep() {
            if (currentStep === 2 && !validatePersonalDetails()) {
                return;
            }

            if (currentStep === 3 && !document.getElementById('acceptTerms').checked) {
                return;
            }

            if (currentStep < 4) {
                currentStep++;
                updateStepUI();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }

        function updateStepUI() {
            // Update step indicators
            document.querySelectorAll('.step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'completed');

                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update progress bar
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // Update step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step${currentStep}`).classList.add('active');
        }

        function validatePersonalDetails() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const dob = document.getElementById('dateOfBirth').value;
            const sport = document.getElementById('sport').value;
            const timezone = document.getElementById('timezone').value;

            if (!firstName || !lastName || !dob || !sport || !timezone) {
                alert('Please fill in all required fields');
                return false;
            }

            return true;
        }

        async function connectDevice(provider) {
            try {
                const response = await fetch(`${API_URL}/api/devices/connect/${provider}?sessionToken=${session.sessionToken}`);
                const data = await response.json();

                if (data.authUrl) {
                    // Open OAuth in popup
                    const popup = window.open(
                        data.authUrl,
                        `Connect ${provider}`,
                        'width=600,height=700,scrollbars=yes'
                    );

                    if (!popup) {
                        alert('Please allow popups to connect devices');
                    }
                }
            } catch (error) {
                console.error(`Failed to connect ${provider}:`, error);
                alert(`Failed to connect ${provider}. Please try again.`);
            }
        }

        function handleDeviceCallback(event) {
            if (event.data && event.data.type === 'device-connected') {
                const provider = event.data.provider;
                connectedDevices.add(provider);
                markDeviceConnected(provider);
                updateDeviceCount();
            }
        }

        function markDeviceConnected(provider) {
            const card = document.querySelector(`.device-card[data-provider="${provider}"]`);
            if (card) {
                card.classList.add('connected');
                card.querySelector('.device-status').textContent = 'Connected';
            }
        }

        function updateDeviceCount() {
            const count = connectedDevices.size;
            document.getElementById('connectedCount').textContent = `${count} / 4`;
            document.getElementById('completeBtn').disabled = count === 0;
        }

        async function completeOnboarding() {
            if (connectedDevices.size === 0) {
                alert('Please connect at least one device to continue');
                return;
            }

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const dob = document.getElementById('dateOfBirth').value;
            const sport = document.getElementById('sport').value;
            const timezone = document.getElementById('timezone').value;

            const completeBtn = document.getElementById('completeBtn');
            completeBtn.disabled = true;
            completeBtn.textContent = 'Completing...';

            try {
                const response = await fetch(`${API_URL}/api/auth/onboarding/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionToken: session.sessionToken,
                        name: `${firstName} ${lastName}`,
                        dateOfBirth: dob,
                        sport,
                        timezone
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update session
                    session.user.name = data.user.name;
                    session.user.onboarded = true;
                    localStorage.setItem('athlytx_session', JSON.stringify(session));

                    // If there's an invite token, accept it
                    if (inviteToken) {
                        await acceptInvitation();
                    }

                    // Redirect to dashboard using absolute path
                    window.location.href = '/athlete/dashboard';
                } else {
                    throw new Error(data.error || 'Failed to complete onboarding');
                }
            } catch (error) {
                console.error('Onboarding error:', error);
                alert('Failed to complete onboarding. Please try again.');
                completeBtn.disabled = false;
                completeBtn.textContent = 'Complete Setup';
            }
        }

        async function acceptInvitation() {
            try {
                await fetch(`${API_URL}/api/auth/accept-invite`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: inviteToken,
                        sessionToken: session.sessionToken
                    })
                });
            } catch (error) {
                console.error('Failed to accept invitation:', error);
            }
        }
    </script>
</body>
</html>
