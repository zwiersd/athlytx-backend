<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard - Athlytx</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1e3d;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .header-info {
            text-align: right;
            color: #666;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-weight: 600;
            color: #333;
        }

        .controls select,
        .controls input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .controls select:focus,
        .controls input:focus {
            border-color: #667eea;
        }

        .controls button {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .controls button:hover {
            background: #5568d3;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .zone-bars {
            margin-top: 20px;
        }

        .zone-bar {
            margin-bottom: 15px;
        }

        .zone-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .zone-progress {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .zone-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .zone1 { background: #4CAF50; }
        .zone2 { background: #8BC34A; }
        .zone3 { background: #FFC107; }
        .zone4 { background: #FF9800; }
        .zone5 { background: #F44336; }

        .activities-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }

        .activities-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            border-bottom: 2px solid #e0e0e0;
        }

        .activities-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .activities-table tr:hover {
            background: #f8f9fa;
        }

        .activity-type {
            font-weight: 600;
            color: #667eea;
        }

        .zone-mini {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 3px;
        }

        .provider-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .provider-strava {
            background: transparent;
            padding: 2px 4px;
        }

        .provider-garmin {
            background: transparent;
            padding: 2px 4px;
        }

        .provider-oura {
            background: transparent;
            padding: 2px 4px;
        }

        .provider-whoop {
            background: transparent;
            padding: 2px 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        canvas {
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Coach Dashboard</h1>
                <p style="color: #666; margin-top: 5px;">Heart Rate Zone Analysis</p>
            </div>
            <div class="header-info">
                <div id="athleteName" style="font-size: 18px; font-weight: 600; color: #667eea;">Athlete</div>
                <div id="lastSync" style="font-size: 12px; margin-top: 3px;">Last sync: --</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <label for="periodSelect">Period:</label>
                <select id="periodSelect">
                    <option value="7">Last 7 days</option>
                    <option value="14" selected>Last 14 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="60">Last 60 days</option>
                </select>
            </div>
            <button id="refreshBtn">Refresh Data</button>
            <button id="syncBtn">Sync Now</button>
            <button id="exportBtn">Export CSV</button>
        </div>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading dashboard...</div>

        <div id="dashboardContent" style="display: none;">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>Training Summary</h2>
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-value" id="totalActivities">0</div>
                            <div class="stat-label">Activities</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="totalMinutes">0</div>
                            <div class="stat-label">Total Minutes</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="avgHr">0</div>
                            <div class="stat-label">Avg HR</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="maxHr">0</div>
                            <div class="stat-label">Max HR</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Data Sources</div>
                        <div id="dataSources" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <!-- Data sources populated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="card" style="grid-column: span 2;">
                    <h2>Heart Rate Zone Distribution</h2>
                    <div class="zone-bars">
                        <div class="zone-bar">
                            <div class="zone-label">
                                <span>Zone 1 - Recovery (0-121 bpm)</span>
                                <span id="zone1Percent">0%</span>
                            </div>
                            <div class="zone-progress">
                                <div class="zone-fill zone1" id="zone1Bar" style="width: 0%">
                                    <span id="zone1Minutes">0 min</span>
                                </div>
                            </div>
                        </div>
                        <div class="zone-bar">
                            <div class="zone-label">
                                <span>Zone 2 - Endurance (122-151 bpm)</span>
                                <span id="zone2Percent">0%</span>
                            </div>
                            <div class="zone-progress">
                                <div class="zone-fill zone2" id="zone2Bar" style="width: 0%">
                                    <span id="zone2Minutes">0 min</span>
                                </div>
                            </div>
                        </div>
                        <div class="zone-bar">
                            <div class="zone-label">
                                <span>Zone 3 - Tempo (152-166 bpm)</span>
                                <span id="zone3Percent">0%</span>
                            </div>
                            <div class="zone-progress">
                                <div class="zone-fill zone3" id="zone3Bar" style="width: 0%">
                                    <span id="zone3Minutes">0 min</span>
                                </div>
                            </div>
                        </div>
                        <div class="zone-bar">
                            <div class="zone-label">
                                <span>Zone 4 - Threshold (167-180 bpm)</span>
                                <span id="zone4Percent">0%</span>
                            </div>
                            <div class="zone-progress">
                                <div class="zone-fill zone4" id="zone4Bar" style="width: 0%">
                                    <span id="zone4Minutes">0 min</span>
                                </div>
                            </div>
                        </div>
                        <div class="zone-bar">
                            <div class="zone-label">
                                <span>Zone 5 - Anaerobic (181+ bpm)</span>
                                <span id="zone5Percent">0%</span>
                            </div>
                            <div class="zone-progress">
                                <div class="zone-fill zone5" id="zone5Bar" style="width: 0%">
                                    <span id="zone5Minutes">0 min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <h2>Training Volume Over Time</h2>
                <canvas id="volumeChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="card">
                <h2>Weekly Training Load</h2>
                <canvas id="loadChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="card">
                <h2>Activity Type Breakdown</h2>
                <canvas id="activityTypeChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="card">
                <h2>Recent Activities</h2>
                <table class="activities-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Activity</th>
                            <th>Source</th>
                            <th>Device</th>
                            <th>Duration</th>
                            <th>Avg HR</th>
                            <th>Max HR</th>
                            <th>Primary Zone</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #999;">Loading activities...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer with Data Attribution -->
        <footer style="background: transparent; border-radius: 12px; padding: 25px; margin-top: 20px; text-align: center;">
            <div style="font-size: 12px; color: #666; margin-bottom: 15px;">Powered by Garmin, Strava, Whoop, and Oura</div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 25px; flex-wrap: wrap;">
                <img src="src/images/GarminConnect.png" alt="Garmin Connect" style="height: 40px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <span style="color: #ddd;">|</span>
                <img src="src/images/strava.svg" alt="Strava" style="height: 35px; object-fit: contain;">
                <span style="color: #ddd;">|</span>
                <img src="src/images/whoop-logo.jpeg" alt="Whoop" style="height: 35px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <span style="color: #ddd;">|</span>
                <img src="src/images/oura-logo.jpeg" alt="Oura" style="height: 35px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            </div>
        </footer>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api';

        // Get user ID from localStorage (set by index.html when OAuth completes)
        const USER_ID = localStorage.getItem('userId') || '3a2d6b17-6cd2-45e0-9487-e54d8c4d3e22'; // fallback to old default

        let currentPeriod = 14;
        let zoneData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸ“Š Loading dashboard for user:', USER_ID);
            loadDashboard();

            document.getElementById('periodSelect').addEventListener('change', (e) => {
                currentPeriod = parseInt(e.target.value);
                loadDashboard();
            });

            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadDashboard();
            });

            document.getElementById('syncBtn').addEventListener('click', () => {
                syncData();
            });

            document.getElementById('exportBtn').addEventListener('click', () => {
                exportToCSV();
            });
        });

        async function loadDashboard() {
            showLoading();
            hideError();

            try {
                // Load status and zone data in parallel
                const [status, zones] = await Promise.all([
                    fetch(`${API_BASE}/sync/status/${USER_ID}`).then(r => r.json()),
                    fetch(`${API_BASE}/sync/zones/${USER_ID}?days=${currentPeriod}`).then(r => r.json())
                ]);

                zoneData = zones;

                // Update header
                document.getElementById('athleteName').textContent = 'Athlytx Athlete';
                if (status.lastSync) {
                    const lastSync = new Date(status.lastSync);
                    document.getElementById('lastSync').textContent = `Last sync: ${lastSync.toLocaleString()}`;
                }

                // Calculate summary stats
                updateSummaryStats(zones.data || []);

                // Update data sources
                updateDataSources(zones.data || []);

                // Update zone distribution
                if (status.weeklySummary) {
                    updateZoneDistribution(status.weeklySummary);
                }

                // Update activities table
                updateActivitiesTable(zones.data || []);

                // Create charts
                createCharts(zones);

                showDashboard();
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('Failed to load dashboard: ' + error.message);
            }
        }

        function updateSummaryStats(activities) {
            // Filter out invalid activities (negative duration, missing data, or very long duration)
            // ALSO exclude Whoop activities from summary stats (skewed data)
            const validActivities = activities.filter(act =>
                act.durationMinutes > 0 &&
                act.durationMinutes < 500 && // Less than 8 hours
                act.activityType &&
                act.provider !== 'whoop' // Exclude Whoop from summaries
            );

            // Remove duplicates by grouping by date+activityType+duration
            const uniqueActivities = {};
            validActivities.forEach(act => {
                const key = `${act.date}_${act.activityType}_${act.durationMinutes}`;
                if (!uniqueActivities[key]) {
                    uniqueActivities[key] = act;
                }
            });

            const unique = Object.values(uniqueActivities);

            document.getElementById('totalActivities').textContent = unique.length;

            const totalMinutes = unique.reduce((sum, act) => sum + act.durationMinutes, 0);
            document.getElementById('totalMinutes').textContent = totalMinutes;

            const avgHr = Math.round(
                unique.reduce((sum, act) => sum + (act.hr.avg || 0), 0) / unique.length
            );
            document.getElementById('avgHr').textContent = avgHr || '--';

            const maxHr = Math.max(...unique.map(act => act.hr.max || 0));
            document.getElementById('maxHr').textContent = maxHr || '--';
        }

        function updateDataSources(activities) {
            // Get unique providers from activities
            const providers = new Set();
            activities.forEach(act => {
                if (act.provider) {
                    providers.add(act.provider);
                }
            });

            const container = document.getElementById('dataSources');
            if (providers.size === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 12px;">No data sources</span>';
                return;
            }

            container.innerHTML = Array.from(providers).sort().map(provider => {
                const providerLower = provider.toLowerCase();
                let displayContent;

                if (providerLower === 'garmin') {
                    displayContent = `<img src="/src/images/Garmin.svg" alt="Garmin" style="height: 24px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'strava') {
                    displayContent = `<img src="/src/images/strava.svg" alt="Strava" style="height: 18px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'whoop') {
                    displayContent = `<img src="/src/images/WHOOP.svg" alt="Whoop" style="height: 18px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'oura') {
                    displayContent = `<img src="/src/images/oura.png" alt="Oura" style="height: 18px; width: auto; vertical-align: middle;">`;
                } else {
                    displayContent = provider;
                }

                return `<span class="provider-badge provider-${provider}">${displayContent}</span>`;
            }).join('');
        }

        function updateZoneDistribution(summary) {
            const zones = [
                { num: 1, minutes: summary.totalZone1Minutes, percent: summary.zone1Percent },
                { num: 2, minutes: summary.totalZone2Minutes, percent: summary.zone2Percent },
                { num: 3, minutes: summary.totalZone3Minutes, percent: summary.zone3Percent },
                { num: 4, minutes: summary.totalZone4Minutes, percent: summary.zone4Percent },
                { num: 5, minutes: summary.totalZone5Minutes, percent: summary.zone5Percent }
            ];

            zones.forEach(zone => {
                const percent = parseFloat(zone.percent) || 0;
                const minutes = zone.minutes !== undefined && zone.minutes !== null ? zone.minutes : 0;
                document.getElementById(`zone${zone.num}Percent`).textContent = `${percent}%`;
                document.getElementById(`zone${zone.num}Bar`).style.width = `${percent}%`;
                document.getElementById(`zone${zone.num}Minutes`).textContent = `${minutes} min`;
            });
        }

        function updateActivitiesTable(activities) {
            const tbody = document.getElementById('activitiesTableBody');

            // Filter out invalid activities BUT keep Whoop (even with bad duration)
            const validActivities = activities.filter(act => {
                // Always include Whoop activities
                if (act.provider === 'whoop' && act.activityType) {
                    return true;
                }
                // For others, require valid duration
                return act.durationMinutes > 0 &&
                    act.durationMinutes < 500 && // Less than 8 hours
                    act.activityType;
            });

            // Remove duplicates and take most recent 20
            const uniqueActivities = {};
            validActivities.forEach(act => {
                const key = `${act.date}_${act.activityType}_${act.durationMinutes}_${act.provider || 'unknown'}`;
                if (!uniqueActivities[key]) {
                    uniqueActivities[key] = act;
                }
            });

            const unique = Object.values(uniqueActivities).slice(0, 20);

            if (unique.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">No activities found</td></tr>';
                return;
            }

            tbody.innerHTML = unique.map(act => {
                const primaryZone = getPrimaryZone(act.zones);
                const provider = act.provider || 'unknown';
                const providerLower = provider.toLowerCase();

                let providerDisplay;
                if (providerLower === 'garmin') {
                    providerDisplay = `<img src="/src/images/Garmin.svg" alt="Garmin" style="height: 18px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'strava') {
                    providerDisplay = `<img src="/src/images/strava.svg" alt="Strava" style="height: 12px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'whoop') {
                    providerDisplay = `<img src="/src/images/WHOOP.svg" alt="Whoop" style="height: 14px; width: auto; vertical-align: middle;">`;
                } else if (providerLower === 'oura') {
                    providerDisplay = `<img src="/src/images/oura.png" alt="Oura" style="height: 14px; width: auto; vertical-align: middle;">`;
                } else {
                    providerDisplay = provider;
                }

                // Display device model if available (Garmin only for now)
                const deviceDisplay = act.deviceModel || '--';

                // For Whoop, show "Recorded" instead of invalid duration
                let duration;
                if (providerLower === 'whoop' && (act.durationMinutes < 0 || act.durationMinutes > 500)) {
                    duration = 'Recorded';
                } else {
                    duration = act.durationMinutes !== undefined && act.durationMinutes !== null ? `${act.durationMinutes} min` : '--';
                }

                return `
                    <tr>
                        <td>${act.date}</td>
                        <td class="activity-type">${act.activityType}</td>
                        <td><span class="provider-badge provider-${provider}">${providerDisplay}</span></td>
                        <td>${deviceDisplay}</td>
                        <td>${duration}</td>
                        <td>${act.hr.avg || '--'} bpm</td>
                        <td>${act.hr.max || '--'} bpm</td>
                        <td>
                            <span class="zone-mini zone${primaryZone}"></span>
                            Zone ${primaryZone}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getPrimaryZone(zones) {
            const zoneMinutes = [
                zones.zone1,
                zones.zone2,
                zones.zone3,
                zones.zone4,
                zones.zone5
            ];
            const maxMinutes = Math.max(...zoneMinutes);
            return zoneMinutes.indexOf(maxMinutes) + 1;
        }

        // Chart instances
        let volumeChart = null;
        let loadChart = null;
        let activityTypeChart = null;

        function createCharts(data) {
            const activities = data.data || [];

            // Filter out invalid activities and exclude Whoop (skewed data)
            const validActivities = activities.filter(act =>
                act.durationMinutes > 0 &&
                act.durationMinutes < 500 && // Less than 8 hours
                act.activityType &&
                act.provider !== 'whoop' // Exclude Whoop from charts
            );

            // Remove duplicates
            const uniqueActivities = {};
            validActivities.forEach(act => {
                const key = `${act.date}_${act.activityType}_${act.durationMinutes}`;
                if (!uniqueActivities[key]) {
                    uniqueActivities[key] = act;
                }
            });
            const unique = Object.values(uniqueActivities);

            // Group by date for volume chart
            const volumeByDate = {};
            unique.forEach(act => {
                if (!volumeByDate[act.date]) {
                    volumeByDate[act.date] = 0;
                }
                volumeByDate[act.date] += act.durationMinutes;
            });

            const dates = Object.keys(volumeByDate).sort();
            const volumes = dates.map(d => volumeByDate[d]);

            // Destroy existing charts
            if (volumeChart) volumeChart.destroy();
            if (loadChart) loadChart.destroy();
            if (activityTypeChart) activityTypeChart.destroy();

            // Training Volume Over Time
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Training Minutes',
                        data: volumes,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutes'
                            }
                        }
                    }
                }
            });

            // Weekly Training Load (last 4 weeks)
            const weeklyLoad = {};
            unique.forEach(act => {
                const date = new Date(act.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay());
                const weekKey = weekStart.toISOString().split('T')[0];

                if (!weeklyLoad[weekKey]) {
                    weeklyLoad[weekKey] = { minutes: 0, activities: 0 };
                }
                weeklyLoad[weekKey].minutes += act.durationMinutes;
                weeklyLoad[weekKey].activities += 1;
            });

            const weeks = Object.keys(weeklyLoad).sort().slice(-4);
            const weekMinutes = weeks.map(w => weeklyLoad[w].minutes);

            const loadCtx = document.getElementById('loadChart').getContext('2d');
            loadChart = new Chart(loadCtx, {
                type: 'line',
                data: {
                    labels: weeks.map(w => `Week of ${w}`),
                    datasets: [{
                        label: 'Weekly Minutes',
                        data: weekMinutes,
                        backgroundColor: 'rgba(52, 211, 153, 0.2)',
                        borderColor: 'rgba(52, 211, 153, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Minutes'
                            }
                        }
                    }
                }
            });

            // Activity Type Breakdown
            const activityTypes = {};
            unique.forEach(act => {
                if (!activityTypes[act.activityType]) {
                    activityTypes[act.activityType] = 0;
                }
                activityTypes[act.activityType] += act.durationMinutes;
            });

            const typeLabels = Object.keys(activityTypes);
            const typeMinutes = Object.values(activityTypes);
            const colors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)'
            ];

            const activityTypeCtx = document.getElementById('activityTypeChart').getContext('2d');
            activityTypeChart = new Chart(activityTypeCtx, {
                type: 'doughnut',
                data: {
                    labels: typeLabels,
                    datasets: [{
                        data: typeMinutes,
                        backgroundColor: colors.slice(0, typeLabels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function syncData() {
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            btn.textContent = 'Syncing...';

            try {
                const response = await fetch(`${API_BASE}/sync/manual`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: USER_ID,
                        daysBack: currentPeriod
                    })
                });

                if (!response.ok) {
                    throw new Error('Sync failed');
                }

                const result = await response.json();
                console.log('Sync result:', result);

                // Reload dashboard
                await loadDashboard();
            } catch (error) {
                console.error('Sync error:', error);
                showError('Failed to sync data: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sync Now';
            }
        }

        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function hideError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function exportToCSV() {
            if (!zoneData || !zoneData.data || zoneData.data.length === 0) {
                showError('No data to export');
                return;
            }

            // Remove duplicates
            const uniqueActivities = {};
            zoneData.data.forEach(act => {
                const key = `${act.date}_${act.activityType}_${act.durationMinutes}_${act.provider}`;
                if (!uniqueActivities[key]) {
                    uniqueActivities[key] = act;
                }
            });

            const activities = Object.values(uniqueActivities);

            // CSV headers
            const headers = [
                'Date',
                'Activity Type',
                'Source',
                'Duration (min)',
                'Avg HR (bpm)',
                'Max HR (bpm)',
                'Zone 1 (min)',
                'Zone 2 (min)',
                'Zone 3 (min)',
                'Zone 4 (min)',
                'Zone 5 (min)',
                'Primary Zone'
            ];

            // Convert activities to CSV rows
            const rows = activities.map(act => {
                const primaryZone = getPrimaryZone(act.zones);
                return [
                    act.date,
                    act.activityType,
                    act.provider || 'unknown',
                    act.durationMinutes,
                    act.hr.avg || '',
                    act.hr.max || '',
                    act.zones.zone1,
                    act.zones.zone2,
                    act.zones.zone3,
                    act.zones.zone4,
                    act.zones.zone5,
                    `Zone ${primaryZone}`
                ].join(',');
            });

            // Combine headers and rows
            const csv = [headers.join(','), ...rows].join('\n');

            // Create download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const today = new Date().toISOString().split('T')[0];
            a.download = `athlytx-training-data-${today}.csv`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
